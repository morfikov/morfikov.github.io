<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Target MARK w iptables (sumowanie oznaczeń) | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://morfikov.github.io/post/target-mark-w-iptables/">
  <meta property="og:site_name" content="Morfitronik">
  <meta property="og:title" content="Target MARK w iptables (sumowanie oznaczeń)">
  <meta property="og:description" content="Pakiety i połączenia można oznaczać w iptables za pomocą target MARK oraz CONNMARK . Ta właściwość tego filtra jest znana chyba większość użytkowników linux&#39;a. Z reguły nie interesujemy się zbytnio szczegółami oznaczania pakietów/połączeń, bo zwykle jest ono przeprowadzane prawidłowo. Niemniej jednak, są przypadki, w których markery nie będą ustawiane poprawnie. Chodzi o sytuacje, gdzie mamy do czynienia z kilkoma mechanizmami oznaczającymi pakiety. Dla przykładu weźmy sobie kształtowanie ruchu za pomocą narzędzia tc oraz failover czy load balancing łącza w oparciu o różne tablice routingu. W obu tych mechanizmach zwykle używa się markowania pakietów w iptables . Co się jednak dzieje z takim pakietem, gdy przechodzi przez reguły zarówno pierwszego jak i drugiego mechanizmu? To właśnie spróbujemy ustalić w tym wpisie.">
  <meta property="og:locale" content="pl_PL">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2016-05-18T15:17:25+00:00">
    <meta property="article:modified_time" content="2016-05-18T15:17:25+00:00">
    <meta property="article:tag" content="Iptables">

		
  <meta itemprop="name" content="Target MARK w iptables (sumowanie oznaczeń)">
  <meta itemprop="description" content="Pakiety i połączenia można oznaczać w iptables za pomocą target MARK oraz CONNMARK . Ta właściwość tego filtra jest znana chyba większość użytkowników linux&#39;a. Z reguły nie interesujemy się zbytnio szczegółami oznaczania pakietów/połączeń, bo zwykle jest ono przeprowadzane prawidłowo. Niemniej jednak, są przypadki, w których markery nie będą ustawiane poprawnie. Chodzi o sytuacje, gdzie mamy do czynienia z kilkoma mechanizmami oznaczającymi pakiety. Dla przykładu weźmy sobie kształtowanie ruchu za pomocą narzędzia tc oraz failover czy load balancing łącza w oparciu o różne tablice routingu. W obu tych mechanizmach zwykle używa się markowania pakietów w iptables . Co się jednak dzieje z takim pakietem, gdy przechodzi przez reguły zarówno pierwszego jak i drugiego mechanizmu? To właśnie spróbujemy ustalić w tym wpisie.">
  <meta itemprop="datePublished" content="2016-05-18T15:17:25+00:00">
  <meta itemprop="dateModified" content="2016-05-18T15:17:25+00:00">
  <meta itemprop="wordCount" content="1567">
  <meta itemprop="keywords" content="Iptables">
		
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Target MARK w iptables (sumowanie oznaczeń)">
  <meta name="twitter:description" content="Pakiety i połączenia można oznaczać w iptables za pomocą target MARK oraz CONNMARK . Ta właściwość tego filtra jest znana chyba większość użytkowników linux&#39;a. Z reguły nie interesujemy się zbytnio szczegółami oznaczania pakietów/połączeń, bo zwykle jest ono przeprowadzane prawidłowo. Niemniej jednak, są przypadki, w których markery nie będą ustawiane poprawnie. Chodzi o sytuacje, gdzie mamy do czynienia z kilkoma mechanizmami oznaczającymi pakiety. Dla przykładu weźmy sobie kształtowanie ruchu za pomocą narzędzia tc oraz failover czy load balancing łącza w oparciu o różne tablice routingu. W obu tych mechanizmach zwykle używa się markowania pakietów w iptables . Co się jednak dzieje z takim pakietem, gdy przechodzi przez reguły zarówno pierwszego jak i drugiego mechanizmu? To właśnie spróbujemy ustalić w tym wpisie.">

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
  


</head>
<body class="body kind-page">
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Target MARK w iptables (sumowanie oznaczeń)</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2016-05-18T15:17:25Z">Opublikowano: 18/05/2016</time>

<div class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/linux/" rel="category">Linux</a>
	</span>
</div>
	</div>
				<h1 class="entry__title">Target MARK w iptables (sumowanie oznaczeń)</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#różnica-między-target-mark-i-connmark-oraz-domyślna-maska">Różnica między target MARK i CONNMARK oraz domyślna maska</a></li>
    <li><a href="#reguły-markujące">Reguły markujące</a></li>
    <li><a href="#jak-działa---set-xmark-w-target-mark">Jak działa --set-xmark w target MARK</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Pakiety i połączenia można oznaczać w <code>iptables</code> za pomocą target <code>MARK</code> oraz <code>CONNMARK</code> . Ta
właściwość tego filtra jest znana chyba większość użytkowników linux'a. Z reguły nie interesujemy
się zbytnio szczegółami oznaczania pakietów/połączeń, bo zwykle jest ono przeprowadzane prawidłowo.
Niemniej jednak, są przypadki, w których markery nie będą ustawiane poprawnie. Chodzi o sytuacje,
gdzie mamy do czynienia z kilkoma mechanizmami oznaczającymi pakiety. Dla przykładu weźmy sobie
kształtowanie ruchu za pomocą narzędzia <code>tc</code> oraz failover czy load balancing łącza w oparciu o
różne tablice routingu. W obu tych mechanizmach zwykle używa się markowania pakietów w
<code>iptables</code> . Co się jednak dzieje z takim pakietem, gdy przechodzi przez reguły zarówno pierwszego
jak i drugiego mechanizmu? To właśnie spróbujemy ustalić w tym wpisie.</p>
<h2 id="różnica-między-target-mark-i-connmark-oraz-domyślna-maska">Różnica między target MARK i CONNMARK oraz domyślna maska</h2>
<p>We wstępie wspomniałem o oznaczaniu pojedynczych pakietów oraz całych połączeń. W <code>iptables</code>
wykorzystuje się do tych celów dwa targety: <a href="http://ipset.netfilter.org/iptables-extensions.man.html#lbDE">MARK</a> oraz <a href="http://ipset.netfilter.org/iptables-extensions.man.html#lbCS">CONNMARK</a>. Target <code>MARK</code> nakłada
oznaczenie na pojedynczy pakiet. Używa się go głównie przy dopasowaniu nowych połączeń, tj. pakietów
w stanie <code>NEW</code>. Natomiast z targetu <code>CONNMARK</code> korzysta się przy zapisywaniu i odtwarzaniu oznaczeń
w przypadku pakietów przypisanych do nawiązanego już połączenia. W ten sposób jesteśmy w stanie
odciążyć maszynę i zapobiec ciągłemu przepisywaniu oznaczeń w przypadku połączeń, które już
posiadają znacznik. Te markery są widoczne w tablicy conntrack'a pod <code>/proc/net/nf_conntrack</code> lub
<code>/proc/net/ip_conntrack</code> , w zależności od wykorzystywanego modułu do śledzenia połączeń. Poniżej
przykład takiego wpisu:</p>
<pre><code>ipv4     2 tcp      6 431994 ESTABLISHED src=192.168.1.150 dst=52.11.112.70 sport=54280 dport=443
src=52.11.112.70 dst=192.168.1.150 sport=443 dport=54280 [ASSURED] mark=2 zone=0 use=2
</code></pre>
<p>W tym przypadku, mamy połączenie między maszynami o adresach 192.168.1.150 oraz 52.11.112.70 .
Widzimy wyżej wyraźnie, że został mu przypisany marker <code>2</code> . W jaki sposób oznacza się takie
połączenia? Poniżej zostaną rozpisane dwie bazy markujące, które rzucą nam nieco światła na ten
mechanizm oznaczania pakietów i połączeń. Na sam początek stwórzmy sobie w <code>iptables</code> kilka
łańcuchów w tablicy <code>mangle</code> . Do nich będzie przekierowany ruch:</p>
<pre><code># iptables -t mangle -N base-1
# iptables -t mangle -N base-2
# iptables -t mangle -N marking-1
# iptables -t mangle -N marking-2

# iptables -t mangle -A PREROUTING -j base-1
# iptables -t mangle -A PREROUTING -j base-2
# iptables -t mangle -A POSTROUTING -j base-1
# iptables -t mangle -A POSTROUTING -j base-2
</code></pre>
<p>W zależności od przeznaczenia oznaczeń (kontrola ruchu, routing) trzeba dobrać odpowiednie łańcuchy.
Chodzi generalnie o to, że pakiety w <code>iptables</code> przechodzą przez ten filtr w pewien określony
sposób. Jest on przedstawiony na poniższej fotce (<a href="https://commons.wikimedia.org/wiki/File:Netfilter-packet-flow.svg">źródło</a>):</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/1.iptables-przeplyw-pakietow-netfilter.png" alt="iptables-przeplyw-pakietow-netfilter"    class="huge"></p>
<p>Teraz w łańcuchach <code>base-1</code> oraz <code>base-2</code> umieszczamy po bazie oznaczającej całe połączenia:</p>
<p>Pierwsza baza markująca:</p>
<pre><code># iptables -t mangle -A base-1 -j CONNMARK --restore-mark --nfmask 0x0000ff00 --ctmask 0x0000ff00
# iptables -t mangle -A base-1 -m mark ! --mark 0x00000000/0x0000ff00 -j RETURN
# iptables -t mangle -A base-1 -m mark --mark 0x00000000/0x0000ff00 -j marking-1
# iptables -t mangle -A base-1 -j CONNMARK --save-mark --nfmask 0x0000ff00 --ctmask 0x0000ff00
</code></pre>
<p>Druga baza markująca:</p>
<pre><code># iptables -t mangle -A base-2 -j CONNMARK --restore-mark --nfmask 0x000000ff --ctmask 0x000000ff
# iptables -t mangle -A base-2 -m mark ! --mark 0x00000000/0x000000ff -j RETURN
# iptables -t mangle -A base-2 -m mark --mark 0x00000000/0x000000ff -j marking-2
# iptables -t mangle -A base-2 -j CONNMARK --save-mark --nfmask 0x000000ff --ctmask 0x000000ff
</code></pre>
<p>Dla lepszego zrozumienia tematu korzystałem z pełnych masek i oznaczeń. Chodzi o to, że target
<code>MARK</code> i <code>CONNMARK</code> są w stanie nakładać oznaczenia 32-bitowe. Zapis HEX to 0x00000000 do
0xffffffff. Zarówno maska jak i oznaczenie może przybrać wartość z tego przedziału. Jeśli nie
określamy maski, to domyślnie jest ustawiana 0xffffffff . Efektem tego jest przepisywanie oznaczeń.
W każdej z tych dwu baz wykorzystujemy inną maskę. W pierwszej mamy 0x0000ff00 , w drugiej zaś
0x000000ff . Skrótowo zawsze można zapisać je z pominięciem poprzedzających zer, tj. 0xff00 oraz
0xff. Tego typu oznaczenia będą zwracane przez <code>iptables</code> podczas listowania reguł.</p>
<p>Tak stworzony mechanizm markujący działa w następujący sposób. Pakiet w stanie <code>NEW</code> nie mający
jeszcze nałożonego oznaczenia (0x00000000, 0x0) dociera do tablicy <code>mangle</code> do łańcucha
<code>PREROUTING</code> . Tam wpada do pierwszej bazy markującej i przechodzi przez pierwszą regułę. Jako, że
ten pakiet ma oznaczenie 0x00000000, to ta pierwsza reguła nic zbytnio z nim nie robi. Pakiet po
przejściu przez nią dalej ma oznaczenie 0x00000000 . Druga reguła dopasowuje pakiet w oparciu o
moduł <code>-m mark</code> i jeśli pakiet ma inne oznaczenie niż 0x00000000, to zostaje zwrócony do łańcucha
wyżej, czyli nie przechodzi już przez pozostałe reguły tej bazy markującej. Trzecia reguła również
porównuje ustawione oznaczenie. Jeśli pakiet nie jest oznaczony, tzn. ma 0x00000000, to jest
przesyłany do łańcucha <code>marking-1</code> , w którym będą się znajdować reguły markujące. Te reguły nas na
razie nie interesują. Po przejściu przez łańcuch <code>marking-1</code> , pakiet trafia do ostatniej reguły w
pierwszej bazie markującej. To tutaj właśnie jest zapisywane oznaczenie dla całego połączenia, które
widzieliśmy wyżej w tablicy conntrack'a. Niemniej jednak, zapisywane są tylko bity określone przez
maskę 0x0000ff00. Podobnie sprawa wygląda w przypadku drugiej bazy markującej. W tym przypadku
wykorzystujemy maskę 0x000000ff .</p>
<p>Zatem w obu przypadkach maski są inne, czyli inne bity będą brane pod uwagę. W efekcie, pakiet
przechodząc przez obie bazy będzie miał ustawione oznaczenie sumaryczne, tj. znacznik ustawiony w
drugiej bazie zostanie dodany do tego oznaczenia nałożonego przez pierwszą bazę. W ten sposób
mechanizmy operujące na tych bazach mogą oznaczać pakiety niezależnie i operować na tak ustawionych
oznaczeniach bez przeszkadzania sobie.</p>
<h2 id="reguły-markujące">Reguły markujące</h2>
<p>Te powyższe bazy markujące są ustawione w taki sposób, by pakiet, który nie został jeszcze
oznaczony, przechodził przez reguły markujące. W pierwszej bazie mamy zdefiniowany łańcuch
<code>marking-1</code> , w drugiej zaś <code>marking-2</code> . W tych łańcuchach musimy teraz umieścić reguły. Dla
przykładu dodajmy tam te poniższe:</p>
<pre><code># iptables -t mangle -A marking-1 -p icmp -m icmp --icmp-type 8 -j MARK --set-xmark 0x00000100/0x0000ff00

# iptables -t mangle -A marking-2 -d 8.8.8.8 -j MARK --set-xmark 0x00000002/0x000000ff
# iptables -t mangle -A marking-2 -d 8.8.4.4 -j MARK --set-xmark 0x00000001/0x000000ff
</code></pre>
<p>W pierwszej bazie markującej dodaliśmy regułę, która oznacza pakiety protokołu ICMP echo-request.
Będzie im nadawane oznaczenie 0x100, czyli 256 po przeliczeniu na ludzki język. To oznaczenie po
przejściu przez tę bazę, zostanie przypisane do całego połączenia. Następnie pakiety trafią do
drugiej bazy markującej i przejdą przez dwie ostatnie reguły widoczne powyżej. W zależności od
miejsca przeznaczenia ping'u, pakiety zostaną tutaj oznaczone 0x1 lub 0x2. Jako, że korzystamy z
innej maski, to te wartości zostaną dodane do tej poprzedniej. Czyli pakiet po przejściu przez drugą
bazę markującą będzie miał oznaczenie 0x101 lub 0x102 , czyli 257 lub 258. Poniżej prezentuje się
listing tablicy <code>mangle</code> :</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/1.tablica-mangle-iptables-mark-oznaczanie-pakietow.png" alt="tablica-mangle-iptables-mark-oznaczanie-pakietow"    class="huge"></p>
<p>Sprawdźmy czy ten mechanizm działa jak należy. Odpalamy zatem terminal i wysyłamy żądania <code>ping</code> do
kilku serwisów:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/2.ping-iptables-mark-oznaczanie-pakietow-conntrack.png" alt="ping-iptables-mark-oznaczanie-pakietow-conntrack"    class="huge"></p>
<p>W górnym okienku mamy podgląd tablicy conntrack'a. W pozostałych czterech oknach mamy ping'i.
Widzimy, że tablica conntrack'a jest filtrowana i zwracane są wyniki ze znacznikiem innym niż 0.
Wszystkie żądania <code>ping</code> zostały oznaczone znacznikiem minimum 0x100, czyli minim 256. Dwa z wpisów
conntrack'a mają przypisany mark 0x101 oraz 0x102, czyli 257 i 268 w zapisie dziesiętnym. Są to
połączenia, które zostały dopasowane w obu bazach markujących. Pozostałe zaś zostały dopasowane
tylko w pierwszej bazie i dlatego ich oznaczenie wskazuje na 0x100, czyli 256. Jeśli podejrzymy
jeszcze raz reguły w tablicy <code>mangle</code> , powinniśmy zobaczyć szereg dopasowań:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/3.tablica-mangle-iptables-mark-oznaczanie-pakietow.png" alt="tablica-mangle-iptables-mark-oznaczanie-pakietow"    class="huge"></p>
<p>Mamy cztery sesje <code>ping</code> . W łańcuchu <code>marking-1</code> mamy cztery dopasowania, zaś w łańcuchu
<code>marking-2</code> mamy dwa dopasowania. W łańcuchach <code>base-1</code> oraz <code>base-2</code> w regule drugiej (ta z
<code>RETURN</code>) również mamy kilka dopasowań, co wskazuje, że oznaczenie części pakietów różni się od 0x0
na pozycjach bitów określonych przez maski. Ilość dopasowanych pakietów w obu przypadkach się różni.
W pierwszej bazie jest dopasowanych 80 pakietów, w drugiej zaś jedynie 40. Dzieje się tak dlatego,
że w pierwszej bazie zostały oznaczone wszystkie pakiety ICMP. Natomiast w drugiej, tylko połowa,
bo przecie tylko dwie z czterech sesji <code>ping</code> idzie na adresy 8.8.8.8 i 8.8.4.4 .</p>
<h2 id="jak-działa---set-xmark-w-target-mark">Jak działa --set-xmark w target MARK</h2>
<p>Przy oznaczaniu pakietów za pomocą target <code>MARK</code>, reguły mają postać
<code>-j MARK --set-xmark 0x100/0xff00</code> lub <code>-j MARK --set-xmark 0x2/0xff</code> (pomińmy te poprzedzające
zera). By zrozumieć co dokładnie zachodzi przy przetwarzaniu tych reguł, trzeba sobie rozpisać
binarnie wszystkie te wartości biorąc pod uwagę przepływ pakietów przez reguły.</p>
<p>Wszystkie pakiety, które trafiają do <code>iptables</code> są oznaczone markiem 0x0. W pierwszej bazie
markującej chcemy ustawić oznaczenie 0x100/0xff00. By tego dokonać, trzeba przeprowadzić dwie
operacje: <code>AND NOT</code> oraz <code>XOR</code> . Spójrzmy poniżej:</p>
<pre><code>     MARK 0000 0000 0000 0000    bazowe oznaczenie (0x0)
     MASK 1111 1111 0000 0000    nasza maska (0xff00)
  AND NOT -------------------    w MASK trzeba pierw poodwracać bity (0-&gt;1, 1-&gt;0), po czym dać logiczny AND z MARK
   RESULT 0000 0000 0000 0000    w ten sposób stary MARK zawsze jest przepisywany (0x0)
SET XMARK 0000 0001 0000 0000    ustawiamy nowy mark (0x100)
      XOR -------------------    przeprowadzamy operację XOR (przepisujemy różniące się bity)
   RESULT 0000 0001 0000 0000    otrzymujemy nowy mark (0x100) --&gt; 256
</code></pre>
<p>W przypadku bazowego marka 0x0, ten proces nie jest tak klarowny jak być powinien. Na szczęście mamy
drugą fazę oznaczania i tu już proces powinien być już bardziej przejrzysty:</p>
<pre><code>     MARK 0000 0001 0000 0000    bazowe oznaczenie (0x100)
     MASK 0000 0000 ffff ffff    nasza maska (0xff)
  AND NOT -------------------    w MASK trzeba pierw poodwracać bity (0-&gt;1, 1-&gt;0), po czym dać logiczny AND z MARK
   RESULT 0000 0001 0000 0000    w ten sposób stary MARK zawsze jest przepisywany (0x100)
SET XMARK 0000 0000 0000 0001    ustawiamy nowy mark (0x1)
      XOR -------------------    przeprowadzamy operację XOR (przepisujemy różniące się bity)
   RESULT 0000 0001 0000 0001    otrzymujemy nowy mark (0x101) --&gt; 257
</code></pre>
<p>Tak właśnie działa dodawanie (sumowanie) oznaczeń w <code>iptables</code> przy pomocy target <code>MARK</code> .</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/iptables/">Iptables</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&amp;text=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&amp;title=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&amp;title=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&title=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&amp;title=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ftarget-mark-w-iptables%2f&description=Target%20MARK%20w%20iptables%20%28sumowanie%20oznacze%c5%84%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/debugowanie-regul-iptables-target-trace/">Debugowanie reguł iptables via target TRACE</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-zablokowac-facebook-youtube-openwrt/">Jak zablokować Facebook i YouTube w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/filtr-pakietow-sieciowych-w-openwrt-firewall/">Filtr pakietów sieciowych w OpenWRT (firewall)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/nat-reflection-oraz-nat-loopback-w-openwrt/">NAT Reflection oraz NAT Loopback w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/kompromitacja-firewalla-openwrt-za-sprawa-ping/">Kompromitacja firewall&#39;a OpenWRT za sprawą ping</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-diod-w-routerze-pod-openwrt-led/">Konfiguracja diod w routerze pod OpenWRT (LED)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-interfejsow-ifb-w-linuxie/">Konfiguracja interfejsów IFB w linux&#39;ie</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script src="https://utteranc.es/client.js"
        repo="morfikov/morfitronik-comments"
        issue-term="og:title"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://mastodon.social/@morfik">
			<svg class="social__icon" aria-label="Mastodon" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M416 197c0-74-49-96-49-96-42-22-172-24-222 0 0 0-49 22-49 96v59c2 72 14 145 81 162 33 9 89 18 140-6l-2-27s-27 7-58 7c-74 2-67-39-70-52 0 0 51 17 137 6 42-6 80-32 85-56 8-38 7-93 7-93zm-58 96h-35v-88c0-18-8-27-23-27-18 0-27 11-27 33v47h-34v-47c0-22-9-33-27-33-15 0-23 9-23 27v88h-35v-91c0-18 5-60 52-60 39 0 50 37 50 37s10-37 50-37c45 0 52 42 52 60v91z"/></svg>
		</a>
</div>
	<div class="footer__copyright">© 2025 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const images = Array.from(document.querySelectorAll(".entry__content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>
</body>
</html>
