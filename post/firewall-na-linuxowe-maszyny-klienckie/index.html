<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Firewall na linux&#39;owe maszyny klienckie | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Firewall na linux&#39;owe maszyny klienckie" />
<meta property="og:description" content="Prędzej czy później, każdy z nas będzie musiał zabezpieczyć dostęp do swojego komputera w sieci. Do
tego zadania na stacjach z linux&#39;em jest oddelegowane narzędzie iptables wraz z szeregiem
dodatków, jak np. ipset . By zbudować solidny firewall nie potrzeba zbytnio się wysilać. Niemniej
jednak, temat zapory linux&#39;owej jest bardzo
rozległy i nie będziemy tutaj
opisywać wszystkich możliwych scenariuszy jej zastosowania. Zamiast tego skupimy się jedynie na
bazowym skrypcie, który można rozbudować bez przeszkód i dostosować go zarówno pod maszyny klienckie
jak i te serwerowe." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morfikov.github.io/post/firewall-na-linuxowe-maszyny-klienckie/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-06-22T23:33:58+00:00" />
<meta property="article:modified_time" content="2015-06-22T23:33:58+00:00" />


		<meta itemprop="name" content="Firewall na linux&#39;owe maszyny klienckie">
<meta itemprop="description" content="Prędzej czy później, każdy z nas będzie musiał zabezpieczyć dostęp do swojego komputera w sieci. Do
tego zadania na stacjach z linux&#39;em jest oddelegowane narzędzie iptables wraz z szeregiem
dodatków, jak np. ipset . By zbudować solidny firewall nie potrzeba zbytnio się wysilać. Niemniej
jednak, temat zapory linux&#39;owej jest bardzo
rozległy i nie będziemy tutaj
opisywać wszystkich możliwych scenariuszy jej zastosowania. Zamiast tego skupimy się jedynie na
bazowym skrypcie, który można rozbudować bez przeszkód i dostosować go zarówno pod maszyny klienckie
jak i te serwerowe."><meta itemprop="datePublished" content="2015-06-22T23:33:58+00:00" />
<meta itemprop="dateModified" content="2015-06-22T23:33:58+00:00" />
<meta itemprop="wordCount" content="2039">
<meta itemprop="keywords" content="bezpieczeństwo,iptables,systemd," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Firewall na linux&#39;owe maszyny klienckie"/>
<meta name="twitter:description" content="Prędzej czy później, każdy z nas będzie musiał zabezpieczyć dostęp do swojego komputera w sieci. Do
tego zadania na stacjach z linux&#39;em jest oddelegowane narzędzie iptables wraz z szeregiem
dodatków, jak np. ipset . By zbudować solidny firewall nie potrzeba zbytnio się wysilać. Niemniej
jednak, temat zapory linux&#39;owej jest bardzo
rozległy i nie będziemy tutaj
opisywać wszystkich możliwych scenariuszy jej zastosowania. Zamiast tego skupimy się jedynie na
bazowym skrypcie, który można rozbudować bez przeszkód i dostosować go zarówno pod maszyny klienckie
jak i te serwerowe."/>

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119125303-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Firewall na linux&#39;owe maszyny klienckie</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2015-06-22T23:33:58Z">Opublikowano: 22/06/2015</time>

<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/linux/" rel="category">Linux</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Firewall na linux&#39;owe maszyny klienckie</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#przepływ-pakietów-przez-firewall">Przepływ pakietów przez firewall</a>
      <ol>
        <li><a href="#tablica-filter">Tablica filter</a></li>
        <li><a href="#tablica-nat">Tablica nat</a></li>
        <li><a href="#tablica-mangle">Tablica mangle</a></li>
        <li><a href="#tablica-raw">Tablica raw</a></li>
      </ol>
    </li>
    <li><a href="#stany-pakietów-na-zaporze">Stany pakietów na zaporze</a></li>
    <li><a href="#jak-zbudować-dobry-firewall">Jak zbudować dobry firewall</a></li>
    <li><a href="#usługa-dla-systemd">Usługa dla systemd</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Prędzej czy później, każdy z nas będzie musiał zabezpieczyć dostęp do swojego komputera w sieci. Do
tego zadania na stacjach z linux'em jest oddelegowane narzędzie <code>iptables</code> wraz z szeregiem
dodatków, jak np. <code>ipset</code> . By zbudować solidny firewall nie potrzeba zbytnio się wysilać. Niemniej
jednak, temat zapory linux'owej jest <a href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html">bardzo
rozległy</a> i nie będziemy tutaj
opisywać wszystkich możliwych scenariuszy jej zastosowania. Zamiast tego skupimy się jedynie na
bazowym skrypcie, który można rozbudować bez przeszkód i dostosować go zarówno pod maszyny klienckie
jak i te serwerowe.</p>
<h2 id="przepływ-pakietów-przez-firewall">Przepływ pakietów przez firewall</h2>
<p>By firewall realizował wyznaczone mu zadania, trzeba dodać do niego szereg reguł. Problem w tym, że
iptables składa się z kilku tablic. Do naszej dyspozycji są: <code>raw</code> , <code>magnle</code> , <code>nat</code> i <code>filter</code> .
Ponadto, każda z tablic ma pewien zestaw łańcuchów, w których skład mogą wchodzić: <code>INPUT</code> ,
<code>OUTPUT</code> , <code>FORWARD</code> , <code>PREROUTING</code> oraz <code>POSTROUTING</code> . Pakiety przychodzące, wychodzące i
przechodzące przez dowolną maszynę znajdującą się w sieci, bez względu na to czy to router, serwer,
czy klient, robią to w ściśle określonej kolejności. Najlepiej to zobrazować poniższą fotką:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2015/06/1.firewall-iptables-przeplyw-pakietow.png" alt=""    class="big"></p>
<p>Pakiety dzielimy na te otrzymane ( <code>RX</code> ) oraz te wysłane ( <code>TX</code> ). Każdy z nich przechodzi przez
powyższy schemat, z tym, że nieco inną drogą. Najprostsza sytuacja ma miejsce gdy pakiet jest
adresowany do naszej maszyny. Podobnie gdy to my wysyłamy pakiet pod adresem jakiegoś konkretnego
komputera w sieci. Dodatkowo, pakiet potrafi przechodzić przez szereg innych maszyn po drodze. Nie
jest on w takim przypadku bezpośrednio adresowany, np. do routera, ale by osiągnąć jakiś host w
sieci, musi przez niego przejść.</p>
<h3 id="tablica-filter">Tablica filter</h3>
<p>W tablicy <code>filter</code> , jak sama nazwa mówi, będziemy dokonywać głównego filtrowania pakietów i to w
dużej mierze tutaj zostaną one zaakceptowane lub też i odrzucone. Sama tablica ma trzy łańcuchy i
jeśli mamy do czynienia ze zwykłą maszyną kliencką, to będą nas interesować jedynie dwa z nich:
<code>INPUT</code> oraz <code>OUTPUT</code> . Jeżeli mamy w domu router, to wtedy również będzie wchodzić w grę łańcuch
<code>FORWARD</code> . Podobnie sprawa ma się w przypadku gdy udostępniamy połączenie sieciowe za pomocą
zwykłego komputera innym maszynom. Na dobrą sprawę, to wtedy nasz komputer staje się routerem i
wszystkie reguły, które aplikują się do routerów, będą mieć także zastosowanie na takiej maszynie
udostępniającej, np. internet w pokoju obok.</p>
<h3 id="tablica-nat">Tablica nat</h3>
<p>I tu właśnie zaczynają się problemy. Jak wspomniałem na wstępnie, mamy do dyspozycji cztery tablice,
a nie jedną. Jeśli jesteśmy już przy łańcuchu <code>FORWARD</code> i udostępnianiu połączenia, to nie sposób
ominąć tablicę <code>nat</code> . Jest ona bardzo podobna do tablicy <code>filter</code> , z tym, że nie posiada łańcucha
<code>FORWARD</code> , a zamiast niego ma dwa inne: <code>PREROUTING</code> i <code>POSTROUTING</code> .</p>
<p>Przez tę tablicę przechodzą jedynie pakiety rozpoczynające nowe połączenia i to w niej będziemy
określać translację adresów, dzięki czemu, jesteśmy w stanie podzielić jeden adres IP między szereg
hostów w sieci.</p>
<h3 id="tablica-mangle">Tablica mangle</h3>
<p>Tej tablicy się praktycznie nie wykorzystuje w procesie filtrowania. Jej zadaniem nie jest przemiana
pakietów. Jeśli musimy dostosować TTL pakietu czy oznaczyć pakiety markerami, to robimy to w tej
tablicy.</p>
<h3 id="tablica-raw">Tablica raw</h3>
<p>Jej głównym zadaniem jest wyłączenie śledzenia określonych połączeń, gdyż pakiety trafiające do tej
tablicy robią to zanim mechanizm conntrack zacznie działać. Można ją oczywiście wykorzystać w
procesie filtrowania na bardzo wczesnym etapie analizy pakietu. Jeśli znamy adres IP z jakiego
nadszedł pakiet i chcemy zablokować mu dostęp, to nic nie stoi na przeszkodzie by to zrobić w tej
tablicy, choć o wiele lepszym miejscem do tego jest tablica <code>filter</code> .</p>
<h2 id="stany-pakietów-na-zaporze">Stany pakietów na zaporze</h2>
<p>My tutaj zajmiemy się budową zapory, która będzie operować w oparciu o stany pakietów. Iptables
potrafi rozróżnić cztery stany połączeń protokołu TCP: <code>NEW</code> , <code>ESTABLISHED</code> , <code>RELATED</code> oraz
<code>INVALID</code> . Skąd system wie, że dany pakiet ma zostać przypisany do połączenia w stanie <code>NEW</code> , a
nie <code>INVALID</code> ?</p>
<p>Każde otwarte połączenie okupuje odpowiednie gniazdo (socket), w skład którego wchodzi lokalny
adres, lokalny port, zdalny adres, zdalny port oraz protokół. Te dane są śledzone przez kernel w
tablicy conntrack'a (do wglądu w <code>/proc/net/ip_conntrack</code> lub <code>/proc/net/nf_conntrack</code> ) i to na
postawie tych wpisów ustalany jest status pakietu. Powiedzmy zatem kilka słów o <a href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html#STATEMACHINE">poszczególnych
stanach połączeń</a>:</p>
<ul>
<li><code>NEW</code> identyfikuje pakiety rozpoczynające nowe połączenia. Jest to pierwszy pakiet, który został
dostrzeżony przez moduł conntrack. Zawiera on ustawioną flagę <code>SYN</code> .</li>
<li><code>ESTABLISHED</code> identyfikuje pakiety, które należą już do istniejących połączeń.</li>
<li><code>RELATED</code> określa pakiety, które są powiązane ze stanem <code>ESTABLISHED</code> . Aby połączenie mogło być
w stanie <code>RELATED</code> , musi pierw zostać zestawione połączenie w stanie <code>ESTABLISHED</code> . Następnie
to ustanowione połączenie stworzy połączenie powiązane. Przykładem może być protokół FTP, gdzie
sesja może odbywać się na porcie 21 ale przepływ danych odbywa się na porcie 20.</li>
<li><code>INVALID</code> jest przypisywany wszystkim połączeniom niepasującym do tych trzech powyższych stanów.
Każdy pakiet TCP ma ustawione flagi, które określają dokładnie co to jest za rodzaj pakietu, np.
czy ma on na celu otwarcie nowego połączenia czy też jest to potwierdzenie przesłania pewnej
ilości danych z jednego hosta do drugiego. Są pewne określone sekwencje flag, które umożliwiają
komunikację sieciową. Niemniej jednak, można tymi flagami dowolnie manipulować i tak wykutymi
pakietami można dokonywać skanowania portów w poszukiwaniu usług sieciowych, np. SSH, co zwykle
może się skończyć atakiem, w przypadku gdy określona usługa zostanie przez atakującego wykryta.
Stan <code>INVALID</code> zawiera wszystkie te niepoprawne kombinacje flag.</li>
</ul>
<p>Biorąc pod uwagę te stany połączeń, musimy zatroszczyć się także o <a href="https://morfikov.github.io/post/jak-wyczyscic-tablice-conntrack-w-debianie/">czyszczenie wpisów w tablicy
conntrack'a</a>. Nie jest to
wprawdzie wymagana opcja ale znacznie poprawia bezpieczeństwo systemu.</p>
<h2 id="jak-zbudować-dobry-firewall">Jak zbudować dobry firewall</h2>
<p>Nasz firewall powinien zezwalać na przetwarzanie pakietów w stanie <code>ESTABLISHED</code> oraz <code>RELATED</code> ,
zrzucać pakiety w stanie <code>INVALID</code> i manipulować pakietami w stanie <code>NEW</code> . Na każdej maszynie,
która ma dostęp do internetu, firewall buduje się w ten sam sposób. Najpierw blokujemy cały ruch
pochodzący z zewnątrz sieci. Blokujemy także pakiety przechodzące przez dany komputer, czyli te,
których przeznaczeniem nie jest ta konkretna maszyna. Z kolei pakiety generowane przez tego hosta
powinny bez problemu mieć wyjście na świat, chyba, że projektujemy jakiś wymyślny serwer, który
będzie nadawał tylko na określonych portach. Tak czy inaczej, my skupimy się na zbudowaniu zapory,
która zabezpieczy dostęp do komputera z zewnątrz.</p>
<p>Tworzymy zatem kilka plików skryptu, np. w katalogu <code>/etc/filtr/</code> . Struktura tego katalogu powinna
wyglądać mniej więcej tak:</p>
<pre><code># ls -al
total 72K
drwxr-xr-x   2 root root 4.0K 2015-05-14 11:37:32 ./
drwxr-xr-x 157 root root    12K 2015-06-24 07:39:50 ../
-rwxr-----   1 root root 1.8K 2015-01-27 03:53:58 base.sh*
-rwxr-----   1 root root  822 2015-01-26 22:51:59 ip6tables_filter.sh*
-rwxr-----   1 root root   47 2015-01-26 22:51:29 ip6tables_mangle.sh*
-rwxr-----   1 root root   44 2015-01-26 22:51:23 ip6tables_nat.sh*
-rwxr-----   1 root root   44 2015-01-26 22:51:18 ip6tables_raw.sh*
-rwxr-----   1 root root 8.6K 2015-03-05 21:13:24 iptables_filter.sh*
-rwxr-----   1 root root 1.5K 2015-03-05 21:13:24 iptables_mangle.sh*
-rwxr-----   1 root root  356 2015-03-05 21:13:23 iptables_nat.sh*
-rwxr-----   1 root root 1.8K 2015-01-26 22:40:26 iptables_raw.sh*
</code></pre>
<p>Pliki mające w nazwie <code>6</code> są od filtra protokołu IPv6 . Każdy z plików (za wyjątkiem base.sh) ma
dodatkowo nazwę tablicy, której reguły będzie przechowywał. Natomiast <code>base.sh</code> , to podstawowy
firewall, którego reguły będą aplikowane, np. przy resetowaniu głównego filtra.</p>
<p>Plik <code>iptables_filter.sh</code> :</p>
<pre><code>#!/bin/sh

ipt=&quot;$(which iptables) -t filter&quot;

$ipt -P INPUT DROP
$ipt -P FORWARD DROP
$ipt -P OUTPUT ACCEPT

$ipt -F
$ipt -X

$ipt -N tcp
$ipt -N udp
$ipt -N icmp_in
$ipt -N fw-interfaces
$ipt -N fw-open

$ipt -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
$ipt -A INPUT -i lo -j ACCEPT
$ipt -A INPUT -m conntrack --ctstate INVALID -j DROP
$ipt -A INPUT -p icmp -m conntrack --ctstate NEW -j icmp_in
$ipt -A INPUT -p udp -m conntrack --ctstate NEW -j udp
$ipt -A INPUT -p tcp ! --syn -m conntrack --ctstate NEW -j DROP -m comment --comment &quot;Connections not started by SYN&quot;
$ipt -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j tcp

$ipt -A INPUT -p tcp -j REJECT --reject-with tcp-reset
$ipt -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
$ipt -A INPUT -j REJECT --reject-with icmp-proto-unreachable

$ipt -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
$ipt -A FORWARD -m conntrack --ctstate INVALID -j DROP
$ipt -A FORWARD -m conntrack --ctstate NEW -j fw-interfaces
$ipt -A FORWARD -m conntrack --ctstate NEW -j fw-open
$ipt -A FORWARD -j REJECT --reject-with icmp-host-unreachable

$ipt -A icmp_in -p icmp -j LOG --log-prefix &quot;* IPTABLES: ICMP_NEW * &quot;
$ipt -A icmp_in -p icmp -j DROP
</code></pre>
<p>Plik <code>ip6tables_filter.sh</code> :</p>
<pre><code>#!/bin/sh

ip6t=&quot;$(which ip6tables) -t filter&quot;

$ip6t -P INPUT DROP
$ip6t -P FORWARD DROP
$ip6t -P OUTPUT ACCEPT
$ip6t -F
$ip6t -X
$ip6t -N tcp
$ip6t -N udp
$ip6t -N icmp

$ip6t -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
$ip6t -A INPUT -i lo -j ACCEPT
$ip6t -A INPUT -m conntrack --ctstate INVALID -j DROP
$ip6t -A INPUT -p icmpv6 -m conntrack --ctstate NEW -j icmp
$ip6t -A INPUT -p udp -m conntrack --ctstate NEW -j udp
$ip6t -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j tcp
$ip6t -A INPUT -p tcp -j REJECT --reject-with tcp-reset
$ip6t -A INPUT -p udp -j REJECT --reject-with icmp6-port-unreachable

$ip6t -A icmp -p icmpv6 -j ACCEPT -m limit --limit 6/s --limit-burst 10
$ip6t -A icmp -p icmpv6 -j DROP
</code></pre>
<p>Plik <code>base.sh</code> :</p>
<pre><code>#!/bin/sh

iptables_stop()
{
      ipt=&quot;$(which iptables)&quot;
      ip6t=&quot;$(which ip6tables)&quot;

      $ipt -P INPUT DROP
      $ipt -P FORWARD DROP
      $ipt -P OUTPUT ACCEPT

      $ip6t -P INPUT DROP
      $ip6t -P FORWARD DROP
      $ip6t -P OUTPUT ACCEPT

      for iptable in $ipt $ip6t
      do
            for table in \
                  &quot;-t raw&quot; \
                  &quot;-t mangle&quot; \
                  &quot;-t filter&quot; \
                  &quot;-t nat&quot;
            do
                  $iptable $table -F
                  $iptable $table -X
            done
      done

      $ipt -t filter -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      $ipt -t filter -A INPUT -i lo -j ACCEPT
      $ipt -t filter -A INPUT -m conntrack --ctstate INVALID -j DROP
      $ipt -t filter -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
      $ipt -t filter -A INPUT -p tcp -j REJECT --reject-with tcp-reset
      $ipt -t filter -A INPUT -j REJECT --reject-with icmp-proto-unreachable

      $ip6t -t filter -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      $ip6t -t filter -A INPUT -i lo -j ACCEPT
      $ip6t -t filter -A INPUT -m conntrack --ctstate INVALID -j DROP
      $ip6t -t filter -A INPUT -p tcp -j REJECT --reject-with tcp-reset
      $ip6t -t filter -A INPUT -p udp -j REJECT --reject-with icmp6-port-unreachable
}

iptables_stop
</code></pre>
<p>Generalnie rzecz biorąc przepuszczamy ruch na interfejsie <code>lo</code> . Jeśli jakieś procesy potrzebują
adresu z klasy <code>127.0.0.0/8</code> , to będą mogły z niego swobodnie korzystać. Żadna maszyna za wyjątkiem
hosta lokalnego (localhost) nie może nawiązać połączenia z tą klasą adresów, dlatego też można ją
bez wahania odhaczyć. W przypadku gdybyśmy zablokowali ten ruch, pewne procesy systemowe mogą
przestać działać.</p>
<p>Stworzyliśmy także kilka dodatkowych łańcuchów: <code>tcp</code>, <code>udp</code>, <code>icmp_in</code>, <code>fw-interfaces</code>,
<code>fw-open</code> . Pierwsze trzy rozgraniczają trzy główne protokoły gdzie będą kierowane określone
pakiety. Z kolei czwarty z nich odpowiada za lokalne interfejsy, które mogą wysyłać pakiety w świat.
To na wypadek udostępniania połączenia. Z kolei ostatni łańcuch jest od otwierania i przekierowania
portów na maszyny lokalne. Cały pozostały ruch będzie trafiał z automatu na reguły zajmujące się
zwracaniem odpowiednich komunikatów hostom, które próbowały się z nami połączyć.</p>
<p>Ta powyższa konfiguracja zapory jest bardzo podstawowa i nadaje się jedynie na stację kliencką. Nie
akceptuje ona żadnych nowych połączeń z sieci. Wszystkie z nich muszą pierw zostać zainicjowane
lokalnie, co czyni naszą maszynę bezpieczną, chyba, że ktoś nam wgra wirusa, trojana czy inny syf,
który będzie nawiązywał zdalne połączenia automatycznie gdy tylko podłączymy się do sieci.</p>
<p>Ten firewall ma budowę modularną, tj. możemy tworzyć kolejne pliki w zależności od wersji protokołu
IP oraz tablicy, w której chcemy umieszczać dodatkowe reguły. Możemy także bez problemu podpiąć
dodatkowe moduły i dopisać konfigurację np. dla <code>ipset</code> .</p>
<h2 id="usługa-dla-systemd">Usługa dla systemd</h2>
<p>By odpalić taki firewall, potrzebujemy jeszcze odpowiedniego pliku <code>.service</code> , który zainicjuje te
powyższe skrypty. Tworzymy zatem <code>/etc/systemd/system/firewall.service</code> i dodajemy w nim poniższy
kod:</p>
<pre><code>[Unit]
Description=firewall
Documentation=man:iptables
DefaultDependencies=no
Wants=network-pre.target systemd-modules-load.service
Before=network-pre.target
After=systemd-modules-load.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_raw.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_mangle.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_nat.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_filter.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_raw.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_mangle.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_nat.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_filter.sh&quot;
ExecStop=/bin/sh -c &quot;/etc/filtr/base.sh&quot;

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Dodajemy tę usługę do autostartu systemu i odpalamy ją:</p>
<pre><code># systemctl daemon-reload
systemctl enable firewall.service
systemctl start firewall.service
</code></pre>
<p>Powyższa baza reguł została napisane w celu stworzenia zapory ściśle klienckiej ale ten schemat może
posłużyć także do udostępniania usług na danej maszynie, jak u również możemy przy jego pomocy
udostępnić połączenie sieciowe innym komputerom w sieci lokalnej.</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/bezpieczenstwo/">bezpieczeństwo</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/iptables/">iptables</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/systemd/">systemd</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&amp;text=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&amp;title=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&amp;title=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&title=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&amp;title=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffirewall-na-linuxowe-maszyny-klienckie%2f&description=Firewall%20na%20linux%27owe%20maszyny%20klienckie" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/dnscrypt-proxy-czyli-szyfrowanie-zapytan-dns/">DNScrypt-proxy, czyli szyfrowanie zapytań DNS</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/ecryptfs-jako-alternatywa-dla-encfs/">ECryptfs jako alternatywa dla encfs</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/autostart-i-automatyczne-montowanie-nosnikow/">Autostart i automatyczne montowanie nośników</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/automatyczne-wylogowanie-uzytkownika-z-konsoli/">Automatyczne wylogowanie użytkownika z konsoli</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-gpg-w-pliku-gpg-conf/">Konfiguracja GPG w pliku gpg.conf</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/bezpieczny-klucz-gpg/">Bezpieczny klucz GPG</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/automatycznie-generowane-haslo-do-serwisu-www/">Automatycznie generowane hasło do serwisu WWW</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script>
  var id =  76 ;

  if (id)
  {
    let url = "https://github.com/morfikov/morfitronik-comments/issues/".concat(id);
    let api_url = "https://api.github.com/repos/morfikov/morfitronik-comments/issues/".concat(id, "/comments");

    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Komentarze dla tego postu nie zostały jeszcze otworzone (albo skrypty GitHub'a są wyłączone). Być może też skończył ci się przydział 60/godzinę (limit GitHub'a).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h3");
        mainHeader.innerHTML = "Komentarze: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>Możesz zostawić komentarz korzystając z <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);

        comments.forEach(function(comment)
        {
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Europe/Warsaw' };
			options.timeZoneName = 'short';
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " | <em>", (new Date(comment.created_at)).toLocaleTimeString('pl-PL', options), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Wystąpił jakiś błąd przy ładowaniu komentarzy.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/mikhailmorfikov">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
</div>
	<div class="footer__copyright">© 2021 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
</body>
</html>
