<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://morfikov.github.io/post/jak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm/">
  <meta property="og:site_name" content="Morfitronik">
  <meta property="og:title" content="Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM">
  <meta property="og:description" content="Bawiąc się ostatnio maszynami wirtualnymi na bazie QEMU/KVM, zauważyłem, że sugerowany rozmiar pliku .qcow2 waha się w okolicach 25 GiB. Nie jest to może jakoś specjalnie dużo ale mało to też nie jest, zwłaszcza jeśli tworzymy maszyny wirtualne na dysku swojego laptopa. Co jeśli przeholowaliśmy z szacunkami co do rozmiaru takiego obrazu i po zainstalowaniu systemu operacyjnego gościa okazało się, że w sumie to ten obraz można by zmniejszyć o połowę? Albo też i w drugą stronę, tj. co w przypadku, gdy stworzony obraz maszyny wirtualnej okazał się zbyt mały i teraz zachodzi potrzeba jego powiększenia? Czy w takiej sytuacji musimy na nowo tworzyć maszynę wirtualną odpowiednio zwiększając lub zmniejszając jej przestrzeń na pliki? A może istnieje jakiś sposób na zmianę rozmiaru tych istniejących już obrazów maszyn wirtualnych? Postaramy się ten fakt zweryfikować, a cały proces zostanie opisany przy wykorzystaniu systemu Debian Linux.">
  <meta property="og:locale" content="pl_PL">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2020-08-09T13:45:00+00:00">
    <meta property="article:modified_time" content="2020-08-09T13:45:00+00:00">
    <meta property="article:tag" content="Debian">
    <meta property="article:tag" content="Wirtualizacja">
    <meta property="article:tag" content="Kvm">
    <meta property="article:tag" content="Qemu">
    <meta property="article:tag" content="Libvirt">

		
  <meta itemprop="name" content="Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM">
  <meta itemprop="description" content="Bawiąc się ostatnio maszynami wirtualnymi na bazie QEMU/KVM, zauważyłem, że sugerowany rozmiar pliku .qcow2 waha się w okolicach 25 GiB. Nie jest to może jakoś specjalnie dużo ale mało to też nie jest, zwłaszcza jeśli tworzymy maszyny wirtualne na dysku swojego laptopa. Co jeśli przeholowaliśmy z szacunkami co do rozmiaru takiego obrazu i po zainstalowaniu systemu operacyjnego gościa okazało się, że w sumie to ten obraz można by zmniejszyć o połowę? Albo też i w drugą stronę, tj. co w przypadku, gdy stworzony obraz maszyny wirtualnej okazał się zbyt mały i teraz zachodzi potrzeba jego powiększenia? Czy w takiej sytuacji musimy na nowo tworzyć maszynę wirtualną odpowiednio zwiększając lub zmniejszając jej przestrzeń na pliki? A może istnieje jakiś sposób na zmianę rozmiaru tych istniejących już obrazów maszyn wirtualnych? Postaramy się ten fakt zweryfikować, a cały proces zostanie opisany przy wykorzystaniu systemu Debian Linux.">
  <meta itemprop="datePublished" content="2020-08-09T13:45:00+00:00">
  <meta itemprop="dateModified" content="2020-08-09T13:45:00+00:00">
  <meta itemprop="wordCount" content="1507">
  <meta itemprop="keywords" content="Debian,Wirtualizacja,Kvm,Qemu,Libvirt">
		
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM">
  <meta name="twitter:description" content="Bawiąc się ostatnio maszynami wirtualnymi na bazie QEMU/KVM, zauważyłem, że sugerowany rozmiar pliku .qcow2 waha się w okolicach 25 GiB. Nie jest to może jakoś specjalnie dużo ale mało to też nie jest, zwłaszcza jeśli tworzymy maszyny wirtualne na dysku swojego laptopa. Co jeśli przeholowaliśmy z szacunkami co do rozmiaru takiego obrazu i po zainstalowaniu systemu operacyjnego gościa okazało się, że w sumie to ten obraz można by zmniejszyć o połowę? Albo też i w drugą stronę, tj. co w przypadku, gdy stworzony obraz maszyny wirtualnej okazał się zbyt mały i teraz zachodzi potrzeba jego powiększenia? Czy w takiej sytuacji musimy na nowo tworzyć maszynę wirtualną odpowiednio zwiększając lub zmniejszając jej przestrzeń na pliki? A może istnieje jakiś sposób na zmianę rozmiaru tych istniejących już obrazów maszyn wirtualnych? Postaramy się ten fakt zweryfikować, a cały proces zostanie opisany przy wykorzystaniu systemu Debian Linux.">

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
  


</head>
<body class="body kind-page">
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2020-08-09T13:45:00Z">Opublikowano: 09/08/2020</time>

<div class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/linux/" rel="category">Linux</a>
	</span>
</div>
	</div>
				<h1 class="entry__title">Jak zmienić rozmiar obrazu maszyny wirtualnej QEMU/KVM</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#jak-zmniejszyć-rozmiar-obrazu-maszyny-wirtualnej">Jak zmniejszyć rozmiar obrazu maszyny wirtualnej</a></li>
    <li><a href="#jak-zwiększyć-rozmiar-obrazu-maszyny-wirtualnej">Jak zwiększyć rozmiar obrazu maszyny wirtualnej</a></li>
    <li><a href="#odzyskiwanie-wolnego-miejsca-z-pliku-qcow2">Odzyskiwanie wolnego miejsca z pliku .qcow2</a></li>
    <li><a href="#kompresja-pliku-qcow2">Kompresja pliku .qcow2</a></li>
    <li><a href="#defragmentacja-pliku-obrazu">Defragmentacja pliku obrazu</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Bawiąc się ostatnio <a href="https://morfikov.github.io/post/wirtualizacja-qemu-kvm-libvirt-na-debian-linux/">maszynami wirtualnymi na bazie QEMU/KVM</a>, zauważyłem, że sugerowany rozmiar
pliku <code>.qcow2</code> waha się w okolicach 25 GiB. Nie jest to może jakoś specjalnie dużo ale mało to też
nie jest, zwłaszcza jeśli tworzymy maszyny wirtualne na dysku swojego laptopa. Co jeśli
przeholowaliśmy z szacunkami co do rozmiaru takiego obrazu i po zainstalowaniu systemu operacyjnego
gościa okazało się, że w sumie to ten obraz można by zmniejszyć o połowę? Albo też i w drugą stronę,
tj. co w przypadku, gdy stworzony obraz maszyny wirtualnej okazał się zbyt mały i teraz zachodzi
potrzeba jego powiększenia? Czy w takiej sytuacji musimy na nowo tworzyć maszynę wirtualną
odpowiednio zwiększając lub zmniejszając jej przestrzeń na pliki? A może istnieje jakiś sposób na
zmianę rozmiaru tych istniejących już obrazów maszyn wirtualnych? Postaramy się ten fakt
zweryfikować, a cały proces zostanie opisany przy wykorzystaniu systemu Debian Linux.</p>
<h2 id="jak-zmniejszyć-rozmiar-obrazu-maszyny-wirtualnej">Jak zmniejszyć rozmiar obrazu maszyny wirtualnej</h2>
<p>Okazuje się, że możemy nieco zmniejszyć rozmiar obrazu maszyny wirtualnej ale potrzebne są do tego
odpowiednie narzędzia, no i oczywiście nie da się tego zrobić automatycznie. Przede wszystkim,
trzeba będzie uruchomić na maszynie wirtualnej system live, tak by móc przepartycjonować jej
wirtualny dysk twardy. Zatem do dzieła. Odpalamy <code>virt-manager</code> i ustawiamy w nim rozruch systemu z
cd-rom (zmieniając kolejność nośników), czy też zaznaczając opcję <code>Enable boot menu</code> :</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/052-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Podczas rozruchu wciskamy klawisz <code>ESC</code> , co powinno zaowocować pojawieniem się menu wyboru nośnika,
z którego wystartować system:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/053-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Wybieramy cd-rom (pozycja druga).</p>
<p>Po chwili powinien nam się załadować system live Ubuntu:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/054-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>W tym systemie domyślnie jest już zainstalowany <code>gparted</code> ale gdybyśmy korzystali z innego systemu
live, to trzeba będzie ten pakiet doinstalować sobie we własnym zakresie.</p>
<p>Logujemy się na root via <code>sudo su</code> i uruchamiamy <code>gparted</code> :</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/055-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Jak widać na fotce, mamy dysk o rozmiarze 20 GiB, z czego system zajmuje niecałe 8 GiB. Przydałoby
się zmniejszyć rozmiar pliku <code>.qcow2</code> o połowę. W tym celu zmieniamy rozmiar partycji w <code>gparted</code> i
ustawiamy go na 10 GiB:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/056-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/057-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Czekamy cierpliwie aż proces dobiegnie końca. Może on zająć dłużej lub której, a wszystko zależy od
wielkości samego nośnika oraz od tego jak bardzo chcemy go skurczyć, tj. ile danych trzeba będzie
przenieść.</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/058-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Gdy proces zmiany rozmiaru partycji się zakończy, powinniśmy mieć jedną mniejszą partycję oraz
sporo wolnego miejsca:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/059-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Warto tutaj odnotować ostatni sektor partycji ( <code>20973567</code> ), który to posłuży nam do wyliczenia
nowego obrazu dysku (pliku <code>.qcow2</code> ): ((20973567+1)×512)/1024/1024 = 10241 MiB.</p>
<p>Po skurczeniu partycji wyłączamy maszynę wirtualną. Na maszynie hosta zaś odpalamy terminal i
patrzymy jaki rozmiar ma obecnie obraz maszyny wirtualnej:</p>
<pre><code># ls -alh ubuntu20.04.qcow2
-rw------- 1 root root 21G 2020-08-04 19:08:36 ubuntu20.04.qcow2
</code></pre>
<p>Póki co, jeszcze ma te 21 GiB. Teraz przy pomocy narzędzia <code>qemu-img</code> (dostępnego w pakiecie
<code>qemu-utils</code> ) zmniejszamy rozmiar obrazu maszyny wirtualnej w poniższy sposób:</p>
<pre><code># qemu-img resize --shrink ubuntu20.04.qcow2 10241M
Image resized.
</code></pre>
<p>Gdybyśmy przy wydawaniu tego polecenia dostali taki komunikat:</p>
<pre><code># qemu-img resize --shrink ubuntu20.04.qcow2 10241M
qemu-img: Could not open 'ubuntu20.04.qcow2': Failed to get &quot;write&quot; lock
Is another process using the image [ubuntu20.04.qcow2]?
</code></pre>
<p>oznacza to, że maszyna wirtualna wciąż działa i trzeba ją pierw zatrzymać, by móc wejść w
interakcję z jej obrazem.</p>
<p>Sprawdźmy ile obecnie zajmuje wirtualny dysk oraz sam plik <code>.qcow2</code> :</p>
<pre><code># qemu-img info ubuntu20.04.qcow2

image: ubuntu20.04.qcow2
file format: qcow2
virtual size: 10 GiB (10738466816 bytes)
disk size: 10 GiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: true
    refcount bits: 16
    corrupt: false
</code></pre>
<p>Wartość <code>virtual size</code> wskazuje <code>10738466816</code> bajtów, czyli 10241 MiB. Jest to dokładnie tyle ile
ustawiliśmy w <code>gparted</code> przy zmniejszaniu rozmiaru partycji systemowej. Natomiast rozmiar samego
pliku <code>.qcow2</code> różni się o niecałe 2 MiB w stosunku do wartości <code>virtual size</code> :</p>
<pre><code># ls -al ubuntu20.04.qcow2
-rw------- 1 root root 10740432896 2020-08-04 20:26:46 ubuntu20.04.qcow2
</code></pre>
<p>Nie udało mi się ustalić z czego wynika ta różnica ale obstawiam nagłówek pliku <code>.qcow2</code> , który
<code>qemu-img</code> bierze pod uwagę i automatycznie dodaje jego rozmiar w kalkulacji wynikowego rozmiaru
obrazu maszyny wirtualnej. Jeśli jednak boimy się, że za bardzo okroimy obraz, czego efektem będzie
uszkodzenie systemu plików maszyny wirtualnej i utrata danych, to dobrze jest zostawić te kilka
dodatkowych MiB. W razie czego systemową partycję maszyny wirtualnej będzie można powiększyć bez
problemu, tak by włączyć w nią te parę MiB wolnej przestrzeni.</p>
<p>Odpalmy teraz maszynę wirtualną, by sprawdzić czy jej system działa w porządku:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/061-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Jak widać, nie mamy już żadnej wolnej przestrzeni, a systemowa partycja kończy się dokładnie na
20973567 sektorze:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/062-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Nie ma przy tym żadnych błędów, zatem proces zmniejszenia rozmiaru dysku maszyny wirtualnej
zakończył się powodzeniem.</p>
<h2 id="jak-zwiększyć-rozmiar-obrazu-maszyny-wirtualnej">Jak zwiększyć rozmiar obrazu maszyny wirtualnej</h2>
<p>W przypadku, gdy nasze oczekiwania w stosunku do przechowywanych danych wewnątrz maszyny wirtualnej
wychodzą poza ramy rozmiaru wirtualnego dysku systemu gościa, to w takiej sytuacji przydałoby się
zwiększyć nieco przestrzeń dyskową oddelegowaną tej maszynie wirtualnej. Podobnie jak w przypadku
zmniejszania rozmiaru obrazu maszyny wirtualnej, tutaj również będziemy wykorzystywać narzędzie
<code>qemu-img</code> .</p>
<p>Załóżmy zatem, że potrzebujemy dodatkowe 15 GiB przestrzeni na pliki. By dodać te 15 GiB do pliku
<code>.qcow2</code> , korzystamy z poniższego polecenia:</p>
<pre><code># qemu-img resize ubuntu20.04-small-comp.qcow2 +15G
Image resized.
</code></pre>
<p>Operacja jest w zasadzie natychmiastowa, choć my nie dostrzeżemy praktycznie żadnej różnicy w
rozmiarze samego pliku <code>.qcow2</code> . Niemniej jednak, po uruchomieniu systemu maszyny wirtualnej i
podejrzeniu dysku w <code>gparted</code> , ta różnica będzie już dość dobrze widoczna:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/081-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Jak widać, te 15 GiB, które dodaliśmy do obrazu, zostały przez maszynę wirtualną uwzględnione, choć
oczywiście póki co partycja systemowa rozciąga się na 10 GiB. By zrobić użytek z tych dodatkowych
GiB, trzeba rozciągnąć tę systemową partycję, tak by obejmowała również i tę wolną przestrzeń.</p>
<p>Do powiększania partycji systemowej obrazu maszyny wirtualnej nie musimy korzystać z systemu live,
tak jak to miało miejsce w przypadku zmniejszania jej rozmiaru. Cały proces można wykonać będąc
zalogowanym w systemie gościa. Zatem rozciągamy partycję główną, tak by zajmowała całą dostępną
wolną przestrzeń:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/082-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Po czym rozpoczynamy proces zwiększenia rozmiaru partycji:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/083-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Jak widać, ten zabieg trwał dosłownie parę sekund.</p>
<p>System też od razu jest w stanie dostrzec nowych rozmiarów partycję systemową bez potrzeby
ponownego uruchomienia maszyny wirtualnej:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/084-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Jeśli teraz rzucimy okiem na rozmiar obrazu maszyny wirtualnej w systemie hosta, to niekoniecznie
musi on zajmować 25 GiB:</p>
<pre><code># qemu-img info ubuntu20.04.qcow2
image: ubuntu20.04.qcow2
file format: qcow2
virtual size: 25 GiB (26844594176 bytes)
disk size: 10 GiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: true
    refcount bits: 16
    corrupt: false
</code></pre>
<p>W tym przypadku, rozmiar pliku <code>.qcow2</code> uległ zwiększeniu jedynie o parę MiB ale to nie jest
ostateczny rozmiar tego pliku, bo zależy on od ilości danych, które będziemy pakować do maszyny
wirtualnej. Im więcej danych znajdzie się w wirtualnym dysku maszyny wirtualnej, tym bardziej jego
rozmiar się rozrośnie, oczywiście w granicach ustawionego limitu. Widoczny wyżej <code>virtual size:</code> to
wirtualny rozmiar dysku, zaś <code>disk size:</code> pokazuje ile ten ten wirtualny dysk zajmuje miejsca na
maszynie hosta w rzeczywistości.</p>
<h2 id="odzyskiwanie-wolnego-miejsca-z-pliku-qcow2">Odzyskiwanie wolnego miejsca z pliku .qcow2</h2>
<p>Jak widzieliśmy wyżej przy zmniejszaniu obrazu maszyny wirtualnej, plik <code>.qcow2</code> na maszynie hosta
zajmował ~10 GiB, mimo, że pliki systemu gościa w rzeczywistości zajmowały mniej miejsca. Możemy tę
wolną przestrzeń również odzyskać. Do tego celu posłużymy się poniższym poleceniem:</p>
<pre><code># qemu-img convert -O qcow2 ubuntu20.04.qcow2 ubuntu20.04-small.qcow2
</code></pre>
<p>Po chwili powinien zostać utworzony drugi, nieco mniejszy obraz:</p>
<pre><code># ls -alh ubuntu20.04*
-rw-r--r-- 1 root root 8.8G 2020-08-04 21:37:06 ubuntu20.04-small.qcow2
-rw------- 1 root root  11G 2020-08-04 20:38:47 ubuntu20.04.qcow2
</code></pre>
<p>Trzeba jednak liczyć się z faktem, że odzyskane w ten sposób GiB będą tracone ilekroć tylko
będziemy coś zapisywać w systemie maszyny wirtualnej. Zatem prędzej czy później ten obraz urośnie
nam do swojego rzeczywistego rozmiaru. Warto jednak pamiętać, że w taki sposób można odchudzić
obraz maszyny wirtualnej, np. po skasowaniu sporej ilości danych z systemu gościa, tak by nie
marnował nam on miejsca w systemie hosta.</p>
<h2 id="kompresja-pliku-qcow2">Kompresja pliku .qcow2</h2>
<p>Jeśli maszyna hosta dysponuje mocniejszym procesorem albo zwyczajnie zależy nam na ograniczeniu
przestrzeni dyskowej, która przeznaczona jest pod obrazy maszyn wirtualnych, to możemy jeszcze
bardziej zmniejszyć rozmiar tych obrazów stosując kompresję (przełącznik <code>-c</code> w <code>qemu-img</code> ),
przykładowo:</p>
<pre><code># qemu-img convert -O qcow2 -c ubuntu20.04.qcow2 ubuntu20.04-small-comp.qcow2
</code></pre>
<p>No i tutaj przy zastosowaniu kompresji udało się zmniejszyć rozmiar obrazu maszyny wirtualnej na
dysku hosta o ponad 50%:</p>
<pre><code># ls -alh ubuntu20.04-small*
-rw-r--r-- 1 root root 4.2G 2020-08-04 21:55:38 ubuntu20.04-small-comp.qcow2
-rw-r--r-- 1 root root 8.8G 2020-08-04 21:37:06 ubuntu20.04-small.qcow2
</code></pre>
<p>Tak utworzony obraz maszyny wirtualnej trzeba teraz podmienić w jej konfiguracji. Można oczywiście
zmienić nazwę pliku ale lepiej jest się pierw upewnić, czy aby na pewno ten okrojony obraz działa
zgodnie z oczekiwaniami. Nie damy rady zmienić obrazu via <code>virt-manager</code> i trzeba w tym celu
edytować plik XML maszyny wirtualnej (via <code>virsh edit ubuntu20.04</code> ):</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/08/063-virtualization-kvm-qemu-system-change-image-qcow2-size.png" alt="virtualization-kvm-qemu-system-change-image-qcow2-size"    class="huge"></p>
<p>Może i udało nam się dość znacznie zaoszczędzić miejsce na dysku stosując kompresję ale trzeba
liczyć się z większym wykorzystaniem procesora -- nie ma nic za free.</p>
<h2 id="defragmentacja-pliku-obrazu">Defragmentacja pliku obrazu</h2>
<p>Po tych zabiegach z utworzeniem obrazu maszyny wirtualnej oraz zmianą jego rozmiaru, dobrze jest
też zdefragmentować sam plik <code>.qcow2</code> w przypadku, gdy w maszynie hosta mamy zainstalowany dysk HDD
(magnetyczny):</p>
<pre><code># filefrag -ve ubuntu20.04-small-comp.qcow2
# e4defrag -v ubuntu20.04-small-comp.qcow2
</code></pre>
<p>Pierwsze z powyższych poleceń sprawdzi stopień fragmentacji pliku i jeśli będzie on duży, to wtedy
korzystamy z drugiego polecenia. By dodatkowo zmniejszyć stopień fragmentacji obrazu maszyny
wirtualnej, dobrze jest to drugie polecenie wydać kilka razy.</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/debian/">Debian</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/wirtualizacja/">Wirtualizacja</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/kvm/">Kvm</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/qemu/">Qemu</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/libvirt/">Libvirt</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&amp;text=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&amp;title=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&amp;title=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&title=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&amp;title=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fjak-zmienic-rozmiar-obrazu-maszyny-wirtualnej-qemu-kvm%2f&description=Jak%20zmieni%c4%87%20rozmiar%20obrazu%20maszyny%20wirtualnej%20QEMU%2fKVM" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-hugepages-pod-maszyny-wirtualne-qemu-kvm/">Konfiguracja HugePages pod maszyny wirtualne QEMU/KVM</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/wirtualizacja-qemu-kvm-libvirt-na-debian-linux/">Wirtualizacja QEMU/KVM (libvirt) na Debian Linux</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/boothole-nie-taki-straszny-o-ile-ma-sie-wlasne-klucze-efi-uefi/">BootHole nie taki straszny, o ile ma się własne klucze EFI/UEFI</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/problem-z-aktualizacja-zmiennych-pk-kek-db-dbx-efi-updatevar/">Problem z aktualizacją zmiennych PK, KEK, db i dbx via efi-updatevar</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/czym-jest-linux-kernel-driver-binding/">Czym jest linux kernel driver binding</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/modul-lkrg-linux-kernel-runtime-guard/">Moduł LKRG (Linux Kernel Runtime Guard)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/pendrive-multiboot-dla-efi-uefi-z-secure-boot/">Pendrive multiboot dla EFI/UEFI z Secure Boot</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script src="https://utteranc.es/client.js"
        repo="morfikov/morfitronik-comments"
        issue-term="og:title"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://mastodon.social/@morfik">
			<svg class="social__icon" aria-label="Mastodon" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M416 197c0-74-49-96-49-96-42-22-172-24-222 0 0 0-49 22-49 96v59c2 72 14 145 81 162 33 9 89 18 140-6l-2-27s-27 7-58 7c-74 2-67-39-70-52 0 0 51 17 137 6 42-6 80-32 85-56 8-38 7-93 7-93zm-58 96h-35v-88c0-18-8-27-23-27-18 0-27 11-27 33v47h-34v-47c0-22-9-33-27-33-15 0-23 9-23 27v88h-35v-91c0-18 5-60 52-60 39 0 50 37 50 37s10-37 50-37c45 0 52 42 52 60v91z"/></svg>
		</a>
</div>
	<div class="footer__copyright">© 2025 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const images = Array.from(document.querySelectorAll(".entry__content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>
</body>
</html>
