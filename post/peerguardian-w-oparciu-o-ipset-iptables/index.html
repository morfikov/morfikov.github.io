<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>PeerGuardian w oparciu o ipset i iptables | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PeerGuardian w oparciu o ipset i iptables" />
<meta property="og:description" content="Wiele klientów torrent&#39;a umożliwia ładowanie zewnętrznej listy z zakresami adresów IP i ta lista ma
służyć jako swego rodzaju filtr połączeń chroniący nas przed różnego rodzaju organizacjami, które
mogą zbierać i przetwarzać informacje na temat naszego IP i tego co on porabia w sieci p2p.
Oczywiście, kwestia czy korzystać z takiego typu rozwiązania jest bardzo dyskusyjna i wiele osób
jest zdania, że to tak naprawdę w niczym nie pomoże, a wręcz nawet przyczynia się do
samounicestwienia sieci p2p. Także taki filter może czasem przynieść więcej szkody niż pożytku,
zwłaszcza gdy się go używa lekkomyślnie, czyli na zasadzie, że ten co blokuje więcej adresów musi
być lepszy. Poniżej opiszę wykorzystanie rozszerzenia ipset, przy pomocy którego zostanie
zablokowany szereg klas adresów. Całość raczej nie skupia się na implementacji filtra, to tylko
przykład do czego ipset może posłużyć, a że ja nie umiem teoretycznie pisać, to muszę na
przykładach." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morfikov.github.io/post/peerguardian-w-oparciu-o-ipset-iptables/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-06-23T22:50:14+00:00" />
<meta property="article:modified_time" content="2015-06-23T22:50:14+00:00" />


		<meta itemprop="name" content="PeerGuardian w oparciu o ipset i iptables">
<meta itemprop="description" content="Wiele klientów torrent&#39;a umożliwia ładowanie zewnętrznej listy z zakresami adresów IP i ta lista ma
służyć jako swego rodzaju filtr połączeń chroniący nas przed różnego rodzaju organizacjami, które
mogą zbierać i przetwarzać informacje na temat naszego IP i tego co on porabia w sieci p2p.
Oczywiście, kwestia czy korzystać z takiego typu rozwiązania jest bardzo dyskusyjna i wiele osób
jest zdania, że to tak naprawdę w niczym nie pomoże, a wręcz nawet przyczynia się do
samounicestwienia sieci p2p. Także taki filter może czasem przynieść więcej szkody niż pożytku,
zwłaszcza gdy się go używa lekkomyślnie, czyli na zasadzie, że ten co blokuje więcej adresów musi
być lepszy. Poniżej opiszę wykorzystanie rozszerzenia ipset, przy pomocy którego zostanie
zablokowany szereg klas adresów. Całość raczej nie skupia się na implementacji filtra, to tylko
przykład do czego ipset może posłużyć, a że ja nie umiem teoretycznie pisać, to muszę na
przykładach."><meta itemprop="datePublished" content="2015-06-23T22:50:14+00:00" />
<meta itemprop="dateModified" content="2015-06-23T22:50:14+00:00" />
<meta itemprop="wordCount" content="1818">
<meta itemprop="keywords" content="iptables,ipset,systemd," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PeerGuardian w oparciu o ipset i iptables"/>
<meta name="twitter:description" content="Wiele klientów torrent&#39;a umożliwia ładowanie zewnętrznej listy z zakresami adresów IP i ta lista ma
służyć jako swego rodzaju filtr połączeń chroniący nas przed różnego rodzaju organizacjami, które
mogą zbierać i przetwarzać informacje na temat naszego IP i tego co on porabia w sieci p2p.
Oczywiście, kwestia czy korzystać z takiego typu rozwiązania jest bardzo dyskusyjna i wiele osób
jest zdania, że to tak naprawdę w niczym nie pomoże, a wręcz nawet przyczynia się do
samounicestwienia sieci p2p. Także taki filter może czasem przynieść więcej szkody niż pożytku,
zwłaszcza gdy się go używa lekkomyślnie, czyli na zasadzie, że ten co blokuje więcej adresów musi
być lepszy. Poniżej opiszę wykorzystanie rozszerzenia ipset, przy pomocy którego zostanie
zablokowany szereg klas adresów. Całość raczej nie skupia się na implementacji filtra, to tylko
przykład do czego ipset może posłużyć, a że ja nie umiem teoretycznie pisać, to muszę na
przykładach."/>

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119125303-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">PeerGuardian w oparciu o ipset i iptables</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2015-06-23T22:50:14Z">Opublikowano: 23/06/2015</time>

<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/linux/" rel="category">Linux</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">PeerGuardian w oparciu o ipset i iptables</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#reguły-dla-ipseta">Reguły dla ipset'a</a>
      <ol>
        <li><a href="#plik-basesh">Plik base.sh</a></li>
        <li><a href="#plik-ipsetsh">Plik ipset.sh</a></li>
        <li><a href="#plik-iptables_rawsh">Plik iptables_raw.sh</a></li>
      </ol>
    </li>
    <li><a href="#praca-dla-crona">Praca dla cron'a</a></li>
    <li><a href="#usługa-dla-systemd">Usługa dla systemd</a></li>
    <li><a href="#niekompatybilny-format-list-ipseta">Niekompatybilny format list ipset'a</a></li>
    <li><a href="#biała-lista">Biała lista</a></li>
    <li><a href="#logowanie-blokowanych-przez-ipset-pakietów">Logowanie blokowanych przez ipset pakietów</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Wiele klientów torrent'a umożliwia ładowanie zewnętrznej listy z zakresami adresów IP i ta lista ma
służyć jako swego rodzaju filtr połączeń chroniący nas przed różnego rodzaju organizacjami, które
mogą zbierać i przetwarzać informacje na temat naszego IP i tego co on porabia w sieci p2p.
Oczywiście, kwestia czy korzystać z takiego typu rozwiązania jest bardzo dyskusyjna i wiele osób
jest zdania, że to tak naprawdę w niczym nie pomoże, a wręcz nawet przyczynia się do
samounicestwienia sieci p2p. Także taki filter może czasem przynieść więcej szkody niż pożytku,
zwłaszcza gdy się go używa lekkomyślnie, czyli na zasadzie, że ten co blokuje więcej adresów musi
być lepszy. Poniżej opiszę wykorzystanie rozszerzenia <code>ipset</code>, przy pomocy którego zostanie
zablokowany szereg klas adresów. Całość raczej nie skupia się na implementacji filtra, to tylko
przykład do czego <code>ipset</code> może posłużyć, a że ja nie umiem teoretycznie pisać, to muszę na
przykładach.</p>
<h2 id="reguły-dla-ipseta">Reguły dla ipset'a</h2>
<p>Standardowo pakietu <code>ipset</code> nie ma wgranego w systemie i trzeba go dociągnąć. Jako, że znajduje się
on w repozytorium debiana, to nie powinno być problemu z jego instalacją. Musimy także stworzyć
katalog, w którym to będziemy trzymać listy z adresami IP. Ja obrałem sobie folder
<code>/etc/peerblock/</code> . Dodatkowo musimy utworzyć osobny folder z konfiguracją dla iptables, np.
<code>/etc/filtr/</code> i od tego katalogu zaczniemy.</p>
<p>Potrzebne nam będą trzy pliki: <code>base.sh</code>, <code>ipset.sh</code> oraz <code>iptables_raw.sh</code> :</p>
<pre><code># cd /etc/filtr/
# touch base.sh ipset.sh iptables_raw.sh
# chmod 700 *
</code></pre>
<h3 id="plik-basesh">Plik base.sh</h3>
<p>W pliku <code>base.sh</code> znajduje się podstawowy filtr dla stacji klienckich. Będzie on aplikowany zawsze
wtedy, gdy będziemy z jakiegoś powodu potrzebowali zdjąć główną zaporę. W ten sposób nie zostaniemy
bez ochrony. Plik ma poniższą postać:</p>
<pre><code>#!/bin/sh

iptables_stop()
{
      ipt=&quot;$(which iptables)&quot;
      ip6t=&quot;$(which ip6tables)&quot;

      $ipt -P INPUT DROP
      $ipt -P FORWARD DROP
      $ipt -P OUTPUT ACCEPT

      $ip6t -P INPUT DROP
      $ip6t -P FORWARD DROP
      $ip6t -P OUTPUT ACCEPT

      for iptable in $ipt $ip6t
      do
            for table in \
                  &quot;-t raw&quot; \
                  &quot;-t mangle&quot; \
                  &quot;-t filter&quot; \
                  &quot;-t nat&quot;
            do
                  $iptable $table -F
                  $iptable $table -X
            done
      done

      $ipt -t filter -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      $ipt -t filter -A INPUT -i lo -j ACCEPT
      $ipt -t filter -A INPUT -m conntrack --ctstate INVALID -j DROP
      $ipt -t filter -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
      $ipt -t filter -A INPUT -p tcp -j REJECT --reject-with tcp-reset
      $ipt -t filter -A INPUT -j REJECT --reject-with icmp-proto-unreachable

      $ip6t -t filter -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      $ip6t -t filter -A INPUT -i lo -j ACCEPT
      $ip6t -t filter -A INPUT -m conntrack --ctstate INVALID -j DROP
      $ip6t -t filter -A INPUT -p tcp -j REJECT --reject-with tcp-reset
      $ip6t -t filter -A INPUT -p udp -j REJECT --reject-with icmp6-port-unreachable
}

ipset_stop()
{
      ips=$(which ipset)
      sets=$($ips -n --list)

      for set in $sets
      do
            name=$($ips list $set 2&gt; /dev/null | head -n 1 | cut -d ' ' -f2)
            if [ &quot;$name&quot; = &quot;$set&quot; ]; then
                  $ips destroy $set 2&gt;&amp;1
            fi
      done
}

iptables_stop
ipset_stop
</code></pre>
<h3 id="plik-ipsetsh">Plik ipset.sh</h3>
<p>Następnie tworzymy plik <code>ipset.sh</code> , który będzie odpowiedzialny za tworzenie list z adresami:</p>
<pre><code>#!/bin/sh

ips=&quot;$(which ipset)&quot;

$ips create bt_level1 hash:net family inet maxelem 270000
$ips create bt_spyware hash:net family inet maxelem 4000
$ips create bt_webexploit hash:net family inet maxelem 2000
$ips create whitelist hash:ip family inet maxelem 500

sets=&quot;$($ips -n --list)&quot;

for set in $sets
do
      cat /etc/peerblock/$set.gz |
      gunzip |
      cut -d: -f2 |
      grep -E &quot;^[-0-9.]+$&quot; |
      gawk -v my_set=$set '{print &quot;add &quot; my_set &quot; &quot; $1}' |
      $ips restore -exist;
done
</code></pre>
<p>Mamy tutaj do obróbki trzy listy, które będziemy pobierać z serwisu <a href="https://www.iblocklist.com/lists.php">iblocklist.com</a>.
Naturalnie, można sobie dobrać jakiekolwiek zestawy.</p>
<h3 id="plik-iptables_rawsh">Plik iptables_raw.sh</h3>
<p>Musimy także utworzyć konfigurację dla filtra <code>iptables</code> . Interesuje nas głównie tablica <code>raw</code> .
Tworzymy plik <code>iptables_raw.sh</code> o poniższej treści:</p>
<pre><code>#!/bin/sh

ipt=&quot;$(which iptables) -t raw&quot;

$ipt -F
$ipt -X

$ipt -N peerblock_in
$ipt -N peerblock_out

$ipt -A PREROUTING -j peerblock_in
$ipt -A OUTPUT -j peerblock_out

$ipt -A peerblock_in -p all -m set --match-set whitelist src -j ACCEPT
$ipt -A peerblock_in -p udp -m multiport ! --sports 80,443 -m set --match-set bt_level1 src -j DROP
$ipt -A peerblock_in -p tcp -m multiport ! --sports 80,443 -m set --match-set bt_level1 src -j DROP
$ipt -A peerblock_in -m set --match-set bt_spyware src -j DROP
$ipt -A peerblock_in -m set --match-set bt_webexploit src -j DROP

$ipt -A peerblock_out -p all -m set --match-set whitelist dst -j ACCEPT
$ipt -A peerblock_out -p tcp -m multiport ! --dports 80,443 -m set --match-set bt_level1 dst -j DROP
$ipt -A peerblock_out -p udp -m multiport ! --dports 80,443 -m set --match-set bt_level1 dst -j DROP
$ipt -A peerblock_out -m set --match-set bt_spyware dst -j DROP
$ipt -A peerblock_out -m set --match-set bt_webexploit dst -j DROP
</code></pre>
<p>Zanim pakiety dotrą do celu, trafiają pierw do tablicy <code>raw</code> i tam można je wstępnie odfiltrować.
Stworzyliśmy tam dwa dodatkowe łańcuchy, po jednym dla pakietów przychodzących i wychodzących.
Kluczowa sprawa to wywołanie modułu przy pomocy parametru <code>-m set</code> i dopasowanie pakietów do
odpowiedniego filtra w ipset przy pomocy <code>--match-set</code>. Ja mam 4 filtry, po 1 regule dla każdego,
w każdym łańcuchu, łącznie daje 8 wpisów. Białą listę dajemy na początek, tak by pakiety, które
zostałyby zablokowane przez przez 3 pozostałe filtry, były przepuszczane bez większego problemu i
wędrowały do tablicy <code>filter</code>. Lista <code>bt_level1</code> jest to typowa lista p2p i generalnie lepiej jest
jej nie używać na portach <code>80</code> i <code>443</code> , czyli na stronach www, bo ona nawet gógla blokuje.
Najlepiej ustawić sobie zakres portów, na których klient bittorrent'a może dokonywać połączeń. U
mnie qbittorrent ma zabronione łączenie się na porty poniżej numeru 1024 i na dobrą sprawę,
ustawiłem mu zakres 2k portów od 20-22k. I praktycznie można by sprecyzować ten zakres w regule
iptables. Pozostałe dwa filtry są już użyte bardziej restrykcyjnie ale to dlatego, że zakresów
adresów IP jest tam relatywnie niewielki i w ciągu dnia trafia mi się tam może 20-30 pakietów.
Różnica w stosunku do tego dużego filtra polega na tym, że te dwa mniejsze filtrują ruch również na
http i https.</p>
<h2 id="praca-dla-crona">Praca dla cron'a</h2>
<p>Co prawda skrypt z filtrem będzie ładowany przy starcie systemu ale on nie pobiera list. Zamiast
tego, ładuje je tylko do ipset'a. Ku temu jest kilka powodów. Pierwszym jest oczywiście spowolnienie
startu systemu. Kolejnym powodem może być brak sieci. Jak nie patrzeć, sieć zostanie dopiero
uruchomiona jak listy zostaną zaaplikowane, czyli muszą już istnieć na dysku. Najlepszym wyjściem w
tej sytuacji jest rozdzielenie kwestii pobierania i aplikowania list. Listy będą aktualizowane co
dzień, dlatego też najlepiej po prostu obarczyć tym zadaniem cron'a i adresy z plików, które on
stworzy, ładować do ipset'a. Tworzymy zatem plik <code>/etc/cron.daily/peerblock_list</code> o poniższej
treści:</p>
<pre><code>#!/bin/bash

#echo &quot;pozyskiwanie listy bt_level1...&quot;
curl --silent --show-error -L &quot;http://list.iblocklist.com/?list=bt_level1&amp;fileformat=p2p&amp;archiveformat=gz&quot; &gt; /etc/peerblock/bt_level1.gz
#echo &quot;pozyskiwanie listy bt_spyware...&quot;
curl --silent --show-error -L &quot;http://list.iblocklist.com/?list=bt_spyware&amp;fileformat=p2p&amp;archiveformat=gz&quot; &gt; /etc/peerblock/bt_spyware.gz
#echo &quot;pozyskiwanie listy bt_webexploit...&quot;
curl --silent --show-error -L &quot;http://list.iblocklist.com/?list=ghlzqtqxnzctvvajwwag&amp;fileformat=p2p&amp;archiveformat=gz&quot; &gt; /etc/peerblock/bt_webexploit.gz
</code></pre>
<p>Ta lista będzie pobierana raz dziennie. Niemniej jednak, potrzebujemy wszystkich z powyższych plików
przed odpaleniem zapory. Dlatego też odpalmy ww. skrypt ręcznie, by pliki zostały pobrane i
umieszczone w odpowiednim miejscu.</p>
<h2 id="usługa-dla-systemd">Usługa dla systemd</h2>
<p>Pozostało nam jeszcze napisanie odpowiedniego pliku usługi dla systemd . Jeśli wcześniej
<a href="https://morfikov.github.io/post/firewall-na-linuxowe-maszyny-klienckie/">zbudowaliśmy sobie firewall</a>, to musimy jedynie dostosować plik
<code>/etc/systemd/system/firewall.service</code> . Jego zawartość powinna być mniej więcej taka:</p>
<pre><code>[Unit]
Description=firewall
Documentation=man:iptables
DefaultDependencies=no
Wants=network-pre.target systemd-modules-load.service
Before=network-pre.target
After=systemd-modules-load.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/sh -c &quot;/etc/filtr/ipset.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_raw.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_mangle.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_nat.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/iptables_filter.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_raw.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_mangle.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_nat.sh&quot;
ExecStart=/bin/sh -c &quot;/etc/filtr/ip6tables_filter.sh&quot;
ExecStop=/bin/sh -c &quot;/etc/filtr/base.sh&quot;

[Install]
WantedBy=multi-user.target
</code></pre>
<p>To w zasadzie tyle pracy z naszej strony. W kilku plikach nie umieszczaliśmy żadnych reguł, a to z
tego względu, że mogą się one różnić w przypadku każdej maszyny.</p>
<p>Trzeba także pamiętać, że ilość wpisów na listach ulega zmianie i może się zdarzyć tak, że limit
ustawiony w zmiennej <code>maxelem</code> w pliku <code>ipset.sh</code> zostanie przekroczony. Gdy taka sytuacja wystąpi,
to wystarczy podbić ten limit. Nie należy jednak z nim przesadzać. Co prawda, przy długości <code>290000</code>
taka lista zajmuje koło 3,5 MiB RAMu. Nie jest to dużo ale jeśli byśmy tam mieli tylko jeden adres,
to ilość okupowanej pamięci nie ulegnie zmianie. To i tak sporo lepiej w porównaniu do qbittorrenta,
który za obsługę tej samej listy chciał ponad 200MiB.</p>
<h2 id="niekompatybilny-format-list-ipseta">Niekompatybilny format list ipset'a</h2>
<p>Format listy nie jest do przyjęcia przez ipset. Wpisy w liście wyglądają jak poniżej:</p>
<pre><code># List distributed by iblocklist.com

China Internet Information Center (CNNIC):1.2.4.0-1.2.4.255
China Internet Information Center (CNNIC):1.2.8.0-1.2.8.255
SMSHoax FakeAV Fraud Trojan:1.9.75.8-1.9.75.8
SMSHoax FakeAV Fraud Trojan:1.9.189.65-1.9.189.65
...
</code></pre>
<p>A trzeba je przerobić do postaci:</p>
<pre><code>add bt_level1 2.115.176.190
add bt_level1 62.52.2.0/26
add bt_level1 212.174.156.0/23
...
</code></pre>
<p>Za to odpowiada plik <code>ipset.sh</code> , a konkretnie ten poniży kod:</p>
<pre><code>for set in $sets
do
      cat /etc/peerblock/$set.gz |
      gunzip |
      cut -d: -f2 |
      grep -E &quot;^[-0-9.]+$&quot; |
      gawk -v my_set=$set '{print &quot;add &quot; my_set &quot; &quot; $1}' |
      $ips restore -exist;
done
</code></pre>
<p>Poniżej wyjaśnienie poszczególnych etapów przetwarzania listy:</p>
<ul>
<li><code>cat /etc/peerblock/$set.gz</code> wczytuje do pamięci plik listy</li>
<li><code>gunzip</code> wypakowuje ten plik</li>
<li><code>cut -d: -f2</code> dzieli linijki po znaku dwukropka i części powstałe w taki sposób oznacza kolejno
1,2, etc. W tym przypadku, jako że linijka ma tylko jeden dwukropek, zostanie podzielona na 2
części oraz zostanie wycięty kawałek od dwukropka do końca wiersza.</li>
<li><code>grep -E &quot;^[-0-9.]+$&quot;</code> nie wiem co dokładnie znaczy ale chyba wyciąga z wyniku wpisy, które mają
cyfry, kropki i znak minusa powtórzone co najmniej raz. Czyli wynik w postaci
<code>62.27.97.232-62.27.97.235</code> . Takie zakresy IP zostaną automatycznie przepisane przez ipset z
uwzględnieniem maski podsieci (patrz <a href="http://manpages.ubuntu.com/manpages/xenial/en/man1/ipcalc.1.html">ipcalc</a>).</li>
<li><code>gawk -v my_set=$set '{print &quot;add &quot; my_set &quot; &quot; $1}'</code> dodaje na początku frazę <code>add bt_level1</code></li>
</ul>
<p>Tak przerobioną listę można bez problemu teraz zaaplikować w ipsecie.</p>
<h2 id="biała-lista">Biała lista</h2>
<p>Ja w powyższy sposób zaimplementowałem sobie 3 listy z adresami IP ale jest jeszcze jedna, którą
warto mieć. Jest to lista z adresami, którym udzielimy dostępu do naszej maszyny. Te filtry mogą i z
pewnością będą blokować sporo adresów, które są niewinne i dlatego przydałoby się mieć już gotowe
rozwiązanie na wypadek gdy ktoś z naszych znajomych trafi na taką listę.</p>
<p>Tworzymy zatem plik <code>/etc/peerblock/whitelist</code> i dodajemy tam adresy w formie <code>91.121.10.104</code> :</p>
<pre><code># cat /etc/peerblock/whitelist
91.121.10.104
</code></pre>
<p>Po edycji, plik kompresujemy programem <code>gzip</code> :</p>
<pre><code># cd /etc/peerblock/
# gzip whitelist
</code></pre>
<h2 id="logowanie-blokowanych-przez-ipset-pakietów">Logowanie blokowanych przez ipset pakietów</h2>
<p>Jeśli pakiety zostaną zablokowane z jakiegoś ip, a my nie wiemy z jakiego. Możemy włączyć logowanie
dodając do regułek iptables do łańcuchów <code>PREROUTING</code> oraz <code>OUTPUT</code> coś na wzór poniższej linijki:</p>
<pre><code>-A OUTPUT -p tcp -m multiport ! --dports 80,443 -m set --match-set bt_level1 dst -j LOG -m limit --limit 10/m  --log-level 4 --log-prefix &quot;*** BT_LEVEL1 *** &quot;
</code></pre>
<p>Oczywiście to tylko przykład logowania, prawdopodobnie trzeba będzie go dostosować. Jedna rzecz o
której trzeba pamiętać to by dodać go przed faktyczną regułą filtrującą, w przeciwnym razie nie
przejdą przez nią pakiety i nie zostaną zalogowane.</p>
<p>I to w sumie wszystko, testowałem tego PeerGuardian'a opartego o ipset i to po prostu działa. Jeśli
kogoś przeraża tego typu działanie, może pokusić się o <a href="https://sourceforge.net/projects/peerguardian/">prawie gotowe rozwiązanie</a>. Wymaga tylko
skompilowania i instalacji. W każdym razie posiada GUI i zjada więcej RAMu niż ipset.</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/iptables/">iptables</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/ipset/">ipset</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/systemd/">systemd</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&amp;text=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&amp;title=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&amp;title=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&title=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&amp;title=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fpeerguardian-w-oparciu-o-ipset-iptables%2f&description=PeerGuardian%20w%20oparciu%20o%20ipset%20i%20iptables" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/firewall-na-linuxowe-maszyny-klienckie/">Firewall na linux&#39;owe maszyny klienckie</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/dnscrypt-proxy-czyli-szyfrowanie-zapytan-dns/">DNScrypt-proxy, czyli szyfrowanie zapytań DNS</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/skryptowa-nakladka-na-kernelowski-modul-zram/">Skryptowa nakładka na kernelowski moduł ZRAM</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script>
  var id =  98 ;

  if (id)
  {
    let url = "https://github.com/morfikov/morfitronik-comments/issues/".concat(id);
    let api_url = "https://api.github.com/repos/morfikov/morfitronik-comments/issues/".concat(id, "/comments");

    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Komentarze dla tego postu nie zostały jeszcze otworzone (albo skrypty GitHub'a są wyłączone). Być może też skończył ci się przydział 60/godzinę (limit GitHub'a).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h3");
        mainHeader.innerHTML = "Komentarze: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>Możesz zostawić komentarz korzystając z <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);

        comments.forEach(function(comment)
        {
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Europe/Warsaw' };
			options.timeZoneName = 'short';
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " | <em>", (new Date(comment.created_at)).toLocaleTimeString('pl-PL', options), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Wystąpił jakiś błąd przy ładowaniu komentarzy.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/mikhailmorfikov">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
</div>
	<div class="footer__copyright">© 2022 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const images = Array.from(document.querySelectorAll(".entry__content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>
</body>
</html>
