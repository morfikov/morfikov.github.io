<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Instalacja i konfiguracja AdGuard na routerze z OpenWRT | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Instalacja i konfiguracja AdGuard na routerze z OpenWRT" />
<meta property="og:description" content="Jakiś już czas temu opisywałem w jaki sposób skonfigurować AdBlock&#39;a na routerze WiFi z wgranym
firmware OpenWRT oraz jak wdrożyć szyfrowanie zapytań DNS w oparciu o dnscrypt-proxy dla
wszystkich klientów naszej sieci domowej. Zarówno AdBlock jak i dnscrypt-proxy można w dalszym
ciągu wykorzystywać, zwłaszcza na routerach wyposażonych w niewielkich rozmiarów flash i mało
pamięci RAM. Niemniej jednak, nie każdy lubi konfigurować swój bezprzewodowy router za
pośrednictwem terminala. Dla takich osób powstał właśnie AdGuard Home, który ma na celu
możliwie uprościć konfigurację routera, przynajmniej jeśli chodzi o rzeczy związane z protokołem
DNS. W tym artykule przyjrzymy się nieco bliżej AdGuard&#39;owi i zobaczymy czy można z niego zrobić
jakiś większy użytek." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morfikov.github.io/post/instalacja-konfiguracja-adguard-na-routerze-z-openwrt/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-12T21:03:00+00:00" />
<meta property="article:modified_time" content="2020-05-30T15:03:00+02:00" />


		<meta itemprop="name" content="Instalacja i konfiguracja AdGuard na routerze z OpenWRT">
<meta itemprop="description" content="Jakiś już czas temu opisywałem w jaki sposób skonfigurować AdBlock&#39;a na routerze WiFi z wgranym
firmware OpenWRT oraz jak wdrożyć szyfrowanie zapytań DNS w oparciu o dnscrypt-proxy dla
wszystkich klientów naszej sieci domowej. Zarówno AdBlock jak i dnscrypt-proxy można w dalszym
ciągu wykorzystywać, zwłaszcza na routerach wyposażonych w niewielkich rozmiarów flash i mało
pamięci RAM. Niemniej jednak, nie każdy lubi konfigurować swój bezprzewodowy router za
pośrednictwem terminala. Dla takich osób powstał właśnie AdGuard Home, który ma na celu
możliwie uprościć konfigurację routera, przynajmniej jeśli chodzi o rzeczy związane z protokołem
DNS. W tym artykule przyjrzymy się nieco bliżej AdGuard&#39;owi i zobaczymy czy można z niego zrobić
jakiś większy użytek."><meta itemprop="datePublished" content="2020-05-12T21:03:00+00:00" />
<meta itemprop="dateModified" content="2020-05-30T15:03:00+02:00" />
<meta itemprop="wordCount" content="5152">
<meta itemprop="keywords" content="router,tp-link,adblock,dns,adguard," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Instalacja i konfiguracja AdGuard na routerze z OpenWRT"/>
<meta name="twitter:description" content="Jakiś już czas temu opisywałem w jaki sposób skonfigurować AdBlock&#39;a na routerze WiFi z wgranym
firmware OpenWRT oraz jak wdrożyć szyfrowanie zapytań DNS w oparciu o dnscrypt-proxy dla
wszystkich klientów naszej sieci domowej. Zarówno AdBlock jak i dnscrypt-proxy można w dalszym
ciągu wykorzystywać, zwłaszcza na routerach wyposażonych w niewielkich rozmiarów flash i mało
pamięci RAM. Niemniej jednak, nie każdy lubi konfigurować swój bezprzewodowy router za
pośrednictwem terminala. Dla takich osób powstał właśnie AdGuard Home, który ma na celu
możliwie uprościć konfigurację routera, przynajmniej jeśli chodzi o rzeczy związane z protokołem
DNS. W tym artykule przyjrzymy się nieco bliżej AdGuard&#39;owi i zobaczymy czy można z niego zrobić
jakiś większy użytek."/>

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119125303-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Instalacja i konfiguracja AdGuard na routerze z OpenWRT</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2020-05-12T21:03:00Z">Opublikowano: 12/05/2020</time>
	<time class="entry__meta-lastmod meta-lastmod" datetime="2020-05-30T15:03:00&#43;02:00">Zaktualizowano: 30/05/2020</time>

<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/openwrt/" rel="category">OpenWRT</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Instalacja i konfiguracja AdGuard na routerze z OpenWRT</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#instalacja-adguard-na-routerze">Instalacja AdGuard na routerze</a></li>
    <li><a href="#wstępna-konfiguracja-adguard">Wstępna konfiguracja AdGuard</a></li>
    <li><a href="#konfiguracja-routera-na-potrzeby-adguard">Konfiguracja routera na potrzeby AdGuard</a>
      <ol>
        <li><a href="#autostart">Autostart</a></li>
      </ol>
    </li>
    <li><a href="#zaawansowana-konfiguracja-adguard">Zaawansowana konfiguracja AdGuard</a>
      <ol>
        <li><a href="#dodatkowe-filtry-domen-znane-z-adblocka">Dodatkowe filtry domen znane z AdBlock'a</a>
          <ol>
            <li><a href="#logowanie-domen">Logowanie domen</a></li>
          </ol>
        </li>
        <li><a href="#klienci-adguard">Klienci AdGuard</a></li>
        <li><a href="#szyfrowanie-dns-doh-dot-dnscrypt">Szyfrowanie DNS (DoH, DoT, DNScrypt)</a>
          <ol>
            <li><a href="#czym-są-serwery-bootstrap-dns">Czym są serwery Bootstrap DNS</a></li>
          </ol>
        </li>
        <li><a href="#wymuszenie-safe-search-w-wyszukiwarkach">Wymuszenie Safe Search w wyszukiwarkach</a></li>
        <li><a href="#usługa-adguard-browsing-security">Usługa AdGuard Browsing Security</a></li>
        <li><a href="#blokada-serwisów-społecznościowych">Blokada serwisów społecznościowych</a></li>
        <li><a href="#blokada-serwisów-pornograficznych">Blokada serwisów pornograficznych</a></li>
        <li><a href="#wymuszenie-korzystania-z-adguard">Wymuszenie korzystania z AdGuard</a>
          <ol>
            <li><a href="#a-co-jeśli-klient-korzysta-z-doh-dot-lub-dnscrypt-bezpośrednio">A co jeśli klient korzysta z DoH, DoT lub DNScrypt bezpośrednio</a></li>
          </ol>
        </li>
        <li><a href="#panel-adguard-po-https-i-serwer-dot-dla-sieci-lokalnej">Panel AdGuard po HTTPS i serwer DoT dla sieci lokalnej</a></li>
      </ol>
    </li>
    <li><a href="#integracja-adguard-home-z-openwrt">Integracja AdGuard Home z OpenWRT</a></li>
    <li><a href="#problemy-z-adguard">Problemy z AdGuard</a>
      <ol>
        <li><a href="#nie-wszystkie-reklamy-są-blokowane">Nie wszystkie reklamy są blokowane</a></li>
        <li><a href="#protokół-ipv6">Protokół IPv6</a></li>
        <li><a href="#couldnt-initialize-dns-server-couldnt-initialize-statistics-module">Couldn't initialize DNS server: Couldn't initialize statistics module</a></li>
        <li><a href="#libustream-mbedtls-vs-libustream-openssl">libustream-mbedtls vs. libustream-openssl</a></li>
        <li><a href="#x509-certificate-signed-by-unknown-authority">x509: certificate signed by unknown authority</a></li>
      </ol>
    </li>
    <li><a href="#podsumowanie">Podsumowanie</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Jakiś już czas temu opisywałem w jaki sposób <a href="https://morfikov.github.io/post/blokowanie-reklam-adblock-na-domowym-routerze-wifi/">skonfigurować AdBlock'a na routerze WiFi z wgranym
firmware OpenWRT</a> oraz jak wdrożyć <a href="https://morfikov.github.io/post/konfiguracja-dnscrypt-proxy-w-openwrt/">szyfrowanie zapytań DNS w oparciu o dnscrypt-proxy dla
wszystkich klientów naszej sieci domowej</a>. Zarówno AdBlock jak i dnscrypt-proxy można w dalszym
ciągu wykorzystywać, zwłaszcza na routerach wyposażonych w niewielkich rozmiarów flash i mało
pamięci RAM. Niemniej jednak, nie każdy lubi konfigurować swój bezprzewodowy router za
pośrednictwem terminala. Dla takich osób powstał właśnie <a href="https://github.com/AdguardTeam/AdGuardHome#comparison">AdGuard Home</a>, który ma na celu
możliwie uprościć konfigurację routera, przynajmniej jeśli chodzi o rzeczy związane z protokołem
DNS. W tym artykule przyjrzymy się nieco bliżej AdGuard'owi i zobaczymy czy można z niego zrobić
jakiś większy użytek.</p>
<h2 id="instalacja-adguard-na-routerze">Instalacja AdGuard na routerze</h2>
<p>W OpenWRT jak na razie nie ma stosownego pakietu, który by zawierał AdGuard -- trzeba będzie
go zatem pozyskać i zainstalować ręcznie. <a href="https://github.com/AdguardTeam/AdGuardHome/releases">Stosowny pakiet można pobrać z github'a</a>, trzeba
tylko wybrać odpowiedni plik. W przypadku routerów OpenWRT interesować nas będzie plik mający w
nazwie <code>AdGuardHome_linux_</code> , tylko który, bo jest ich tam kilka. Najprościej będzie zalogować się
na router przy pomocy SSH, podejrzeć plik <code>/proc/cpuinfo</code> i sprawdzić co tam widnieje przy pozycji
<code>cpu model</code> lub <code>model name</code> . Można także skorzystać z polecenia <code>uname -m</code> :</p>
<p>Poniżej przykład z routera Archer C7 v2:</p>
<pre><code># cat /proc/cpuinfo
...
cpu model               : MIPS 74Kc V5.0
...

# uname -m
mips
</code></pre>
<p>A niżej z routera Archer C2600:</p>
<pre><code># cat /proc/cpuinfo
...
model name      : ARMv7 Processor rev 0 (v7l)
...

# uname -m
armv7l
</code></pre>
<p>No jak widać, routery Archer C7 v2 i Archer C2600 mają inne architektury CPU i trzeba będzie dla
każdego z nich pobrać inny pakiet. W tym przypadku będzie wykorzystywany router Archer C2600 i dla
niego trzeba pobrać plik <code>AdGuardHome_linux_arm.tar.gz</code> . Pobraną paczkę <code>.tar.gz</code> przenosimy na
router przy pomocy <code>scp</code> do katalogu <code>/tmp/</code> i wypakowujemy do katalogu <code>/opt/</code> :</p>
<pre><code>$ scp AdGuardHome_linux_*.tar.gz 192.168.1.1:/tmp

root@RedViper:~# mkdir /opt
root@RedViper:~# tar zxf /tmp/AdGuardHome_linux_*.tar.gz  -C /opt
</code></pre>
<p>Binarka <code>AdGuardHome</code> swoje waży:</p>
<pre><code># ls -alh /opt/AdGuardHome/AdGuardHome
-rwxr-xr-x    1 root     root       12.4M Mar 13 10:32 /opt/AdGuardHome/AdGuardHome
</code></pre>
<p>Oczywiście, te widoczne wyżej 12,4M to rozmiar nieskompresowany i ta binarka będzie zajmować trochę
mniej miejsca na flash'u routera. Ze wstępnych ustaleń wynika, że potrzebnych jest około 6,3M na
flash, by tę binarkę <code>AdGuardHome</code> zmieścić na router, więc potrzebne będzie urządzenie dysponujące
flash'em o pojemności co najmniej 16M, ewentualnie można też posłużyć się <a href="https://morfikov.github.io/post/extroot-whole_root-fullroot-pod-openwrt/">mechanizmem extroot</a>.</p>
<h2 id="wstępna-konfiguracja-adguard">Wstępna konfiguracja AdGuard</h2>
<p>Mając wgraną binarkę <code>AdGuardHome</code> na routerze, możemy przejść do uruchomienia tej aplikacji. W tym
celu wystarczy przejść do katalogu <code>/opt/AdGuardHome/</code> i uruchomić plik <code>AdGuardHome</code> :</p>
<pre><code># cd /opt/AdGuardHome/
# ./AdGuardHome
2020/04/30 10:57:00 [error] Couldn't read config file /opt/AdGuardHome/AdGuardHome.yaml: open /opt/AdGuardHome/AdGuardHome.yaml: no such file or directory
2020/04/30 10:57:00 [info] AdGuard Home, version v0.101.0, channel release
, arch linux mips%!(EXTRA string=)
2020/04/30 10:57:00 [info] This is the first launch of AdGuard Home, redirecting everything to /install.html
2020/04/30 10:57:00 [info] AdGuard Home is available on the following addresses:
2020/04/30 10:57:00 [info] Go to http://127.0.0.1:3000
2020/04/30 10:57:00 [info] Go to http://10.217.228.189:3000
2020/04/30 10:57:00 [info] Go to http://192.168.1.1:3000
</code></pre>
<p>Wyżej mamy informację, że jest to pierwsze uruchomienie AdGuard oraz, że musimy udać się pod jeden
z wypisanych adresów URL. Mamy co prawda trzy adresy ale nas interesuje ten, który ma adres IP
192.168.1.1, bo to z nim jesteśmy w stanie się połączyć będąc w naszej sieci domowej. Odpalamy
zatem przeglądarkę internetową i w pasku adresu wpisujemy adres <code>http://192.168.1.1:3000</code> . Naszym
oczom powinna pokazać się strona podobna do tej poniżej:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/001-adguard-home-openwrt-router-config.png" alt=""    class="huge"></p>
<p>Klikamy oczywiście w ten zielony przycisk i przechodzimy do wstępnej konfiguracji AdGuard. Na sam
początek musimy określić interfejs/adres IP oraz port, na którym będzie nasłuchiwał panel
administracyjny. Zwykle powinniśmy wybrać tutaj interfejs <code>br-lan</code> i określić port <code>80</code> ale w
przypadku mojego routera, na tym porcie nasłuchuje już panel LuCI i trzeba w takiej sytuacji wybrać
inny port, np. <code>8080</code> . Podobnie musimy określić adres i port dla serwera DNS. W tym przypadku
również wskazujemy interfejs <code>br-lan</code> ale z racji, że na domyślnym porcie <code>53</code> nasłuchuje już
<code>dnsmasq</code> , to musimy określić inny port, powiedzmy <code>5353</code> . Cała konfiguracja powinna zatem
wyglądać mniej więcej tak jak na poniższym obrazku:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/002-adguard-home-openwrt-router-config-ip-ports.png" alt=""    class="huge"></p>
<p>Następnie określamy login i hasło, którego będziemy używać przy logowaniu się do panela AdGuard:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/003-adguard-home-openwrt-router-config-user.png" alt=""    class="huge"></p>
<p>Dalej mamy szereg informacji dotyczących konfiguracji poszczególnych urządzeń, tak by
współpracowały one bez problemu z AdGuard:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/004-adguard-home-openwrt-router-config-device.png" alt=""    class="huge"></p>
<p>I to w zasadzie wszystko. Możemy teraz przejść do panelu konfiguracyjnego:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/005-adguard-home-openwrt-router-config-done.png" alt=""    class="huge"></p>
<p>Podajemy login i hasło, które ustawiliśmy wcześniej:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/006-adguard-home-openwrt-router-login.png" alt=""    class="medium"></p>
<p>Po podaniu poprawnych danych logowania powinniśmy zobaczyć miły dla oka panel administracyjny
AdGuard:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/007-adguard-home-openwrt-router-panel.png" alt=""    class="huge"></p>
<h2 id="konfiguracja-routera-na-potrzeby-adguard">Konfiguracja routera na potrzeby AdGuard</h2>
<p>Oczywiście samo wgranie AdGuard na router i jego uruchomienie nie sprawi, że będzie on realizował
swoje zadania, do których został zaprojektowany. Musimy jeszcze odpowiednio skonfigurować sam
router z OpenWRT. Standardowo w OpenWRT rozwiązywaniem nazw domen zajmuje się <code>dnsmasq</code> i to on
nasłuchuje na porcie 53. Klienty naszej sieci lokalnej w lease DHCP otrzymują namiar na serwer DNS
routera i to właśnie do <code>dnsmasq</code> lecą wszystkie zapytania o domeny, które później są przesyłane do
upstream'owego serwera DNS. W ten cały proces trzeba uwikłać teraz AdGuard, tj. tak skonfigurować
<code>dnsmasq</code> by przesłać odebrane z sieci zapytania DNS do AdGuard.</p>
<p>Pierwszy z plików, na który musimy rzucić okiem to <code>/etc/config/network</code> . W tym pliku przy
sekcjach z interfejsami WAN trzeba przy pomocy opcji <code>peerdns</code> wyłączyć branie pod uwagę serwerów
DNS jakie router uzyskuje od ISP w lease DHCP. Dodatkowo, trzeba za sprawą <code>list dns</code> określić
jakiś adres serwera DNS, bo w przeciwnym wypadku nie będzie działać nam rozwiązywanie domen. Musi
to być adres, na którym nasłuchuje <code>dnsmasq</code> , czyli 127.0.0.1 :</p>
<pre><code>config interface 'wan'
    ...
    option peerdns '0'
    list dns '127.0.0.1'
    ...

config interface 'wan6'
    ...
    option peerdns '0'
    list dns '127.0.0.1'
    ...
</code></pre>
<p>Zatem każde zapytanie o domeny, które by wyszło przez jeden z tych powyższych interfejsów
sieciowych, zostanie skierowane do <code>dnsmasq</code> . Jako, że AdGuard ma pośredniczyć w rozwiązywaniu
nazw domen, to trzeba w pliku <code>/etc/config/dhcp</code> określić adres IP oraz port, na którym nasłuchuje
AdGuard, w tym przypadku adres to <code>192.168.1.1</code> , a port to <code>5353</code> :</p>
<pre><code>config dnsmasq
    ...
    option noresolv '1'
    list server '192.168.1.1#5353'
    ...
</code></pre>
<p>Opcja <code>noresolv</code> sprawia, że zapytania DNS będą przesyłane jedynie na adres określony w
<code>list server</code> tj. plik <code>/tmp/resolv.conf.auto</code> nie będzie brany w naszym przypadku pod uwagę.</p>
<p>Po zresetowaniu połączenia sieciowego, AdGuard powinien zacząć łapać zapytania DNS, co możemy
potwierdzić zaglądając do panelu admina:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/008-adguard-home-openwrt-router-panel-stats.png" alt=""    class="huge"></p>
<h3 id="autostart">Autostart</h3>
<p>Domyślnie AdGuard nie instaluje żadnej usługi, która by umożliwiła mu uruchomienie się wraz ze
startem routera. Trzeba zatem ręcznie dodać stosowny wpis. Najlepiej jest zatem do pliku
<code>/etc/rc.local</code> dodać poniższą linijkę tuż przed <code>exit 0</code> :</p>
<pre><code>(/opt/AdGuardHome/AdGuardHome --work-dir /tmp/data --config /opt/AdGuardHome/AdGuardHome.yaml &gt; /tmp/adguard.log 2&gt;&amp;1) &amp;
</code></pre>
<p>Wszelkie komunikaty, które AdGuard będzie chciał zapisać, powędrują do pliku <code>/tmp/adguard.log</code> i
to tam powinniśmy szukać przyczyn ewentualnych problemów.</p>
<h2 id="zaawansowana-konfiguracja-adguard">Zaawansowana konfiguracja AdGuard</h2>
<p>W zasadzie AdGuard powinien nam już działać, tj. filtrować zapytania DNS w oparciu o <a href="https://github.com/AdguardTeam/AdguardSDNSFilter">filtr AdGuard
Simplified Domain Names filter</a>, i większości użytkownikom tego typu rozwiązanie powinno w
zupełności wystarczyć. Niemniej jednak, przydałoby się nieco bliżej przyjrzeć konfiguracji AdGuard,
bo jest tam parę ciekawych rzeczy, które przydałoby się obadać.</p>
<h3 id="dodatkowe-filtry-domen-znane-z-adblocka">Dodatkowe filtry domen znane z AdBlock'a</h3>
<p>Użytkownicy, którzy korzystali lub w dalszym ciągu korzystają z AdBlock'a dla OpenWRT, mieli
możliwość wyboru spośród kilku predefiniowanych list z domenami, w tym także mogli dodać własne
listy. Natomiast standardowo w AdGuard jest dostępna tylko jedna lista, tj. ten AdGuard Simplified
Domain Names filter. Nic jednak nie stoi na przeszkodzie by dodać sobie inne listy, w tym te, z
którymi mieliśmy do czynienia w przypadku AdBlock. By dodać listy domen, wystarczy przejść pod
Filters =&gt; DNS blocklists i tam dodać to co komu się podoba:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/009-adguard-home-openwrt-router-adblock-lists.png" alt=""    class="huge"></p>
<p>Listy z AdBlock'a są w pełni kompatybilne z AdGuard i można ich bez problemu używać. Ja zwykle
korzystam z tych poniższych:</p>
<pre><code>https://adaway.org/hosts.txt
https://www.malwaredomainlist.com/hostslist/hosts.txt
https://pgl.yoyo.org/adservers/serverlist.php?hostformat=nohtml&amp;showintro=0&amp;mimetype=plaintext'
https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt
http://adblocklist.org/adblock-pxf-polish.txt
</code></pre>
<h4 id="logowanie-domen">Logowanie domen</h4>
<p>Każda domena odwiedzana przez użytkowników naszej sieci domowej może być zalogowana. Taki log
naturalnie może posłużyć do inwigilacji członków naszej rodziny ale też w przypadku problemów z
internetem możemy zawsze zajrzeć w taki log domen i sprawdzić, które zapytania zostały zablokowane
lub przepuszczone. Można przy pomocy tego logu poprawić jakość samego AdBlock'a. Poniżej znajduje
się przykład logu:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/010-adguard-home-openwrt-router-domain-log-block.png" alt=""    class="huge"></p>
<p>Jak widać wyżej, mamy również informację na temat listy, która zablokowała konkretne zapytanie o
domenę, co jest bardzo użyteczne w przypadku, gdy tych list mamy całkiem sporo.</p>
<p>Wszystkie zablokowane przez nas adresy są dodawane na listę, która znajduje się pod Filters =&gt;
Custom filtering rules:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/011-adguard-home-openwrt-router-custom-log-rules.png" alt=""    class="huge"></p>
<p>Wpisy mające na początku <code>@@</code> oznaczają odblokowaną domenę.</p>
<p>Na powyższą listę możemy dodawać wpisy zarówno w formacie jaki występuje w regułach AdBlock'a, jak
i tym znanych z pliku <code>/etc/hosts</code> .</p>
<p>Zmiany w konfiguracji list są natychmiastowe i nie trzeba restartować AdGuard'a czy routera.</p>
<h3 id="klienci-adguard">Klienci AdGuard</h3>
<p>AdGuard dla każdego klienta, który przesyła do niego zapytania DNS, jest w stanie utrzymywać osobną
konfigurację. Dla przykładu weźmy sobie upstream'owe serwery DNS, do których zapytania o domeny
będą forwardowane. Możliwe jest stworzenie konfiguracji takiej, że dla pewnych maszyn w sieci
będzie wykorzystywany jeden serwer DNS, a dla pozostałych komputerów inny serwer.</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/012-adguard-home-openwrt-router-clients.png" alt=""    class="huge"></p>
<p>W ten sposób możemy swoim pracownikom w firmie założyć blokadę na porno bez pozbawiania siebie
dostępu do tego typu serwisów. To oczywiście tylko jeden z przykładów, a tych naturalnie może być
więcej.</p>
<p>Niemniej jednak, w takiej konfiguracji jaką stworzyliśmy, jedynym klientem, który będzie przesyłał
zapytania DNS do AdGuard, jest nasz router, a konkretnie <code>dnsmasq</code> . Dlatego też w sekcji
<code>Top clients</code> będziemy zawsze widzieć jedno urządzenie, a nie wszystkie te maszyny, które aktywnie
korzystają z sieci.</p>
<p>Router w lease DHCP domyślnie rozsyła adres DNS jako swój, tj <code>192.168.1.1</code> . Do tego, protokół DNS
korzysta standardowo z portu 53. Dlatego też by mieć statystyki DNS per klient sieci LAN trzeba by
zamienić <code>dnsmasq</code> z AdGuard, tak by to ten drugi nasłuchiwał zapytań DNS na porcie 53 zamiast 5353
(tak jak to zostało w konfiguracji określone).</p>
<p>Niemniej jednak, jeśli chodzi o maszyny z linux'em na pokładzie, to w dalszym ciągu możemy bez
problemu te zapytania DNS przesłać bezpośrednio do AdGuard na adres 192.168.1.1 i port 5353. Nie
możemy przy tym korzystać z pliku <code>/etc/resolv.conf</code> , bo w tym pliku nie ma możliwości określenia
portu (przynajmniej <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=549190">nie da się tego zrobić póki co na Debianie</a>). Natomiast zawsze można
postawić sobie <a href="https://morfikov.github.io/post/cache-dns-buforowania-zapytan/">lokalny cache DNS w oparciu o dnsmasq</a> i w konfiguracji <code>dnsmasq</code> na linux
określić adres IP upstream'owego serwera DNS na 192.168.1.1 oraz port 5353. W takim przypadku bez
większego problemu nasz router domowy rozróżni ruch DNS od poszczególnych klientów:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/013-adguard-home-openwrt-router-clients.png" alt=""    class="huge"></p>
<p>Oczywiście konfigurowanie wielu stacji w ten sposób mija się z celem i lepszym rozwiązaniem będzie
jednak zastąpienie <code>dnsmasq</code> na routerze przez AdGuard, przynajmniej jeśli chodzi o kwestię DNS, bo
<code>dnsmasq</code> robi także za serwer DHCP. Niby AdGuard posiada także serwer DHCP ale jest on póki co
oznaczony jako eksperymentalny i lepiej na nim aż tak nie polegać, przynajmniej jeszcze przez jakiś
czas.</p>
<h3 id="szyfrowanie-dns-doh-dot-dnscrypt">Szyfrowanie DNS (DoH, DoT, DNScrypt)</h3>
<p>AdGuard zapewnia wsparcie dla szyfrowania ruchu DNS z wykorzystaniem <a href="https://en.wikipedia.org/wiki/DNS_over_HTTPS">DoH</a>, <a href="https://en.wikipedia.org/wiki/DNS_over_TLS">DoT</a>, a nawet
<a href="https://dnscrypt.info/">DNScrypt</a>. To bardzo dobra wiadomość, bo w zasadzie użytkownik nie musi nic robić, by mieć
domyślnie szyfrowany DNS i to od razu dla całej swojej sieci domowej. <a href="https://www.cloudflare.com/learning/dns/dns-over-tls/">O różnicach między DoH i DoT
można poczytać tutaj</a>.</p>
<p>Pytanie jakie wypadałoby tutaj zadać dotyczy serwera DNS, do którego te zapytania są przesyłane.
Domyślnie jest to <a href="https://www.quad9.net/">Quad9</a> ale nic nie stoi na przeszkodzie, by ten serwer zmienić i ustawić
sobie jakiś inny, który wspiera szyfrowane zapytania DNS, poniżej przykład:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/014-adguard-home-openwrt-router-upstream-dns-servers-doh-dot.png" alt=""    class="huge"></p>
<p>Powyżej został ustawiony serwer CloudFlare, zarówno dla protokołu DoH (ten z <code>https://</code> ), jak i
DoT (ten z <code>tls://</code>). By sprawdzić czy rozwiązywanie nazw DNS przez AdGuard faktycznie leci do
serwerów CloudFlare i odbywa się przy pomocy jednego z tych protokołów, wystarczy
<a href="https://1.1.1.1/help">odwiedzić ten adres</a> i zrobić prosty test:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/015-adguard-home-openwrt-router-doh-dot-test.png" alt=""    class="big"></p>
<p>Wynik, jak widać, mówi raczej sam za siebie.</p>
<p>Możemy naturalnie określić tyle serwerów DNS ile tylko chcemy. Podobnie jest z protokołami. <a href="https://kb.adguard.com/en/general/dns-providers">Pełna
lista serwerów DNS, które możemy wykorzystać w AdGuard</a>, jest dostępna tutaj.</p>
<p>W przypadku określenia więcej niż jeden serwer DNS, możemy rozłożyć zapytania tak, by cześć z nich
trafiła do jednego serwera, a część do drugiego i kolejnych. Takie podejście może przyśpieszyć cały
proces rozwiązywania nazw domen.</p>
<h4 id="czym-są-serwery-bootstrap-dns">Czym są serwery Bootstrap DNS</h4>
<p>Serwer Bootstrap DNS, to taki serwer, który wykorzystywany jest do rozwiązania domeny serwera DNS
określonego w konfiguracji AdGuard. Przykładowo, jeśli zdefiniowaliśmy upstream'owy serwer DNS jako
<code>https://cloudflare-dns.com/dns-query</code> , to mamy tutaj domenę. Ta domena nie jest znana routerowi,
np. po restarcie maszyny, i trzeba ją rozwiązać ale nie możemy tego zrobić przy pomocy
skonfigurowanego protokołu DoH, bo on zwyczajnie jeszcze nie działa. Dlatego właśnie na czas
rozwiązywania domeny ustawionego przez nas upstream'owego serwera DNS wykorzystywany jest jeden z
serwerów Bootstrap DNS, przez który to zapytanie o tę powyższą domenę (i tylko o nią) powędruje
przez sieć w formie niezaszyfrowanej. Jak tylko uda się rozwiązać domenę dla upstream'owego serwera
DNS, to każde zapytanie o zwykłe domeny stron WWW będzie już realizowane za sprawą protokołu DoH.</p>
<p>By skorzystać z CloudFlare i ustawić jego serwer DNS jako Bootstrap DNS, wystarczy wpisać <code>1.1.1.1</code>
w Bootstrap DNS servers (pod Settings =› DNS Settings):</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/016-adguard-home-openwrt-router-bootsrap-dns.png" alt=""    class="huge"></p>
<p>Gdy już skończymy się bawić ustawieniami upstream'owych serwerów DNS, warto jest przetestować ich
konfigurację klikając w przycisk <code>Test upstreams</code> widoczny powyżej. Jeśli konfiguracja jest
prawidłowa, to zostaniemy o tym fakcie powiadomieni.</p>
<p>Te serwery Bootstrap DNS są wykorzystywane jedynie w momencie określenia upstream'owych serwerów
DNS z wykorzystaniem domeny, tj. wspomniany wyżej <code>https://cloudflare-dns.com/dns-query</code> . Jeśli
zamiast domeny zostanie wykorzystany adres IP, przykładowo:</p>
<pre><code>https://1.1.1.1/dns-query
https://1.0.0.1/dns-query
</code></pre>
<p>to w takim przypadku serwery Bootstrap DNS nie będą w ogóle wykorzystywane, co może pomóc w  walce
z ewentualną cenzurą przez zablokowanie ruchu do serwerów Bootstrap DNS.</p>
<p>Warto tutaj też zaznaczyć, że żadne inne zapytanie DNS nie zostanie przesłane za pomocą tych
serwerów Bootstrap DNS. W przypadku, gdyby jakieś zapytanie DNS się pojawiło przed rozwiązaniem
domeny upstream'owych serwerów DNS, to jego rozwiązanie zostanie opóźnione do momentu
skonfigurowania przez AdGuard tych upstream'owych serwerów DNS.</p>
<h3 id="wymuszenie-safe-search-w-wyszukiwarkach">Wymuszenie Safe Search w wyszukiwarkach</h3>
<p>Wyszukiwarki takie jak Google, YouTube, Bing, DuckDuckGo, Yandex czy Pixabay mają do siebie to, że
potrafią zwracać czasami w wynikach treści rozumiane szeroko jako nieodpowiednie, np.
pornograficzne. Dlatego też każda z tych większych wyszukiwarek ma zaimplementowany <a href="https://support.google.com/websearch/answer/510">filtr Safe
Search</a>, który ma za zadanie odfiltrować tego typu zwartość w wynikach wyszukiwania. Niemniej
jednak, użytkownik ten filtr Safe Search może sobie wyłączyć i dalej być w stanie uzyskać dostęp to
tego typu materiałów dla dorosłych.</p>
<p>AdGuard posiada opcję wymuszenia Safe Search w wyszukiwarkach. W przypadku, gdy ta opcja zostanie
aktywowana, to użytkownik nie będzie w stanie w ustawieniach któregoś z tych ww. serwisów zmienić
opcji odpowiedzialnych za filtr Safe Search. No może i będzie w stanie zmienić ustawienia ale
zostaną one przepisane przez AdGuard.</p>
<h3 id="usługa-adguard-browsing-security">Usługa AdGuard Browsing Security</h3>
<p><a href="https://kb.adguard.com/en/general/how-malware-protection-works">Usługa AdGuard Browsing Security</a> jest to mechanizm, który ma na celu odfiltrowanie z sieci
stron phishing'owych oraz tych, których odwiedzenie może skończyć się zawirusowaniem naszego
komputera. Dokładny <a href="https://github.com/AdguardTeam/AdguardForAndroid/issues/162">opis jak działa AdGuard Browsing Security</a> można znaleźć tutaj. Jeśli
chodzi zaś o kwestię prywatności tego rozwiązania, to operuje ono na prefiksach hash'ów, przez co
serwer AdGuard nie loguje i nie przechowuje żadnych informacji, które mogłyby pozwolić
zidentyfikować odwiedzane przez nas adresy WWW. Poza tym, nawet jeśli AdGuard by umożliwiał
zidentyfikowanie domen, które odwiedzamy, to zawsze trzeba pamiętać o <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a>
(SNI). Za sprawą tego rozszerzenia w pierwszych pakietach przed zestawieniem tunelu SSL/TLS leci
certyfikat zwierający informację domenie, na którą został wystawiony, tj. tę samą, z którą
próbujemy uzyskać połączenie. Ta informacja nie jest w żaden sposób zabezpieczona, nawet w TLS 1.3.
Zatem jeśli ISP loguje nasze połączenia, to i tak informacje o domenie jest w stanie bez problemu
pozyskać i, co gorsze, taką domenę może bez większego wysiłku zablokować.</p>
<h3 id="blokada-serwisów-społecznościowych">Blokada serwisów społecznościowych</h3>
<p>Jeżeli jesteśmy zainteresowani wycięciem na naszym domowym routerze wszystkich lub też tylko części
serwisów społecznościowych, to AdGuard ma również i taką funkcję. Poniżej znajduje się obrazek, na
którym są przedstawione wszystkie serwisy, które za pomocą stosownego przełącznika możemy
zablokować:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/017-adguard-home-openwrt-router-social-filter.png" alt=""    class="huge"></p>
<p>Jak widać, tych serwisów jest dość sporo, a by je zablokować wystarczy kliknąć przy stosownej
pozycji i zapisać zmiany. Od tego momentu, żaden użytkownik naszej sieci nie będzie w stanie się
już połączyć z tymi zablokowanymi stronami.</p>
<h3 id="blokada-serwisów-pornograficznych">Blokada serwisów pornograficznych</h3>
<p>Podobnie sprawa ma się w kwestii blokowania stron pornograficznych. Nie mamy tutaj co prawda
swobody w określeniu jaki serwis AdGuard może zablokować. Zatem możemy jedynie zablokować wszystkie
serwisy porno lub żadne. Mechanizm blokowania stron pornograficznych działa na podobnej zasadzie do
AdGuard Browsing Security.</p>
<h3 id="wymuszenie-korzystania-z-adguard">Wymuszenie korzystania z AdGuard</h3>
<p>Jak widać z powyższego opisu, AdGuard jest całkiem ciekawym narzędziem, które jest w stanie
zabezpieczyć i jednocześnie odfiltrować niepożądany ruch DNS dla całej naszej sieci domowej.
Niemniej jednak, w dalszym ciągu istnieje możliwość obejścia tego mechanizmu i uzyskania dostępu
przykładowo do stron porno. Jedyne co użytkownicy w sieci LAN muszą zrobić, to zignorować serwery
DNS, które otrzymują wraz z lease DHCP, i ustawić w ich miejsce swoje własne serwery DNS, np.
góglowski 8.8.8.8. Każdy system operacyjny umożliwia tego typu zabieg w ustawieniach sieciowych.
Czy jest zatem jakiś sposób, by takiemu zachowaniu przeciwdziałać, tj. by restrykcje, które AdGuard
wprowadzi w naszej sieci, były wymuszone dla każdego określonego przez nas klienta?</p>
<p>W zasadzie ruch DNS odbywa się na porcie UDP/53 (lub/i też TCP/53) i ten port można by na routerze
przekierować na adres i port, na którym nasłuchuje AdGuard, czyli w tym przypadku 192.168.1.1:5353
(lub też przekierować do <code>dnsmasq</code> na 192.168.1.1:53). Takie przekierowanie nie jest niczym trudnym
i sprowadza się do dodania poniższych wpisów w pliku <code>/etc/firewall.user</code> :</p>
<pre><code>iptables -t nat -A PREROUTING -i br-lan ! -s 192.168.1.1 -p tcp --dport 53 -j DNAT --to 192.168.1.1:53
iptables -t nat -A PREROUTING -i br-lan ! -s 192.168.1.1 -p udp --dport 53 -j DNAT --to 192.168.1.1:53

ip6tables -t nat -A PREROUTING -i br-lan ! -s fde8:fd0c:849b::1 -p tcp --dport 53 -j DNAT --to [fde8:fd0c:849b::1]:53
ip6tables -t nat -A PREROUTING -i br-lan ! -s fde8:fd0c:849b::1 -p udp --dport 53 -j DNAT --to [fde8:fd0c:849b::1]:53
</code></pre>
<p>Teraz trzeba jeszcze zrestartować router lub usługę firewall'a:</p>
<pre><code># /etc/init.d/firewall restart
</code></pre>
<p>Reguły powinny zostać dodane, a przekierowanie powinno realizować swoje zadanie, co możemy
sprawdzić podglądając wyjście <code>iptables</code> po wydaniu paru poleceń <code>ping</code> do określonych domen:</p>
<pre><code># iptables -nvL -t nat
Chain PREROUTING (policy ACCEPT 36 packets, 2208 bytes)
 pkts bytes target     prot opt in     out     source               destination
 ...
    6   375 DNAT       udp  --  br-lan *      !192.168.1.1          0.0.0.0/0            udp dpt:53 to:192.168.1.1:53
    0     0 DNAT       tcp  --  br-lan *      !192.168.1.1          0.0.0.0/0            tcp dpt:53 to:192.168.1.1:53
 ...
</code></pre>
<p>lub też w panelu AdGuard:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/018-adguard-home-openwrt-router-dns-leak-test.png" alt=""    class="huge"></p>
<p>Zatem, nawet jeśli klient sobie ustawi w swoim systemie serwer DNS od Google, to i tak mu to nic
nie da, bo zapytania zostaną przekierowane na router i przejdą przez AdGuard.</p>
<h4 id="a-co-jeśli-klient-korzysta-z-doh-dot-lub-dnscrypt-bezpośrednio">A co jeśli klient korzysta z DoH, DoT lub DNScrypt bezpośrednio</h4>
<p>Oczywiście, ten powyższy sposób sprawdzi się jedynie w przypadku tradycyjnych serwerów DNS, gdzie
znany jest port (53). Niemniej jednak, gdy w grę wchodzi szyfrowanie zapytań DNS (DoH, DoT czy
DNScrypt), to już tak łato nie będzie.</p>
<p>O ile DoT wykorzystuje również znany port 853, który można przekierować/zablokować, to DoH i
DNScrypt wykorzystują port 443, czyli ten sam, na którym działają strony po HTTPS. I
zablokowanie/przekierowanie tego portu będzie równoznaczne z brakiem możliwości odwiedzania
jakichkolwiek stron WWW. Krótko pisząc, jeśli użytkownik skonfiguruje DoH lub DNScrypt na swoim
komputerze, to przekierowanie portów nic nam nie da. W takiej sytuacji trzeba by stworzyć listę
serwerów DNS, które wspierają DoH i DNScrypt, i dodać do listy ipset ich adresy IP, po czym przy
pomocy jednej reguły na zaporze zablokować komunikację pochodzącą z LAN kierowaną na adresy DNS
obecne na liście ipset. W takim przypadku użytkownik naszej sieci będzie miał do wyboru albo
korzystać z adresów DNS, które mu poda router, albo korzystać z internetu bez DNS.</p>
<p>Trzeba jednak zdawać sobie sprawę, że obecnie protokoły DoH i DoT coraz powszechniej implementowane
są bezpośrednio w aplikacjach. Przykładem może być przeglądarka Firefox, która udostępnia opcję
<a href="https://support.mozilla.org/en-US/kb/firefox-dns-over-https">szyfrowania zapytań z wykorzystaniem DoH</a> w swoich opcjach:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/019-adguard-home-openwrt-router-firefox-doh.png" alt=""    class="huge"></p>
<p>Po aktywowaniu tej opcji (jeśli nie jest jeszcze ona domyślnie włączona), Firefox będzie szyfrował
i przesyłał wszystkie swoje zapytania DNS do CloudFlare niezależnie od tego co zostało
skonfigurowane w systemie komputera czy też na routerze WiFi.</p>
<p>Podobnie sprawa wygląda w przypadku smartfonów z Androidem 9+, gdzie <a href="https://android-developers.googleblog.com/2018/04/dns-over-tls-support-in-android-p.html">pojawiło się wsparcie dla
szyfrowania DNS via DoT</a>. Wymuszanie korzystania z DNS routera w telefonach sprawi, że
prawdopodobnie nie będą one szyfrować ruchu DNS poza siecią domową, bo ciągle trzeba by zmieniać
ustawienia telefonu w przypadku, gdy ISP nie oferuje szyfrowania DNS, a tego nikt nie chce.</p>
<p>Wymuszając na użytkownikach korzystanie z określonego serwera DNS prędzej czy później sprawi, że
nie będą oni w ogóle chronieni, a chyba nie o to nam chodziło.</p>
<h3 id="panel-adguard-po-https-i-serwer-dot-dla-sieci-lokalnej">Panel AdGuard po HTTPS i serwer DoT dla sieci lokalnej</h3>
<p>Domyślnie po skonfigurowaniu, AdGuard udostępnia panel admina po HTTP. Istnieje możliwość
zaimplementowania szyfrowanego połączenia z tym panelem ale trzeba pierw sobie wyrobić klucz i
certyfikat. Te dwie rzeczy możemy wygenerować na dowolnej dystrybucji linux'a przy <a href="https://letsencrypt.org/docs/certificates-for-localhost/">pomocy
poniższego polecenia</a>:</p>
<pre><code>$ openssl req -x509 -days 3650 -out redviper.crt -keyout redviper.key \
  -newkey rsa:2048 -nodes -sha256 \
  -subj '/CN=redviper.mhouse' -extensions EXT -config &lt;( \
   printf &quot;[dn]\nCN=redviper.mhouse\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:redviper.mhouse\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&quot;)

Generating a RSA private key
.+++++
...+++++
writing new private key to 'redviper.key'
-----
</code></pre>
<p>Powinny zostać nam wygenerowane dwa pliki. Jeden z nich zawiera klucz prywatny, drugi zaś
certyfikat. Zawartość tych plików trzeba wpisać w panelu AdGuard w Settings =&gt; Encryption Settings.
Musimy także określić <code>Server Name</code> na <code>redviper.mhouse</code> (czy co tam podaliśmy przy generowaniu
certyfikatu) oraz dobrać porty pod panel WWW i serwer DoT:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2020/05/020-adguard-home-openwrt-router-panel-https.png" alt=""    class="huge"></p>
<p>Mamy tam co prawda błąd <code>Certificate chain is invalid</code> ale on w niczym nie przeszkadza w tego typu
instalacji.</p>
<p>Po pomyślnym skonfigurowaniu AdGuard, powinniśmy mieć mniej więcej takie wpisy w <code>netstat</code> :</p>
<pre><code># netstat -napletu | grep Ad
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.168.1.1:8080        0.0.0.0:*               LISTEN      18646/AdGuardHome
tcp        0      0 192.168.1.1:4433        0.0.0.0:*               LISTEN      18646/AdGuardHome
tcp        0      0 192.168.1.1:853         0.0.0.0:*               LISTEN      18646/AdGuardHome
tcp        0      0 192.168.1.1:5353        0.0.0.0:*               LISTEN      18646/AdGuardHome
tcp        0      0 10.221.41.129:37450     1.1.1.1:443             ESTABLISHED 18646/AdGuardHome
tcp        0      0 10.221.41.129:58768     176.103.130.132:443     ESTABLISHED 18646/AdGuardHome
tcp        0      0 10.221.41.129:58592     1.0.0.1:443             ESTABLISHED 18646/AdGuardHome
udp        0      0 192.168.1.1:5353        0.0.0.0:*                           18646/AdGuardHome
</code></pre>
<p>Wpisy protokołu <code>TCP</code> z <code>LISTEN</code> odpowiadają kolejno za serwer WWW na porcie 8080 oraz 4433, dalej
mamy serwer DoT na porcie 853. Port 5353 zarówno dla TCP jak i UDP odpowiada za serwer DNS dla
sieci lokalnej. Zaś wpisy mające 1.1.1.1 oraz 1.0.0.1 w <code>Foreign Address</code> odpowiadają za
upstream'owe serwery DNS, do których będą trafiać zapytania. Ten ostatni adres, tj.
<code>176.103.130.132:443</code> dotyczy usługi bezpiecznego przeglądania stron WWW (AdGuard browsing security
web service).</p>
<h2 id="integracja-adguard-home-z-openwrt">Integracja AdGuard Home z OpenWRT</h2>
<p>Póki co AdGuard nie jest dostępny w repozytoriach OpenWRT i trzeba niestety ręcznie pobierać i
instalować stosowny pakiet. Niemniej jednak, osoby, które <a href="https://morfikov.github.io/post/jak-zbudowac-uaktualnic-firmware-openwrt-dla-routera-wifi/">budują własne obrazy z firmware
OpenWRT</a>, mogą zawrzeć w nich binarkę i konfigurację dla AdGuard. W tym celu w zasadzie
wystarczy wypakować pobraną z github'a paczkę <code>.tar.gz</code> , a jej zawartość wrzucić do katalogu
<code>files/opt/</code> . By uniknąć ponownej konfiguracji Adguard, potrzebny nam także będzie plik
<code>AdGuardHome.yaml</code> , którego zawartość jest poniżej:</p>
<pre><code>bind_host: 192.168.1.1
bind_port: 8080
users:
- name: root
  password: hash_hasla
language: &quot;&quot;
rlimit_nofile: 0
web_session_ttl: 720
dns:
  bind_host: 192.168.1.1
  port: 5353
  statistics_interval: 90
  querylog_enabled: true
  querylog_interval: 90
  querylog_memsize: 0
  protection_enabled: true
  blocking_mode: default
  blocking_ipv4: &quot;&quot;
  blocking_ipv6: &quot;&quot;
  blocked_response_ttl: 10
  ratelimit: 512
  ratelimit_whitelist: []
  refuse_any: true
  bootstrap_dns:
  - 1.1.1.1
  all_servers: true
  edns_client_subnet: false
  aaaa_disabled: true
  allowed_clients: []
  disallowed_clients: []
  blocked_hosts: []
  parental_block_host: family-block.dns.adguard.com
  safebrowsing_block_host: standard-block.dns.adguard.com
  cache_size: 4194304
  upstream_dns:
  - https://1.1.1.1/dns-query
  - https://1.0.0.1/dns-query
  filtering_enabled: true
  filters_update_interval: 24
  parental_enabled: false
  safesearch_enabled: false
  safebrowsing_enabled: true
  safebrowsing_cache_size: 1048576
  safesearch_cache_size: 1048576
  parental_cache_size: 1048576
  cache_time: 30
  rewrites: []
  blocked_services: []
tls:
  enabled: true
  server_name: redviper.mhouse
  force_https: true
  port_https: 4433
  port_dns_over_tls: 853
  allow_unencrypted_doh: false
  strict_sni_check: false
  certificate_chain: |
    -----BEGIN CERTIFICATE-----
    ...
    -----END CERTIFICATE-----
  private_key: |
    -----BEGIN PRIVATE KEY-----
    ...
    -----END PRIVATE KEY-----
  certificate_path: &quot;&quot;
  private_key_path: &quot;&quot;
filters:
- enabled: true
  url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
  name: AdGuard Simplified Domain Names filter
  id: 1
- enabled: true
  url: https://adaway.org/hosts.txt
  name: AdAway
  id: 2
- enabled: false
  url: https://hosts-file.net/ad_servers.txt
  name: hpHosts - Ad and Tracking servers only
  id: 3
- enabled: true
  url: https://www.malwaredomainlist.com/hostslist/hosts.txt
  name: MalwareDomainList.com Hosts List
  id: 4
- enabled: true
  url: http://adblocklist.org/adblock-pxf-polish.txt
  name: regpl
  id: 1587891685
- enabled: true
  url: https://pgl.yoyo.org/adservers/serverlist.php?hostformat=nohtml&amp;showintro=0&amp;mimetype=plaintext'
  name: yoyo
  id: 1587891686
- enabled: true
  url: https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt
  name: disconnect
  id: 1587891687
whitelist_filters: []
user_rules:
- &quot;&quot;
dhcp:
  enabled: false
  interface_name: &quot;&quot;
  gateway_ip: &quot;&quot;
  subnet_mask: &quot;&quot;
  range_start: &quot;&quot;
  range_end: &quot;&quot;
  lease_duration: 86400
  icmp_timeout_msec: 1000
clients:
- name: morfikownia
  tags:
  - device_laptop
  - os_linux
  - user_admin
  ids:
  - 192.168.1.150
  use_global_settings: true
  filtering_enabled: false
  parental_enabled: false
  safesearch_enabled: false
  safebrowsing_enabled: false
  use_global_blocked_services: true
  blocked_services: []
  upstreams: []
- name: router
  tags:
  - device_other
  - os_linux
  - user_regular
  ids:
  - 192.168.1.1
  use_global_settings: true
  filtering_enabled: false
  parental_enabled: false
  safesearch_enabled: false
  safebrowsing_enabled: false
  use_global_blocked_services: true
  blocked_services: []
  upstreams: []
log_file: &quot;&quot;
verbose: false
schema_version: 6
</code></pre>
<p>W <code>name:</code> i <code>password:</code> trzeba określić nazwę użytkownika i hash hasła. Podobnie trzeba postąpić z
kluczem oraz certyfikatem w <code>private_key</code> oraz <code>certificate_chain</code> . Te dane będą podane po
skonfigurowaniu AdGuard'a, zatem można sobie zrobić backup tego pliku.</p>
<p>Dodatkowo, musimy jeszcze zmienić konfigurację dnsmasq w <code>files/etc/uci-defaults/01-config.sh</code> :</p>
<pre><code>uci add_list dhcp.@dnsmasq[0].server='192.168.1.1#5353'
uci set dhcp.@dnsmasq[0].noresolv='1'

uci set network.wan.peerdns='0'
uci add_list network.wan.dns='127.0.0.1'
uci set network.wan6.peerdns='0'
uci add_list network.wan6.dns='127.0.0.1'
</code></pre>
<p>Musimy też dodać sobie wpis do pliku <code>/etc/rc.local</code> , tak by nam ten AdGuard startował
automatycznie. Tworzymy zatem plik <code>files/etc/rc.local</code> i dodajemy w nim poniższą linijkę:</p>
<pre><code>(/opt/AdGuardHome/AdGuardHome --work-dir /tmp/data --config /opt/AdGuardHome/AdGuardHome.yaml &gt; /tmp/adguard.log 2&gt;&amp;1) &amp;

exit 0
</code></pre>
<p>No i na koniec jeszcze tworzymy plik <code>files/etc/firewall.user</code> i dodajemy te poniższe wpisy:</p>
<pre><code>iptables -t nat -A PREROUTING -i br-lan ! -s 192.168.1.1 -p tcp --dport 53 -j DNAT --to 192.168.1.1:53
iptables -t nat -A PREROUTING -i br-lan ! -s 192.168.1.1 -p udp --dport 53 -j DNAT --to 192.168.1.1:53

ip6tables -t nat -A PREROUTING -i br-lan ! -s fde8:fd0c:849b::1 -p tcp --dport 53 -j DNAT --to [fde8:fd0c:849b::1]:53
ip6tables -t nat -A PREROUTING -i br-lan ! -s fde8:fd0c:849b::1 -p udp --dport 53 -j DNAT --to [fde8:fd0c:849b::1]:53
</code></pre>
<h2 id="problemy-z-adguard">Problemy z AdGuard</h2>
<p>Z reguły instalacja AdGuard na OpenWRT powinna przebiegać w miarę w bezproblemowy sposób. Niemniej
jednak, w moim przypadku pojawiło się trochę problemów, które postanowiłem opisać poniżej.</p>
<h3 id="nie-wszystkie-reklamy-są-blokowane">Nie wszystkie reklamy są blokowane</h3>
<p>Blokowanie reklam w AdGuard działa w oparciu o nazwy domen. Dlatego też ten filtr nie wytnie nam
reklam w 100%. Przykładem mogą być telefony z Androidem, a konkretnie aplikacja YouTube, gdzie
adresy adserwerów są zaszyte bezpośrednio w appce. W takim przypadku potrzebny jest inny klient
YouTube i AdGuard nic tutaj nie poradzi.</p>
<p>Podobnie sprawa wygląda w przypadku różnych serwisów www, gdzie by obejrzeć jakiś materiał video
trzeba pierw wyświetlić reklamę, i jeśli nie zostanie ona wyświetlona (adserwer zostanie
zablokowany przez AdGuard), to nie będziemy mieli możliwości w ogóle wyświetlić takiego filmu.</p>
<p>Większość reklam powinna jednak zniknąć, czy to w telefonach czy to w komputerach
stacjonarnych/laptopach, a jeśli już jakieś zostają, to trzeba posiłkować się różnymi
rozszerzeniami do przeglądarek pokroju <a href="https://github.com/gorhill/uBlock">uBlock</a>/<a href="https://github.com/gorhill/uMatrix">uMartix</a>/<a href="https://github.com/reek/anti-adblock-killer">anti-adblock-killer</a>, które
są w stanie wyciąć określone elementy stron WWW niezależnie od domen adserwerów.</p>
<h3 id="protokół-ipv6">Protokół IPv6</h3>
<p>Mój provider internetowy nie zapewnia wsparcia dla protokołu IPv6 i mogę korzystać jedynie ze
starszej wersji protokołu IPv4. W takim przypadku mogą pojawić się opóźnienia przy rozwiązywaniu
nazw i dobrze jest w takiej sytuacji wyłączyć rozwiązywanie zapytań DNS dla IPv6 (w Settings =&gt;
DNS Settings).</p>
<h3 id="couldnt-initialize-dns-server-couldnt-initialize-statistics-module">Couldn't initialize DNS server: Couldn't initialize statistics module</h3>
<p>Czasami jednak możemy napotkać błąd podczas konfiguracji, który objawia się poniższym komunikatem</p>
<pre><code>Error: control/install/configure | Couldn't initialize DNS server: Couldn't initialize statistics module | 500` .
</code></pre>
<p>W logu systemowym możemy zaś zaobserwować poniższe wiadomości:</p>
<pre><code>[error] Stats: open DB: /opt/AdGuardHome/data/stats.db: invalid argument
[error] AdGuard Home cannot be initialized due to an incompatible file system.
Please read the explanation here: https://github.com/AdguardTeam/AdGuardHome/wiki/Getting-Started#limitations
[info] Couldn't initialize DNS server: Couldn't initialize statistics module
</code></pre>
<p>Jedynym wyjściem w tym przypadku jest uruchomienie AdGuard'a przy pomocy poniższego polecenia:</p>
<pre><code>/opt/AdGuardHome/AdGuardHome --work-dir /tmp/data --config /opt/AdGuardHome/AdGuardHome.yaml
</code></pre>
<p>Opcja <code>--work-dir</code> określa katalog roboczy, który będzie umieszczony w RAM (cały <code>/tmp/</code> w OpenWRT
siedzi w RAM) i zrestartowanie routera będzie powodować utratę bazy danych (statystyk, logów, itp.).
Domyślnie także plik konfiguracyjny <code>AdGuardHome.yaml</code> zostałby wrzucony do katalogu <code>/tmp/data/</code> ,
co skutkowałoby ponowną konfiguracją AdGuard'a po restarcie routera. Dlatego też przy pomocy
<code>--config</code> określamy, w którym miejscu AdGuard ma tego pliku poszukiwać.</p>
<h3 id="libustream-mbedtls-vs-libustream-openssl">libustream-mbedtls vs. libustream-openssl</h3>
<p>Adguard wymaga do poprawnego działania biblioteki SSL. W OpenWRT mamy dostępne między innymi
pakiety: <code>libustream-mbedtls</code> (MbedTLS) i <code>libustream-openssl</code> (OpenSSL). W zależności od tego jak
budowany był obraz firmware, jeden lub drugi pakiet może być obecny w systemie routera. Jeśli nie
mamy żadnej biblioteki SSL wgranej na routerze, to trzeba jeden z tych dwóch pakietów doinstalować.
Czasami użytkownicy próbują doinstalować <code>libustream-mbedtls</code> mając <code>libustream-openssl</code> i w takim
przypadku instalacja tego dodatkowego pakietu skoczy się poniższym błędem:</p>
<pre><code># opkg install libustream-mbedtls
Installing libustream-mbedtls20150806 (2019-11-05-c9b66682-2) to root...
Downloading http://downloads.openwrt.org/releases/19.07-SNAPSHOT/packages/mips_24kc/base/libustream-mbedtls20150806_2019-11-05-c9b66682-2_mips_24kc.ipk
Installing libmbedtls12 (2.16.6-1) to root...
Downloading http://downloads.openwrt.org/releases/19.07-SNAPSHOT/packages/mips_24kc/base/libmbedtls12_2.16.6-1_mips_24kc.ipk
Configuring libmbedtls12.
Collected errors:
 * check_data_file_clashes: Package libustream-mbedtls20150806 wants to install file /lib/libustream-ssl.so
        But that file is already provided by package  * libustream-openssl20150806
 * opkg_install_cmd: Cannot install package libustream-mbedtls.
</code></pre>
<p>Jak widać powstał konflikt o plik <code>/lib/libustream-ssl.so</code> , który dostarczany jest przez każdy z
tych dwóch pakietów. W OpenWRT nie ma możliwości posiadać w systemie równocześnie kilku pakietów
dostarczających ten sam plik. Dlatego trzeba się zdecydować na jedną z tych bibliotek SSL. AdGuard
bez problemu będzie działał zarówno z OpenSSL jak i MbedTLS. Zatem jeśli nasz router jest
skonfigurowany do pracy z OpenSSL, to nie musimy sobie zawracać głowy pakietem <code>libustream-mbedtls</code>
i podobnie w drugą stronę.</p>
<h3 id="x509-certificate-signed-by-unknown-authority">x509: certificate signed by unknown authority</h3>
<p>Po zalogowaniu się do panelu AdGuard, w logu na routerze można było zauważyć te poniższe komunikaty:</p>
<pre><code>2020/04/30 11:26:30 [info] Couldn't request filter from URL https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt, skipping: Get https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt: x509: certificate signed by unknown authority
2020/04/30 11:26:30 [info] Failed to update filter https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt: Get https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt: x509: certificate signed by unknown authority

2020/04/30 11:26:30 [info] Go to http://192.168.1.1:8080
2020/04/30 11:29:45 [info] Auth: invalid cookie value: agh_session=b94b76b67bdd4af4fd20b7b6537f76fb86fbf97562e1db37b6d3a19ac4c18223
2020/04/30 11:29:45 [info] Auth: invalid cookie value: agh_session=b94b76b67bdd4af4fd20b7b6537f76fb86fbf97562e1db37b6d3a19ac4c18223
2020/04/30 11:30:51 [info] Couldn't get version check json from https://static.adguard.com/adguardhome/release/version.json: *url.Error Get https://static.adguard.com/adguardhome/release/version.json: x509: certificate signed by unknown authority
</code></pre>
<p>By poprawić te błędy, trzeba doinstalować na routerze pakiet <code>ca-certificates</code> oraz <code>ca-bundle</code> .</p>
<h2 id="podsumowanie">Podsumowanie</h2>
<p>AdGuard to dość przyzwoite narzędzie, którym możemy praktycznie bez większego wysiłku zabezpieczyć
ruch DNS naszej sieci domowej przez wdrożenie protokołu DoH, DoT lub DNScrypt. AdGuard posiada
także dość konfigurowalny filtr domen internetowych, przy którego to pomocy jesteśmy w stanie
zablokować niepożądany kontent, w tym też część reklam. Niemniej jednak, każdy filtr, w tym też ten
oferowany przez AdGuard, ma swoje słabości i nie jest w stanie wyciąć wszystkich reklam, na które
natkniemy się w sieci. Jeśli zaś chodzi o aspekt cenzorski, to każdą blokadę da radę obejść i
AdGuard nie jest tutaj żadnym wyjątkiem. Osoby, które będą chciały mieć dostęp do treści naszym
zdaniem nieodpowiednich, będą mogły bez problemu go uzyskać i AdGuard ich przed tym nie powstrzyma.</p>
<p>Podczas testów nie napotkałem większych problemów w działaniu AdGuard na swoim routerze Archer
C2600. Niemniej jednak, ten router dysponuje 512M RAM, 32M flash oraz posiada dwurdzeniowy procesor
1,4GHz, co nieco ułatwia wdrożenie mechanizmu AdGuard. Na słabszych routerach pewne problemy mogą
się pojawić, bo jakby nie patrzeć trochę pamięci ten panel GUI zjada (&gt;32M). Podobnie sprawa ma się
w kwestii flash, gdzie potrzebne będzie urządzenie dysponujące flash'em minimum 16M. W przypadku
routerów z mniejszym flash trzeba będzie korzystać z extroot i przeznaczyć jeden port USB na
podłączenie pendrive. Dlatego też zawsze alternatywą dla AdGuard w przypadku tych słabszych
routerów będzie AdBlock w połączeniu z dnscrypt-proxy, który w zasadzie jest w stanie zapewnić tę
samą funkcjonalność ale niższym kosztem.</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/router/">router</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/tp-link/">tp-link</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/adblock/">adblock</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/dns/">dns</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/adguard/">adguard</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&amp;text=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&amp;title=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&amp;title=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&title=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&amp;title=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2finstalacja-konfiguracja-adguard-na-routerze-z-openwrt%2f&description=Instalacja%20i%20konfiguracja%20AdGuard%20na%20routerze%20z%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-zbudowac-uaktualnic-firmware-openwrt-dla-routera-wifi/">Jak zbudować/uaktualnić firmware OpenWRT dla routera WiFi</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-ustalic-ip-i-nazwe-pliku-trybu-recovery-w-routerach-tp-link/">Jak ustalić IP i nazwę pliku trybu recovery w routerach TP-Link</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-wymusic-pasmo-czestotliwosc-lte-pod-lede-openwrt/">Jak wymusić pasmo/częstotliwość LTE pod OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/recenzja-router-lte-archer-mr200-tp-link/">Recenzja: Router LTE Archer MR200 od TP-LINK</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-skonfigurowac-klienta-vpn-na-routerze-z-openwrt/">Jak skonfigurować klienta VPN na routerze z OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/aplikacja-tpmifi-do-zarzadzania-routerami-3g-lte-tp-link/">Aplikacja tpMiFi do zarządzania routerami 3G/LTE od TP-LINK</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/android-blokowanie-reklam-z-adaway-na-smartfonie/">Android: Blokowanie reklam z AdAway na smartfonie</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script>
  var id =  16 ;

  if (id)
  {
    let url = "https://github.com/morfikov/morfitronik-comments/issues/".concat(id);
    let api_url = "https://api.github.com/repos/morfikov/morfitronik-comments/issues/".concat(id, "/comments");

    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Komentarze dla tego postu nie zostały jeszcze otworzone (albo skrypty GitHub'a są wyłączone). Być może też skończył ci się przydział 60/godzinę (limit GitHub'a).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h3");
        mainHeader.innerHTML = "Komentarze: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>Możesz zostawić komentarz korzystając z <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);

        comments.forEach(function(comment)
        {
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Europe/Warsaw' };
			options.timeZoneName = 'short';
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " | <em>", (new Date(comment.created_at)).toLocaleTimeString('pl-PL', options), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Wystąpił jakiś błąd przy ładowaniu komentarzy.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/mikhailmorfikov">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
</div>
	<div class="footer__copyright">© 2021 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
</body>
</html>
