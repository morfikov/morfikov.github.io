<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Failover i load balancing w OpenWRT (mwan3) | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Failover i load balancing w OpenWRT (mwan3)" />
<meta property="og:description" content="Może się zdarzyć tak, że będziemy mieli kiedyś dostęp do łącz kilku różnych providerów
internetowych. Jeśli chcielibyśmy skorzystać z internetu w takiej sytuacji, to trzeba by się
zdecydować na jednego z tych dostępnych ISP. Natomiast łącze pozostałych ISP będzie niewykorzystane
w tym danym momencie, a przecie nie za to im płacimy. Jeśli mamy router z OpenWRT i
skonfigurowaliśmy przy tym switch tak, by mieć kilka portów
WAN, to możemy korzystać z usług
wielu ISP w tym samym czasie. Oczywiście, ten mechanizm działa również w przypadku, gdy ISP świadczy
nam usługi za pomocą technologi LTE. Trzeba tylko odpowiednio skonfigurować modem USB do pracy na
routerze. W tym artykule zostanie opisane narzędzie
mwan3, za pomocą którego zaprojektujemy sobie prosty
failover (łącze awaryjne) lub load balancing (równoważenie ruchu) mając do wykorzystania dwóch
różnych ISP." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morfikov.github.io/post/failover-load-balancing-openwrt-mwan3/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2016-05-15T13:37:08+00:00" />
<meta property="article:modified_time" content="2016-05-15T13:37:08+00:00" />


		<meta itemprop="name" content="Failover i load balancing w OpenWRT (mwan3)">
<meta itemprop="description" content="Może się zdarzyć tak, że będziemy mieli kiedyś dostęp do łącz kilku różnych providerów
internetowych. Jeśli chcielibyśmy skorzystać z internetu w takiej sytuacji, to trzeba by się
zdecydować na jednego z tych dostępnych ISP. Natomiast łącze pozostałych ISP będzie niewykorzystane
w tym danym momencie, a przecie nie za to im płacimy. Jeśli mamy router z OpenWRT i
skonfigurowaliśmy przy tym switch tak, by mieć kilka portów
WAN, to możemy korzystać z usług
wielu ISP w tym samym czasie. Oczywiście, ten mechanizm działa również w przypadku, gdy ISP świadczy
nam usługi za pomocą technologi LTE. Trzeba tylko odpowiednio skonfigurować modem USB do pracy na
routerze. W tym artykule zostanie opisane narzędzie
mwan3, za pomocą którego zaprojektujemy sobie prosty
failover (łącze awaryjne) lub load balancing (równoważenie ruchu) mając do wykorzystania dwóch
różnych ISP."><meta itemprop="datePublished" content="2016-05-15T13:37:08+00:00" />
<meta itemprop="dateModified" content="2016-05-15T13:37:08+00:00" />
<meta itemprop="wordCount" content="2042">
<meta itemprop="keywords" content="chaos-calmer,sieć,router,failover,load-balancing," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Failover i load balancing w OpenWRT (mwan3)"/>
<meta name="twitter:description" content="Może się zdarzyć tak, że będziemy mieli kiedyś dostęp do łącz kilku różnych providerów
internetowych. Jeśli chcielibyśmy skorzystać z internetu w takiej sytuacji, to trzeba by się
zdecydować na jednego z tych dostępnych ISP. Natomiast łącze pozostałych ISP będzie niewykorzystane
w tym danym momencie, a przecie nie za to im płacimy. Jeśli mamy router z OpenWRT i
skonfigurowaliśmy przy tym switch tak, by mieć kilka portów
WAN, to możemy korzystać z usług
wielu ISP w tym samym czasie. Oczywiście, ten mechanizm działa również w przypadku, gdy ISP świadczy
nam usługi za pomocą technologi LTE. Trzeba tylko odpowiednio skonfigurować modem USB do pracy na
routerze. W tym artykule zostanie opisane narzędzie
mwan3, za pomocą którego zaprojektujemy sobie prosty
failover (łącze awaryjne) lub load balancing (równoważenie ruchu) mając do wykorzystania dwóch
różnych ISP."/>

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119125303-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Failover i load balancing w OpenWRT (mwan3)</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2016-05-15T13:37:08Z">Opublikowano: 15/05/2016</time>

<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/openwrt/" rel="category">OpenWRT</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Failover i load balancing w OpenWRT (mwan3)</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#parametry-i-konfiguracja-internetu-od-isp">Parametry i konfiguracja internetu od ISP</a>
      <ol>
        <li><a href="#metryki">Metryki</a></li>
      </ol>
    </li>
    <li><a href="#instalacja-i-konfiguracja-mwan3">Instalacja i konfiguracja mwan3</a></li>
    <li><a href="#status-łącza">Status łącza</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Może się zdarzyć tak, że będziemy mieli kiedyś dostęp do łącz kilku różnych providerów
internetowych. Jeśli chcielibyśmy skorzystać z internetu w takiej sytuacji, to trzeba by się
zdecydować na jednego z tych dostępnych ISP. Natomiast łącze pozostałych ISP będzie niewykorzystane
w tym danym momencie, a przecie nie za to im płacimy. Jeśli mamy router z OpenWRT i
<a href="https://morfikov.github.io/post/podzial-switcha-na-kilka-vlan-w-openwrt/">skonfigurowaliśmy przy tym switch tak, by mieć kilka portów
WAN</a>, to możemy korzystać z usług
wielu ISP w tym samym czasie. Oczywiście, ten mechanizm działa również w przypadku, gdy ISP świadczy
nam usługi za pomocą technologi LTE. Trzeba tylko odpowiednio <a href="https://morfikov.github.io/post/modem-lte-pod-openwrt/">skonfigurować modem USB do pracy na
routerze</a>. W tym artykule zostanie opisane <a href="https://wiki.openwrt.org/doc/howto/mwan3">narzędzie
mwan3</a>, za pomocą którego zaprojektujemy sobie prosty
failover (łącze awaryjne) lub load balancing (równoważenie ruchu) mając do wykorzystania dwóch
różnych ISP.</p>
<h2 id="parametry-i-konfiguracja-internetu-od-isp">Parametry i konfiguracja internetu od ISP</h2>
<p>W tym przypadku będziemy mieli do czynienia z jednym ISP lokalnym, który oferuje łącze 15/1 mbit/s.
Drugim ISP jest operator GSM RBM/Play, który świadczy usługę internetu LTE. W przypadku lokalnego
ISP, dostęp odbywa się po kablu wpiętego do standardowego portu WAN routera <a href="http://www.tp-link.com.pl/products/details/Archer-C7.html">TP-LINK Archer C7
v2</a>. Natomiast jeśli chodzi o internet
LTE, to jest on realizowany przez modem E3372 (E3372s-153) w wersji NON-HiLink podłączony do jednego
z portów USB routera. Parametry tego łącza są bardzo zróżnicowane. Wahają się od 30/30 mbit/s do
3/15 mbit/s w szczycie. Zakładając scenariusz idealny, to będziemy mieli do wykorzystania 45/31
mbit/s po zaimplementowaniu mechanizmu równoważącego ruch. Natomiast jeśli chodzi o failover, to w
przypadku zaniku sygnału od lokalnego ISP, zostanie aktywowany internet LTE. Po powrocie sygnału,
nastąpi przełączenie z powrotem na łącze lokalnego ISP.</p>
<p>Warto tutaj zauważyć, że w przypadku równoważenia obciążenia, czyli gdy wykorzystujemy łącza obu ISP
jednocześnie, maksymalny transfer dla pojedynczego połączenia nigdy nie przekroczy wartości
granicznych danego ISP. Dla przykładu, jeśli pobieramy jeden plik z internetu, to poleci on
pierwszym lub drugim kanałem. W rezultacie, transfer jaki osiągniemy to 15 lub 30 mbit/s, w
zależności od ISP. Jeśli natomiast uruchomimy kilka jednoczesnych połączeń przy pobieraniu tego
pliku, wtedy część pliku będzie pobierana za pomocą łącza jednego ISP, a pozostała część za pomocą
drugiego łącza. W przypadku stron www, każde wejście na jakiś serwis, generuje wiele jednoczesnych
połączeń. Zatem będą one wysyłane do różnych ISP i tu już boost powinien być widoczny gołym okiem.</p>
<p>Minimalna konfiguracja, jaka będzie nam potrzebna, to trzy interfejsy: 1 LAN i 2 WAN. Musimy także
upewnić się, że nie korzystamy z DNS żadnego z w/w ISP. Chodzi o to, że jeśli byśmy korzystali z
serwera DNS jednego z tych providerów, to po przełączeniu się na drugie łącze, w przypadku awarii
pierwszego lub zwyczajnie podczas balansowania ruchu, zapytania DNS będą blokowane przez któregoś z
ISP. No bo będą przecie pochodzić spoza jego sieci. Dlatego musimy korzystać z globalnych providerów
DNS, np. google czy OpenDNS. Podobnie z pozostałymi usługami, np. email. Nie możemy korzystać z nich
jeśli zamierzamy robić load balancing czy network failover. Poniżej znajduje się konfiguracja
interfejsów sieciowych routera.</p>
<p>Plik <code>/etc/config/network</code> :</p>
<pre><code>config interface 'lan'
   option ifname        'eth1'
   option force_link    '1'
   option type          'bridge'
   option proto         'static'
   option ipaddr        '192.168.1.1'
   option netmask       '255.255.255.0'
   option ip6assign     '60'
   option peerdns       '0'

config interface 'lte'
   option ifname    'wwan0'
    option proto    'ncm'
    option mode     'lte'
    option pincode  ''
    option apn      'internet'
    option device   '/dev/ttyUSB0'
    option username ''
    option password ''
    option peerdns  '0'
    option dns      '208.67.220.220 208.67.222.222'

config interface 'wan'
   option ifname  'eth0'
   option proto   'dhcp'
   option peerdns '0'
   option dns     '208.67.220.220 208.67.222.222'
</code></pre>
<p>Wszystkie interfejsy WAN muszą być wyjęte spod działania serwera DHCP w OpenWRT. Dlatego też w pliku
<code>/etc/network/dhcp</code> musimy uwzględnić te poniższe wpisy:</p>
<pre><code>config dhcp 'wan'
   option interface 'wan'
   option ignore '1'

config dhcp 'lte'
   option interface 'lte'
   option ignore '1'
</code></pre>
<p>Musimy także skonfigurować przepływ pakietów na zaporze. Standardowy interfejs WAN w domyślnej
konfiguracji OpenWRT już jest poprawnie skonfigurowany. Dlatego poniżej znajdują się jedynie wpisy
dotyczące nowego interfejsu sieciowego:</p>
<pre><code>config zone
   option name             lte
   list   network          'lte'
   option input            DROP
   option output           ACCEPT
   option forward          DROP
   option masq             1
   option conntrack        1
   option mtu_fix          1
   option log              0
   option log_limit        60/minute

config forwarding
   option src              'lan'
   option dest             'lte'
</code></pre>
<p>Zapisujemy konfigurację i restartujemy router. Po podniesieniu się systemu, router powinien uzyskać
konfigurację na obu interfejsach WAN. Niemniej jednak, obecnie mamy określoną tylko jedną bramę
domyślną. Dlatego też pakiety do internetu mogą lecieć tylko przez jednego z tych dwóch operatorów.
Którego? To zależy jak się te interfejsy skonfigurują po starcie routera. Zwykle konfiguracja tego
ostatniego interfejsu WAN przepisze bramę domyślną w tablicy routingu. I to on będzie wykorzystywany
do połączenia z internetem. W przypadku LTE, to modem zawsze konfiguruje się kilka sekund. Dlatego
to on na poniższym listingu określił swoją bramę jako domyślną:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/2.wwan3-openwrt-tablica-routingu-brama.png" alt=""    class="huge"></p>
<p>Na powyższej fotce widzimy tablicę routingu dla interfejsów routera. Mamy tam 3 interfejsy: <code>wwan0</code>
(LTE), <code>eth0</code> (WAN), oraz <code>br-lan</code> (LAN). Mamy zatem na trzech interfejsach skonfigurowane trzy
różne sieci: 10.136.111.216/30 (brama 10.136.111.218), 82.160.124.0/24 (brama 82.160.124.254) i
192.168.1.0/24 (bez bramy). Jako brama domyślna jest ustawiony adres 10.136.111.218 na interfejsie
<code>wwan0</code> . Zatem wszystkie pakiety, które nie są przeznaczone do tych 3 sieci, będą przesyłane przez
interfejs <code>wwan0</code> na adres 10.136.111.218 .</p>
<p>Konfiguracja interfejsów WAN routera wygląda zaś następująco:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/1.wwan3-openwrt-interfejsy-wan.png" alt=""    class="huge"></p>
<h3 id="metryki">Metryki</h3>
<p>Jeśli chcemy korzystać z obu tych ISP jednocześnie, to musimy nakazać routerowi skonfigurowanie
bramy domyślnej ( <code>default</code> ) zarówno dla interfejsu <code>eth0</code> jak i <code>wwan0</code> . By móc tego typu zabieg
przeprowadzić, musimy określić metryki dla tras wszystkich interfejsów WAN. Domyślnie mają one
sprecyzowane 0 i możemy w systemie posiadać tylko jedną domyślną bramę. Z tego też względu są one
przepisywane przy konfiguracji następnego interfejsu WAN. Edytujemy zatem jeszcze raz plik
<code>/etc/config/network</code> i do bloków z konfiguracją WAN dodajemy opcję <code>metric</code> :</p>
<pre><code>config interface 'wan'
   option ifname 'eth0'
   option metric   '10'
   ...
</code></pre>
<p>Im niższą wartość ustawimy w opcji <code>metric</code> , tym brama ma większy priorytet. W ten sposób określimy
pożądaną przez nas kolejność bramek domyślnych. Niemniej jednak, W wydaniu OpenWRT Chaos Calmer nie
zawsze możemy określić metrykę w powyższy sposób. Dla przykładu, wykorzystywany tutaj modem pracuje
w trybie NDIS (NCM) i obecnie pakiet <code>comgt-ncm</code> nie ma zaimplementowanej obsługi metryk w pliku
<code>/lib/netifd/proto/ncm.sh</code> . Trzeba by ten plik przerobić. <a href="https://pastebin.com/iE64TT5a">Pod tym
linkiem</a> znajduje się już gotowy plik, którego zawartość trzeba
przekopiować do w/w lokalizacji. W późniejszych wersjach OpenWRT nie będzie już trzeba tak
kombinować. W każdym razie, ten problem z metrykami dotyczy tylko modemów LTE. Wszelkie połączenia
przewodowe konfiguruje się tak jak widać powyżej.</p>
<p>Mając już przypisane metryki, restartujemy interfejsy. Sprawdzamy tablicę routingu oraz testujemy
połączenie za pomocą polecenia <code>ping</code> :</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/4.wwan3-test-lacza.png" alt=""    class="huge"></p>
<p>Jak widzimy, bramy domyślne są dwie. Po jednej dla każdego interfejsu WAN. Również <code>ping</code> przechodzi
przez oba interfejsy, czyli internet jest osiągalny przez obu ISP. Taka konfiguracja otwiera nam
drogę do zainstalowania i skonfigurowania pakietu <code>mwan3</code> . To właśnie przy jego pomocy zrobimy
sobie failover i load balancing łącza.</p>
<h2 id="instalacja-i-konfiguracja-mwan3">Instalacja i konfiguracja mwan3</h2>
<p>Jeśli do tego miejsca udało nam się uzyskać wyniki podobne do powyższych i po zresetowaniu routera
mamy internet, który wychodzi przez główną bramę (tę z niższą metryką), oznacza to, że możemy
przejść do instalowania pakietu <code>mwan3</code> . Jest on dostępny standardowo w repozytoriach OpenWRT i
jego instalacja sprowadza się do wydania tych poniższych poleceń:</p>
<pre><code># opkg update
# opkg install mwan3
</code></pre>
<p>Konfiguracja <code>mwan3</code> znajduje się w pliku <code>/etc/config/mwan3</code> . Jako, że my dysponujemy tylko dwoma
interfejsami, to za dużo nie trzeba w tym pliku zmieniać. Całość działa, można by rzec, OOTB.
Przechodzimy zatem do edycji w/w pliku i włączamy w nim sekcję odpowiedzialną za drugi interfejs
WAN:</p>
<pre><code>config interface 'lte'
    option enabled '1'
    ...
</code></pre>
<p>Po resecie routera, oba łącza powinny zostać aktywowane i całość powinna działać. Oczywiście, nie
musimy resetować routera, by całość nam po prostu zadziałała. Możemy wpisać w terminalu to poniższe
polecenie:</p>
<pre><code># mwan3 start
</code></pre>
<p>Plik konfiguracyjny <code>mwan3</code> zawiera dość sporo parametrów i przydałoby się je omówić. Opcja
<code>interface</code> wskazuje nazwę interfejsu, która jest określona w pliku <code>/etc/config/network</code> . W tym
przypadku są to <code>wan</code> oraz <code>lte</code> . Opcja <code>enabled</code> określa czy <code>mwan3</code> ma brać pod uwagę ten
interfejs. Dalej mamy pozycje <code>list track_ip</code> , które definiują adresy hostów, w oparciu o które
będzie przeprowadzany test łącza. Można sprecyzować kilka takich opcji. Można też ten parametr
całkowicie pominąć i w takim przypadku interfejs będzie uznawany zawsze za działający. Kolejna
opcja w pliku to <code>reliability</code> i przyjmuje ona wartość liczbową określającą ile hostów, z tych
sprecyzowanych w <code>list track_ip</code> musi udzielić odpowiedzi, by traktować dany interfejs jako
działający. Następnie mamy <code>count</code> , który określa ilość żądań <code>ping</code> wysyłanych do hostów podczas
testów. Z kolei <code>timeout</code> definiuje ile czasu (w sekundach) system będzie czekał na odpowiedź na
wysłane żądanie ping'u, po czym da sobie spokój i zgłosi błąd. Opcja <code>interval</code> określa
częstotliwość próbkowania łącza, czyli co ile sekund zostanie wysłany <code>ping</code> . Ostatnie dwie opcje
w bloku <code>config interface</code> , tj. <code>up</code> oraz <code>down</code> definiują ile testów musi przejść interfejs, by
został uznany odpowiednio za działający lub padnięty. Dobrze jest przemyśleć dobór wartości w
powyższych parametrach, by czasem interfejs nie był zbyt często uznawany przez pomyłkę za trupa.
Podobnie trzeba rozważyć podniesienie niektórych wartości w przypadku łącz o słabszej jakości.</p>
<p>Kolejne dwie sekcje w pliku, tj. <code>config member</code> i <code>config policy</code> są ze sobą powiązane. To tutaj,
na podstawie metryk ( <code>metric</code> ) i wag ( <code>weight</code> ) będzie zapadać decyzja o konfiguracji
przesyłanego ruchu. Wymagane jest utworzenie co najmniej dwóch sekcji <code>config member</code> do
prawidłowego działania <code>mwan3</code> . Chodzi o podział sumarycznego łącza. Jeśli są dwie sekcje, to mamy
podział na dwie części (dwóch providerów ) w proporcjach określanych przez powyższe parametry.
Domyślnie mamy określone cztery sekcje <code>config member</code> . W każdej z nich są zdefiniowane różne
metryki. Im mniejszy numer tym większy priorytet. W blokach <code>config policy</code> będą określone różne
polityki zachowań się łącza w przypadku, gdy zostaną spełnione określone warunki. Na podstawie
sprecyzowanych metryk będzie podejmowana decyzja czy używać jednego łącza czy też drugiego. W
przypadku, gdy metryka ma taki sam numerek na obu interfejsach, wtedy nastąpi podział łącza w
stosunku określonym przez parametr <code>weight</code> , w tym przypadku 2/3 czyli 40%/60%.</p>
<p>Jako, że mamy 2 interfejsy WAN, możemy ustawić następujące polityki zachowań:</p>
<ul>
<li>Korzystamy tylko z pierwszego interfejsu WAN.</li>
<li>Korzystamy tylko z drugiego interfejsu WAN.</li>
<li>Korzystamy z obu interfejsów do równoważenia obciążenia.</li>
<li>Preferujemy korzystanie z pierwszego interfejsu WAN. Gdy ten zawiedzie, pakiety lecą przez
drugi interfejs WAN.</li>
<li>Preferujemy korzystanie z drugiego interfejsu WAN. Gdy ten zawiedzie, pakiety lecą przez
pierwszy interfejs WAN.</li>
</ul>
<p>Wszystkie te powyższe przypadki zostały ujęte w bloki <code>config policy</code> . Zdefiniowanie polityki nic
jeszcze nie oznacza. Trzeba do nich dorobić reguły, a te są określane przez zwrotki z <code>config rule</code> . Reguły można aplikować do portów źródłowych ( <code>src_port</code> ) i docelowych ( <code>dest_port</code> ),
adresów źródłowych ( <code>src_ip</code> ) i docelowych ( <code>dest_ip</code> ) oraz do protokołów ( <code>proto</code> ).
Kolejność w jakiej zostały określone reguły ma znaczenie. Dlatego też najlepiej na samym końcu
umieścić domyślną regułę, a powyżej niej te bardziej specyficzne.</p>
<p>Jeśli chcemy, aby nasz router zachowywał się jak load balancer, czyli równoważył ruch między dwóch
różnych ISP, to w pliku <code>/etc/config/mwan3</code> ustawiamy poniższą regułę:</p>
<pre><code>config rule 'default_rule'
    option dest_ip '0.0.0.0/0'
    option use_policy 'balanced'
</code></pre>
<p>W opcji <code>use_policy</code> podajemy jedną z nazw określonych w blokach <code>config policy</code> . Jeśli do tego
chcemy, by ruch z/do jednego hosta z naszej sieci zawsze szedł przez interfejs <code>wwan0</code> , to dodajemy
poniższy blok:</p>
<pre><code>config rule 'host_wan2'
    option src_ip '192.168.1.150'
    option use_policy 'lte_wan'
</code></pre>
<p>W ten sposób możemy decydować o tym gdzie przesłać określony ruch przechodzący przez router, np. gdy
chcemy posłać protokół <code>https</code> i <code>http</code> przez jednego ISP, a resztę, np. torrenty, przez drugiego. W
każdej regule może być określony jeden protokół, jeden port źródłowy i docelowy, oraz jeden adres
źródłowy i docelowy. W przypadku portów i adresów można także określić ich zakres. Jeśli chcemy
zdefiniować wszystkie protokoły, to trzeba je opisać jako <code>all</code> .</p>
<h2 id="status-łącza">Status łącza</h2>
<p>Utworzenie reguł to jedna sprawa. Sprawdzenie czy one w ogóle działają, to osobna kwestia. Na
szczęście, <code>mwan3</code> jest nam w stanie zwrócić aktualny status łącza. W nim możemy zobaczyć czy
interfejsy są podniesione, czy też któryś z nich ma awarię:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/5.wwan3-status.png" alt=""    class="medium"></p>
<p>Mamy także rozpisaną politykę:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/6.wwan3-status.png" alt=""    class="medium"></p>
<p>Oraz reguły:</p>
<p><img loading="lazy" src="https://morfikov.github.io/img/2016/05/7.wwan3-status.png" alt=""    class="huge"></p>
<p>Z powyższych informacji wynika, że mam dwa interfejsy podzielone w proporcji 2/3. Oba interfejsy są
aktywne i działają. Ruch na port 443/tcp oraz 80/tcp jest kierowany według zdefiniowanych wyżej
reguł. Natomiast w przypadku pozostałego ruchu mamy zastosowany failover. Czyli w przypadku awarii
interfejsu <code>eth0</code> , zostaniemy przełączeni na interfejs <code>wwan0</code> i ruch poleci drugim kanałem.</p></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/chaos-calmer/">chaos-calmer</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/sie%C4%87/">sieć</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/router/">router</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/failover/">failover</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/load-balancing/">load-balancing</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&amp;text=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&amp;title=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&amp;title=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&title=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&amp;title=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2ffailover-load-balancing-openwrt-mwan3%2f&description=Failover%20i%20load%20balancing%20w%20OpenWRT%20%28mwan3%29" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/wake-lan-z-etherwake-pod-openwrt/">Wake On LAN z etherwake pod OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/nat-reflection-oraz-nat-loopback-w-openwrt/">NAT Reflection oraz NAT Loopback w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/siec-bezprzewodowa-wifi-w-openwrt-wlan/">Sieć bezprzewodowa WiFi w OpenWRT (WLAN)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-interfejsow-sieciowych-w-openwrt/">Konfiguracja interfejsów sieciowych w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/jak-sklonowac-adres-mac-w-openwrt/">Jak sklonować adres MAC w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-polaczenia-aero2-na-openwrt/">Konfiguracja połączenia Aero2 na OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/modem-lte-pod-openwrt/">Modem LTE pod OpenWRT (Huawei E3372s-153)</a></li>
		
	</ul>
</div>

	<div id="comments">
		<script>
  var id =  471 ;

  if (id)
  {
    let url = "https://github.com/morfikov/morfitronik-comments/issues/".concat(id);
    let api_url = "https://api.github.com/repos/morfikov/morfitronik-comments/issues/".concat(id, "/comments");

    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Komentarze dla tego postu nie zostały jeszcze otworzone (albo skrypty GitHub'a są wyłączone). Być może też skończył ci się przydział 60/godzinę (limit GitHub'a).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h3");
        mainHeader.innerHTML = "Komentarze: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>Możesz zostawić komentarz korzystając z <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);

        comments.forEach(function(comment)
        {
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Europe/Warsaw' };
			options.timeZoneName = 'short';
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " | <em>", (new Date(comment.created_at)).toLocaleTimeString('pl-PL', options), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Wystąpił jakiś błąd przy ładowaniu komentarzy.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

	</div>

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/mikhailmorfikov">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
</div>
	<div class="footer__copyright">© 2021 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		<div class="license-icons">
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Creative Commons Attribution 4.0 International license">
<i class="icon-cc"></i><i class="icon-cc-by"></i><i class="icon-cc-nc"></i><i class="icon-cc-sa"></i>
</a>
		</div>
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 40,
  textColor: '#c3c3c3'
})</script>
</body>
</html>
