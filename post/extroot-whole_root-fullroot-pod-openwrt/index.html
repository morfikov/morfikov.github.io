<!DOCTYPE html>
<html class="no-js" lang="pl-PL">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Extroot i whole_root (fullroot) pod OpenWRT | Morfitronik</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Extroot i whole_root (fullroot) pod OpenWRT" />
<meta property="og:description" content="Domowe routery WiFi zwykle nie dysponują flash&#39;em o dużej pojemności. W ogromnej części przypadków
pamięć flash w takich urządzeniach nie przekracza 16 MiB. W zasadzie jest to wystarczająca ilość
miejsca ale tylko w przypadku korzystania z oryginalnego firmware producenta routera. Gdy w grę
wchodzi OpenWRT, to przy tak niewielkiej przestrzeni jest duże prawdopodobieństwo, że przy
instalowaniu dodatkowych pakietów zwyczajnie zabraknie nam miejsca. Jeśli nasz router dysponuje
chociaż jednym portem USB, to możemy rozszerzyć system plików routera do rozmiarów partycji
pendrive, który zostanie podłączony. W ten sposób z tych 16 MiB może nam się zrobić, np. 1-2 GiB, a
to już w zupełności wystarczy na instalację dowolnych pakietów z repozytorium OpenWRT. Cały ten
zabieg nosi nazwę extroot (external root) lub
whole_root (fullroot) i w tym wpisie prześledzimy procedurę tworzenia tego mechanizmu." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morfikov.github.io/post/extroot-whole_root-fullroot-pod-openwrt/" />
<meta property="article:published_time" content="2016-04-26T16:08:13+00:00" />
<meta property="article:modified_time" content="2016-04-26T16:08:13+00:00" />

		<meta itemprop="name" content="Extroot i whole_root (fullroot) pod OpenWRT">
<meta itemprop="description" content="Domowe routery WiFi zwykle nie dysponują flash&#39;em o dużej pojemności. W ogromnej części przypadków
pamięć flash w takich urządzeniach nie przekracza 16 MiB. W zasadzie jest to wystarczająca ilość
miejsca ale tylko w przypadku korzystania z oryginalnego firmware producenta routera. Gdy w grę
wchodzi OpenWRT, to przy tak niewielkiej przestrzeni jest duże prawdopodobieństwo, że przy
instalowaniu dodatkowych pakietów zwyczajnie zabraknie nam miejsca. Jeśli nasz router dysponuje
chociaż jednym portem USB, to możemy rozszerzyć system plików routera do rozmiarów partycji
pendrive, który zostanie podłączony. W ten sposób z tych 16 MiB może nam się zrobić, np. 1-2 GiB, a
to już w zupełności wystarczy na instalację dowolnych pakietów z repozytorium OpenWRT. Cały ten
zabieg nosi nazwę extroot (external root) lub
whole_root (fullroot) i w tym wpisie prześledzimy procedurę tworzenia tego mechanizmu.">
<meta itemprop="datePublished" content="2016-04-26T16:08:13+00:00" />
<meta itemprop="dateModified" content="2016-04-26T16:08:13+00:00" />
<meta itemprop="wordCount" content="2056">



<meta itemprop="keywords" content="chaos-calmer,router," />

		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Extroot i whole_root (fullroot) pod OpenWRT"/>
<meta name="twitter:description" content="Domowe routery WiFi zwykle nie dysponują flash&#39;em o dużej pojemności. W ogromnej części przypadków
pamięć flash w takich urządzeniach nie przekracza 16 MiB. W zasadzie jest to wystarczająca ilość
miejsca ale tylko w przypadku korzystania z oryginalnego firmware producenta routera. Gdy w grę
wchodzi OpenWRT, to przy tak niewielkiej przestrzeni jest duże prawdopodobieństwo, że przy
instalowaniu dodatkowych pakietów zwyczajnie zabraknie nam miejsca. Jeśli nasz router dysponuje
chociaż jednym portem USB, to możemy rozszerzyć system plików routera do rozmiarów partycji
pendrive, który zostanie podłączony. W ten sposób z tych 16 MiB może nam się zrobić, np. 1-2 GiB, a
to już w zupełności wystarczy na instalację dowolnych pakietów z repozytorium OpenWRT. Cały ten
zabieg nosi nazwę extroot (external root) lub
whole_root (fullroot) i w tym wpisie prześledzimy procedurę tworzenia tego mechanizmu."/>

	<link rel="stylesheet" href="https://morfikov.github.io/css/bundle.css">
	<link rel="stylesheet" href="https://morfikov.github.io/css/custom.css">
	<link rel="icon" href="https://morfikov.github.io/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="https://morfikov.github.io/icons/32.png" sizes="32x32" type="image/png">
	<link rel="manifest" href="https://morfikov.github.io/manifest.json">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119125303-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
	<header class="header">
	<a class="logo" href="https://morfikov.github.io/">Morfitronik</a>
	
<nav class="main-nav main-nav--right" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/categories/">
					
					<span class="main-nav__text">Kategorie</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/tags/">
					
					<span class="main-nav__text">Tagi</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/info-kontakt/">
					
					<span class="main-nav__text">Info/Kontakt</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="https://morfikov.github.io/page/wsparcie/">
					
					<span class="main-nav__text">Wsparcie</span>
					
				</a>
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="https://morfikov.github.io/post/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Extroot i whole_root (fullroot) pod OpenWRT</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2016-04-26T16:08:13Z">Opublikowano: 26/04/2016</time>

<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Kategorie:
		<a class="meta-categories__link" href="https://morfikov.github.io/categories/openwrt" rel="category">OpenWRT</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Extroot i whole_root (fullroot) pod OpenWRT</h1>
<details class="entry__toc toc" >
	<summary class="toc__title">Spis treści</summary>
	<nav id="TableOfContents">
  <ol>
    <li><a href="#różnice-między-extroot-i-whole_root">Różnice między extroot i whole_root</a></li>
    <li><a href="#wady-i-zalety-extroot-i-whole_root">Wady i zalety extroot i whole_root</a></li>
    <li><a href="#instalacja-potrzebnych-pakietów">Instalacja potrzebnych pakietów</a></li>
    <li><a href="#przygotowanie-i-konfiguracja-partycji-pod-extroot-i-whole_root">Przygotowanie i konfiguracja partycji pod extroot i whole_root</a></li>
    <li><a href="#konfiguracja-systemu-na-extroot">Konfiguracja systemu na extroot</a></li>
    <li><a href="#konfiguracja-systemu-na-whole_root">Konfiguracja systemu na whole_root</a></li>
    <li><a href="#partycja-rootfs_data-mtdblock3-mtd3">Partycja rootfs_data (mtdblock3, mtd3)</a></li>
  </ol>
</nav>
</details>
				<div class="entry__content"><p>Domowe routery WiFi zwykle nie dysponują flash'em o dużej pojemności. W ogromnej części przypadków
pamięć flash w takich urządzeniach nie przekracza 16 MiB. W zasadzie jest to wystarczająca ilość
miejsca ale tylko w przypadku korzystania z oryginalnego firmware producenta routera. Gdy w grę
wchodzi OpenWRT, to przy tak niewielkiej przestrzeni jest duże prawdopodobieństwo, że przy
instalowaniu dodatkowych pakietów zwyczajnie zabraknie nam miejsca. Jeśli nasz router dysponuje
chociaż jednym portem USB, to możemy rozszerzyć system plików routera do rozmiarów partycji
pendrive, który zostanie podłączony. W ten sposób z tych 16 MiB może nam się zrobić, np. 1-2 GiB, a
to już w zupełności wystarczy na instalację dowolnych pakietów z repozytorium OpenWRT. Cały ten
zabieg nosi nazwę <code>extroot</code> (<a href="https://wiki.openwrt.org/doc/howto/extroot">external root</a>) lub
<code>whole_root</code> (fullroot) i w tym wpisie prześledzimy procedurę tworzenia tego mechanizmu.</p>
<h2 id="różnice-między-extroot-i-whole_root">Różnice między extroot i whole_root</h2>
<p>Gdy chodzi o rozbudowanie systemu plików routera, to mamy do wyboru dwie opcje. Możemy to zrobić w
oparciu o <code>extroot</code> lub <code>whole_root</code> . Różnica między tymi dwoma mechanizmami polega na tym, że
<code>extroot</code> pozwala na przeniesienie części systemu routera (tj. zmian) na zewnętrzny nośnik. W
przypadku zaś <code>whole_root</code> jest przenoszony cały system routera. Dokładny <a href="https://wiki.openwrt.org/doc/howto/extroot/extroot.theory">opis działania tych
mechanizmów można znaleźć tutaj</a>. W obu
tych powyższych przypadkach partycja na pendrive musi być sformatowana w systemie plików z rodziny
EXT, zwykle EXT4. Jest to domyślny system plików stosowany na linux'ach.</p>
<h2 id="wady-i-zalety-extroot-i-whole_root">Wady i zalety extroot i whole_root</h2>
<p>Wydawać by się mogło, że zarówno <code>extroot</code> jak i <code>whole_root</code> to bardzo przyzwoite mechanizmy, który
w znacznym stopniu przyczyną się do rozbudowy naszego routera, praktycznie za free. Trzeba mieć
jednak na uwadze jedną rzecz. Jeśli zamontujemy na routerze taką partycję, to nie możemy wyłączać
routera przez przycisk na jego obudowie. A już na pewno odpada nam możliwość wyciągnięcia wtyczki z
kontaktu. Tego typu akcje mogą uszkodzić system plików na pendrive, co może wiązać się z utratą
części lub wszystkich plików zgromadzonych na partycji. Router niczym się praktycznie nie różni w
działaniu od zwykłego PC. Jest tylko nieco mniejszy i nie ma tych wszystkich podzespołów, które mają
standardowe komputery. Dlatego też trzeba postępować z nim podobnie jak z ze zwykłym komputerem, a
tych przecie nie wyłączamy via przycisk na zasilaczu, prawda? By wyłączyć router, który korzysta z
<code>extroot</code> lub <code>whole_root</code> , musimy się zalogować się na niego przez SSH i położyć system przy
pomocy polecenia:</p>
<pre><code># sync &amp;&amp; poweroff
</code></pre>
<p>Po wydaniu tego powyższego polecenia, router pozornie będzie wyglądał na powieszony. Niby stracimy z
nim łączność ale lampki będą dalej się świecić czy migać. W tym stanie, router może zostać
pozbawiony zasiania bez stwarzania zagrożenia dla systemu plików na pendrive.</p>
<p><code>extroot</code> oraz <code>whole_root</code> mają tę zaletę, że jeśli coś pochrzanimy w konfiguracji, to możemy
wyciągnąć pendrive z portu USB i załadować funkcjonalny system z flash'a routera. Wszystkie zmiany,
które przeprowadziliśmy mając podpięty pendrive zostaną cofnięte. Dodatkowo, jeśli dysponujemy jakąś
dystrybucją linux'a, lub też posiadamy system live, to partycję pendrive można zamontować w takim
systemie w celu przebadania zaistniałych problemów. W ten sposób będziemy w stanie edytować
poszczególne pliki. Coś jak <a href="https://morfikov.github.io
/post/tryb-ratunkowy-failsafe-w-openwrt/">tryb
failsafe</a>, z tym, że podczas tej
operacji, nasz router działa i jest w pełni funkcjonalny. Zatem, jeśli przeprowadzamy jakieś
eksperymenty z nowym oprogramowaniem, dobrze jest pierw to robić na <code>extroot</code>/<code>whole_root</code> . Jeśli
wszystko będzie w porządku, możemy tę funkcjonalność zaimplementować na flash'u routera.</p>
<p>Pamiętajmy też, że po aktywowaniu mechanizmu <code>extroot</code> będziemy mieć kompletnie świeży system po
zresetowaniu routera. Wygląda to tak jakbyśmy go dopiero co flash'owali nową wersją firmware
OpenWRT. Całą konfigurację trzeba będzie ustawiać od początku.</p>
<p>Kolejna ważna sprawa, to upgrade firmware. W przypadku, gdy mamy zamiar dokonać aktualizacji
oprogramowania routera, musimy odłączyć pendrive i uruchomić system z flash'a routera. Dopiero wtedy
możemy wgrać obraz z nowym firmware.</p>
<p>Ostatnia rzecz, to UUID partycji z <code>extroot</code> lub <code>whole_root</code> . Narzędzie <code>block-mount</code> tworzy plik
<code>/etc/.extroot-uuid</code> na partycji pendrive. W nim umieszcza UUID partycji <code>mtd</code> zawierającej rootfs.
Jest to jedna z partycji routera. W fazie boot, podczas aktywacji <code>extroot</code>/<code>whole_root</code> ,
<code>block-mount</code> próbuje sprawdzić aktualną wartość UUID partycji <code>mtd</code> i porównuje ją z tą zapisaną w
pliku <code>/etc/.extroot-uuid</code> . Jeśli te dwie wartośći się różnią, partycja pendrive nie zostanie
zamontowana. Jeśli natomiast chcielibyśmy korzystać tej partycji po flash'owaniu routera, to musimy
ten plik pierw skasować.</p>
<h2 id="instalacja-potrzebnych-pakietów">Instalacja potrzebnych pakietów</h2>
<p>By zaimplementować <code>extroot</code>/<code>whole_root</code> , musimy doinstalować kilka pakietów na routerze. Poniżej
znajduje się pełna lista potrzebnych nam rzeczy:</p>
<pre><code># opkg update
# opkg install block-mount \
kmod-fs-ext4 \
kmod-crypto-crc32c \
kmod-usb-storage \
kmod-usb-core
</code></pre>
<p>Pakiet <code>kmod-crypto-crc32c</code> jest wymagany w przypadku wystąpienia błędu <code>EXT4-fs (sda4): Cannot load crc32c driver.</code> podczas montowania zasobu (w <code>logread</code>) .</p>
<h2 id="przygotowanie-i-konfiguracja-partycji-pod-extroot-i-whole_root">Przygotowanie i konfiguracja partycji pod extroot i whole_root</h2>
<p>Kluczem w tej całej zabawie z rozszerzaniem systemu plików routera jest utworzenie odpowiedniej
partycji. Tę zaś możemy przygotować bez większego problemu z płytki live mającą na pokładzie jakąś
dystrybucję linux'a. Możemy także doinstalować <code>fdisk</code> w OpenWRT i przeprowadzić proces tworzenia
partycji na routerze. W tym wpisie ograniczymy się jedynie do utworzenia partycji via <code>gparted</code> z
systemu live. Pendrive może zostać podzielony w dowolny sposób, np. tak jak to widać na poniższej
fotce:</p>
<p><img src="https://morfikov.github.io
/img/2016/04/1.gparted-linux-live-partycja-extroot-whole_root.png#huge" alt=""></p>
<p>Mając przygotowaną partycję, wsadzamy pendrive do jednego z portów USB w routerze. Urządzenie
powinno zostać wykryte przez system i stosownie oznaczone:</p>
<pre><code>kernel: [ 3020.600000] usb 1-1.2: new high-speed USB device number 3 using ehci-platform
kernel: [ 3020.750000] usb-storage 1-1.2:1.0: USB Mass Storage device detected
kernel: [ 3020.770000] scsi host0: usb-storage 1-1.2:1.0
kernel: [ 3021.830000] scsi 0:0:0:0: Direct-Access     Kingston DataTraveler 3.0 PMAP PQ: 0 ANSI: 6
kernel: [ 3022.400000] sd 0:0:0:0: [sda] 15360000 512-byte logical blocks: (7.86 GB/7.32 GiB)
kernel: [ 3022.410000] sd 0:0:0:0: [sda] Write Protect is off
kernel: [ 3022.410000] sd 0:0:0:0: [sda] Mode Sense: 23 00 00 00
kernel: [ 3022.410000] sd 0:0:0:0: [sda] No Caching mode page found
kernel: [ 3022.420000] sd 0:0:0:0: [sda] Assuming drive cache: write through
kernel: [ 3022.470000]  sda: sda1 sda2 sda3 sda4
kernel: [ 3022.490000] sd 0:0:0:0: [sda] Attached SCSI removable disk
</code></pre>
<p>Partycja, którą będziemy w tym przypadku wykorzystywać, to <code>sda4</code> . Przy pomocy <code>block detect</code>
generujemy odpowiednią konfigurację, którą trzeba umieścić w pliku <code>/etc/config/fstab</code> :</p>
<pre><code># block detect &gt; /etc/config/fstab
</code></pre>
<p>Następnie edytujemy plik <code>/etc/config/fstab</code> . Wszystkie partycje, które zostały rozpoznane przez
OpenWRT, zostaną automatycznie uwzględnione w tym pliku i umieszczone w sekcjach <code>config 'mount'</code> .
Poza tymi sekcjami, mamy także ustawienia globalne, które są w sekcji <code>config 'global'</code> . Na
początek omówmy sobie sekcję z ustawieniami globalnymi. Standardowo ta sekcja wygląda mniej więcej
tak:</p>
<pre><code>config 'global'
      option  anon_swap       '0'
      option  anon_mount      '0'
      option  auto_swap       '1'
      option  auto_mount      '1'
      option  delay_root      '5'
      option  check_fs        '0'
</code></pre>
<p>Opcje <code>anon_swap</code> oraz <code>anon_mount</code> odpowiadają za montowanie zasobów, które nie posiadają
konfiguracji w pliku <code>/etc/config/fstab</code> . Nas one nie dotyczą, a poza tym, lepiej nie ruszać ich
wartości domyślnych. Następnie mamy opcje <code>auto_swap</code> oraz <code>auto_mount</code> , które montują zasoby
określone w pliku <code>/etc/config/fstab</code> i mające status <code>enabled</code> (o tym za moment). Jeśli chodzi zaś
o opcję <code>delay_root</code> , to ma ona kluczowe znaczenie w przypadku <code>extroot</code>/<code>whole_root</code> . Może się
tak zdarzyć, że nasz pendrive zostanie wykryty z pewnym opóźnieniem podczas startu systemu routera.
W takim przypadku partycja nie zostanie zamontowana. Wartość tego parametru jest w sekundach i
oznacza ile czasu system ma czekać zanim zamontuje partycję z <code>extroot</code>/<code>fullroot</code>. Ostatnia opcja,
tj. <code>check_fs</code> , odpowiada za sprawdzanie systemu plików aktywnych zasobów.</p>
<p>Dalej w pliku mamy sekcje <code>config 'mount'</code> . Ta odpowiedzialna za <code>extroot</code>/<code>fullroot</code> jest
przedstawiona poniżej:</p>
<pre><code>config 'mount'
      option  target  '/overlay'
#     option  target  '/'
#     option  device  '/dev/sda4'
      option  uuid    'a2fc6334-0021-4468-8c21-48b2d2728ca2'
      option  fstype  'ext4'
      option  enabled '1'
</code></pre>
<p>Opcja <code>target</code> określa gdzie zamontować daną partycję. W przypadku <code>extroot</code> korzystamy z
<code>/overlay</code> . Natomiast jeśli chodzi o <code>whole_root</code> , to dajemy tutaj <code>/</code> . W obu przypadkach
wszelkie zmiany jakich dokonujemy w systemie, będą zapisywane partycji określonej w <code>device</code>.
Niemniej jednak, w przypadku podpięcia innego pendrive, OpenWRT będzie próbował zamontować jedną z
jego partycji. Dlatego też, lepiej unikać definiowania zasobów w taki sposób. Zamiast tego, lepiej
jest wykorzystać opcję <code>uuid</code> , która identyfikuje konkretne urządzenie (partycję) podpięte do
portu USB routera. Następnie mamy opcję <code>fstype</code> , która określa system plików partycji. Opcja
<code>enabled</code> ustawiona na <code>1</code> sprawi, że zasób zostanie zamontowany w fazie boot routera.</p>
<p>Jeśli nie chce nam się od początku konfigurować routera, możemy zgrać całą konfigurację. W przypadku
<code>extroot</code> ten krok jest opcjonalny. Natomiast jeśli chodzi o <code>whole_root</code> , to jest to wymagana
procedura.</p>
<p>Przy przenoszeniu konfiguracji należy pamiętać, aby w pliku <code>/etc/config/fstab</code> przy sekcjach
<code>config 'mount'</code> z <code>extroot</code>/<code>whole_root</code> przestawić poniższy parametr:</p>
<pre><code>option  enabled '0'
</code></pre>
<p>Jeśli zapomnimy to zrobić, wtedy router się zapętli. Tę opcję zawsze można przestawić po skopiowaniu
plików na partycję pendrive. Wystarczy skorzystać z polecenia <code>mount</code> .</p>
<p>Przenoszenie konfiguracji w przypadku <code>extroot</code> :</p>
<pre><code># mount /dev/sda4 /mnt/
# tar -C /overlay -cvf - . | tar -C /mnt/ -xf -
# umount /mnt/
</code></pre>
<p>Przenoszenie konfiguracji w przypadku <code>whole_root</code> :</p>
<pre><code># mount /dev/sda4 /mnt/
# mkdir -p /tmp/cproot/
# mount --bind / /tmp/cproot/
# tar -C /tmp/cproot -cvf - . | tar -C /mnt/ -xf -
# umount /tmp/cproot/
# umount /mnt/
</code></pre>
<h2 id="konfiguracja-systemu-na-extroot">Konfiguracja systemu na extroot</h2>
<p>Po uruchomieniu routera, logujemy się na urządzenie standardowo za pomocą protokołu telnet. No
chyba, że skopiowaliśmy sobie konfigurację. Tak czy inaczej, naszym oczom powinien się pokazać taki
oto obrazek:</p>
<p><img src="https://morfikov.github.io
/img/2016/04/2.openwrt-extroot-whole_root.png#big" alt=""></p>
<p>Jak widzimy, ilość wolnego miejsca na flash'u to 1,7 GiB.</p>
<p>Niżej zaś jest trochę informacji na temat systemu plików po aktywacji <code>extroot</code> , zwrócone przez
<code>df</code> oraz <code>mount</code> :</p>
<pre><code># df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    1.8G      5.6M      1.7G   0% /
/dev/root                 2.5M      2.5M         0 100% /rom
tmpfs                    61.5M     72.0K     61.5M   0% /tmp
/dev/sda4                 1.8G      5.6M      1.7G   0% /overlay
overlayfs:/overlay        1.8G      5.6M      1.7G   0% /
tmpfs                   512.0K         0    512.0K   0% /dev

/# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,noatime)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime)
/dev/sda4 on /overlay type ext4 (rw,relatime,data=ordered)
overlayfs:/overlay on / type overlay (rw,noatime,lowerdir=/,upperdir=/overlay/upper,workdir=/overlay/work)
tmpfs on /dev type tmpfs (rw,nosuid,relatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,mode=600)
debugfs on /sys/kernel/debug type debugfs (rw,noatime
</code></pre>
<h2 id="konfiguracja-systemu-na-whole_root">Konfiguracja systemu na whole_root</h2>
<p>W przypadku <code>whole_root</code> , informacje zwracane przez <code>df</code> i <code>mount</code> prezentują się następująco:</p>
<pre><code># df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    1.8G     14.0M      1.6G   1% /
/dev/root                 2.5M      2.5M         0 100% /rom
tmpfs                    61.5M     68.0K     61.5M   0% /tmp
/dev/sda4                 1.8G     14.0M      1.6G   1% /
tmpfs                   512.0K         0    512.0K   0% /dev

# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro,noatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,noatime)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime)
/dev/sda4 on / type ext4 (rw,relatime,data=ordered)
tmpfs on /dev type tmpfs (rw,nosuid,relatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,mode=600)
debugfs on /sys/kernel/debug type debugfs (rw,noatime)
</code></pre>
<p>To co odróżnia <code>whole_root</code> od <code>extroot</code> , to fakt, że w tym pierwszym nie mamy wpisu
<code>overlayfs:/overlay</code> .</p>
<h2 id="partycja-rootfs_data-mtdblock3-mtd3">Partycja rootfs_data (mtdblock3, mtd3)</h2>
<p>Czasem przy korzystaniu z <code>extroot</code>/<code>whole_root</code> może zajść potrzeba, by podejrzeć pewne pliki
systemowe, które utworzyliśmy czy zmieniliśmy zanim przeszliśmy na któryś z tych powyższych
mechanizmów. Część użytkowników w takiej sytuacji resetuje router i odpala go bez podpiętego
pendrive. Jednak nie ma takiej potrzeby, bo partycję <code>rootfs_data</code> (tę zawierającą zmiany w obrazie
firmware) można bez problemu zamontować sobie z poziomu <code>extroot</code>/<code>whole_root</code> . Musimy tylko
sprawdzić, która to jest partycja. Zwykle jest to <code>mtd3</code> ale lepiej jest się upewnić zaglądając do
pliku <code>/proc/mtd</code> . W przypadku routera TP-LINK TL-WDR3600 v1 ten plik prezentuje się następująco:</p>
<pre><code># cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00020000 00010000 &quot;u-boot&quot;
mtd1: 00121a00 00010000 &quot;kernel&quot;
mtd2: 006ae600 00010000 &quot;rootfs&quot;
mtd3: 00440000 00010000 &quot;rootfs_data&quot;
mtd4: 00010000 00010000 &quot;art&quot;
mtd5: 007d0000 00010000 &quot;firmware&quot;
</code></pre>
<p>Widzimy tutaj wyraźnie, że <code>rootfs_data</code> ma przypisane urządzenie <code>mtd3</code> i w katalogu <code>/dev/</code>
również mamy taki plik. Niemniej jednak, jest to urządzenie znakowe i nie możemy z niego
skorzystać. Zamiast tego musimy posłużyć się emulacją urządzenia blokowego <code>/dev/mtdblock3</code> .
Dokładna <a href="http://www.linux-mtd.infradead.org/faq/general.html">różnica między urządzeniami mtd i mtdblock jest wyjaśniona
tutaj</a>. Najważniejsza rzecz, to unikać zapisu
tego urządzenia. Wszelkie próby kontaktu z <code>/dev/mtdblock3</code> powinny być tylko w trybie do odczytu.
Niemniej jednak, jest możliwe operowanie na tym urządzenie jak na zwykłej partycji, a przez to
możemy ją zamontować w poniższy sposób:</p>
<pre><code># mount -t jffs2 -o ro /dev/mtdblock3 /overlay-boot/
</code></pre>
<p>Możemy także wykorzystać do tego celu <code>block-mount</code> . Choć trzeba pamiętać, że partycje montowane za
jego pomocą będą w trybie do zapisu. Tak czy inaczej jeśli chcemy by partycja <code>/dev/mtdblock3</code> była
montowana na starcie routera, to do pliku <code>/etc/config/fstab</code> dodajemy tę poniższą treść:</p>
<pre><code>config 'mount'
      option target '/overlay-boot'
      option device '/dev/mtdblock3'
      option fstype 'jffs2'
      option enabled '1'
</code></pre></div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/chaos-calmer/">chaos-calmer</a>
			<a class="entry__tag btn" href="https://morfikov.github.io/tags/router/">router</a>
</div>
					
<div class="entry__share share">
	<a class="share__link btn" title="Podziel się na Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Facebook', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Facebook" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M330 512V322h64l9-74h-73v-47c0-22 6-36 37-36h39V99c-7-1-30-3-57-3-57 0-95 34-95 98v54h-64v74h64v190z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&amp;text=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Reddit" href="https://www.reddit.com/submit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&amp;title=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Reddit', 'width=832,height=624,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Reddit" role="img" width="32" height="32" viewBox="0 0 512 512"><path fill-rule="evenodd" d="M375 146a32 32 0 1 0-29-46l-65-13c-5-1-9 2-10 6l-22 97c-45 1-85 15-113 36a42 42 0 1 0-45 69l-1 12c0 65 74 117 166 117s166-52 166-117l-1-11a42 42 0 1 0-44-69c-28-21-67-35-111-37l19-86 58 13a32 32 0 0 0 32 29zM190 353c2-1 4 0 5 1 15 11 38 18 61 18s46-6 61-18a7 7 0 0 1 8 10c-18 14-44 21-69 21-25-1-51-7-69-21a6 6 0 0 1 3-11zm23-44a31 31 0 1 1-44-44 31 31 0 0 1 44 44zm130 0a31 31 0 1 0-44-44 31 31 0 0 0 44 44z"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na Telegram" href="https://t.me/share/url?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&amp;title=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na Telegram', 'width=800,height=600,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&title=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na LinkedIn', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="LinkedIn" role="img" width="32" height="32" viewBox="0 0 512 512"><circle cx="142" cy="138" r="37"/><path stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
	</a>
	<a class="share__link btn" title="Podziel się na VK" href="https://vk.com/share.php?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Podziel się na VK', 'width=640,height=480,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="VK" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M274 363c5-1 14-3 14-15 0 0-1-30 13-34s32 29 51 42c14 9 25 8 25 8l51-1s26-2 14-23c-1-2-9-15-39-42-31-30-26-25 11-76 23-31 33-50 30-57-4-7-20-6-20-6h-57c-6 0-9 1-12 6 0 0-9 25-21 45-25 43-35 45-40 42-9-5-7-24-7-37 0-45 7-61-13-65-13-2-59-4-73 3-7 4-11 11-8 12 3 0 12 1 17 7 8 13 9 75-2 81-15 11-53-62-62-86-2-6-5-7-12-9H79c-6 0-15 1-11 13 27 56 83 193 184 192z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pocket" href="https://getpocket.com/edit?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&amp;title=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=480,height=320,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pocket" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M388.8 88.9H123.2A47.4 47.4 0 0 0 76 136.5v131.9c0 2.4.2 4.8.5 7.2a101.8 101.8 0 0 0-.5 10.6c0 75.6 80.6 137 180 137s180-61.4 180-137c0-3.6-.2-7.1-.5-10.6.3-2.4.5-4.8.5-7.2v-132A47.4 47.4 0 0 0 388.8 89zm-22.4 132.6l-93 93c-4.7 4.6-11 7-17.1 7a23.8 23.8 0 0 1-17.7-7l-93-93a24 24 0 0 1 33.8-33.8l76.6 76.5 76.6-76.5a24 24 0 0 1 33.8 33.8z"/></svg>
	</a>
	<a class="share__link btn" title="Zapisz do Pinterest" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmorfikov.github.io%2fpost%2fextroot-whole_root-fullroot-pod-openwrt%2f&description=Extroot%20i%20whole_root%20%28fullroot%29%20pod%20OpenWRT" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Zapisz do Pocket', 'width=800,height=720,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Pinterest" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
<div class="authorbox block">
	<div class="author">
		<figure class="author__avatar">
			<img class="author__img" alt="Mikhail Morfikov avatar" src="https://morfikov.github.io/img/avatar.png" height="90" width="90">
		</figure>
		<div class="author__body">
			<div class="author__name">
				Mikhail Morfikov
			</div>
			<div class="author__bio">Po ponad 10 latach spędzonych z różnej maści linux&#39;ami (Debian/Ubuntu, OpenWRT, Android) mogę śmiało powiedzieć, że nie ma rzeczy niemożliwych i problemów, których nie da się rozwiązać. Jedną umiejętność, którą ludzki umysł musi posiąść, by wybrnąć nawet z tej najbardziej nieprzyjemniej sytuacji, to zdolność logicznego rozumowania.</div>
		</div>
	</div>
</div>
	



<div class="related block">
	<h3 class="related__title">Powiązane</h3>
	<ul class="related__list">
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/konfiguracja-dnscrypt-proxy-w-openwrt/">Konfiguracja dnscrypt-proxy w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/opkg-czyli-menadzer-pakietow-w-openwrt/">OPKG, czyli menadżer pakietów w OpenWRT</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/klucze-szyfrujace-rsa-w-openwrt-ssh/">Klucze szyfrujące RSA w OpenWRT (ssh)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/dostep-routera-openwrt-telnet-ssh-sshfs/">Dostęp do routera OpenWRT (telnet, ssh, sshfs)</a></li>
		
		<li class="related__item"><a class="related__link" href="https://morfikov.github.io/post/tryb-ratunkowy-failsafe-w-openwrt/">Tryb ratunkowy (failsafe) w OpenWRT</a></li>
		
	</ul>
</div>

	
<section class="comments block">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "morfitronik" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:morfitronik@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/mikhailmorfikov">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://t.me/morfikov">
			<svg class="social__icon" aria-label="Telegram" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/morfikov">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/morfikov">
			<svg class="social__icon" aria-label="Gitlab" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M450 282l-22-67-43-133c-2-7-12-7-14 0l-43.3 133H184.3L141 82c-2-7-12-7-14 0L84 215l-22 67c-2 6 0 13 6 16l188 137 188-137c6-3 8-10 6-16z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/users/3015317">
			<svg class="social__icon" aria-label="Stack Overflow" role="img" width="32" height="32" viewBox="0 0 512 512"><g stroke-width="30"><path fill="none" d="M125 297v105h241V297"/><path d="M170 341h150m-144-68l148 31M199 204l136 64m-95-129l115 97M293 89l90 120"/></g></svg>
		</a>
</div>
	<div class="footer__copyright">© 2020 Mikhail Morfikov.
	<span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span>
	<span class="footer__copyright-cc">
		Except where otherwise noted, content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International license</a>.
		<img alt="Licencja Creative Commons" style="border-width:0" src="https://licensebuttons.net/l/by-nc-sa/4.0/80x15.png" />
	</span>
	</div>
</footer>

<script src="https://morfikov.github.io/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="https://morfikov.github.io/js/custom.js"></script>
</body>
</html>